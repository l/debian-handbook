<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">10.2. 虛擬專用網路</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-9-zh-TW-1.0-1" /><meta
        name="keywords"
        content="網路, 閘道器, TCP/IP, IPv6, DNS, Bind, DHCP, QoS" /><link
        rel="home"
        href="index.html"
        title="The Debian Administrator's Handbook" /><link
        rel="up"
        href="network-infrastructure.html"
        title="章 10. 網路架構" /><link
        rel="prev"
        href="network-infrastructure.html"
        title="章 10. 網路架構" /><link
        rel="next"
        href="sect.quality-of-service.html"
        title="10.3. 品質服務" /><meta
        name="viewport"
        content="width=device-width, initial-scale=1" /><meta
        name="flattr:id"
        content="4pz9jq" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/zh-TW/sect.virtual-private-network.html" /></head><body><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="../../"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="network-infrastructure.html"><strong>前一頁</strong></a></li><li
          class="home">The Debian Administrator's Handbook</li><li
          class="next"><a
            accesskey="n"
            href="sect.quality-of-service.html"><strong>下一頁</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  id="sect.virtual-private-network"></a>10.2. 虛擬專用網路</h2></div></div></div><div
          class="para">
			<span
            class="emphasis"><em>虛擬專用網路</em></span> (VPN) 是以通道方式，經由網際網路連結兩個區域網路的方式；通常以加密方式在通道內傳送資訊。VPN 通常用於整合公司內部遠端機器。
		</div><a
          id="id-1.13.5.3"
          class="indexterm"></a><a
          id="id-1.13.5.4"
          class="indexterm"></a><a
          id="id-1.13.5.5"
          class="indexterm"></a><div
          class="para">
			好幾個工具提供這種服務。OpenVPN 是個有效率解決方案，基於 SSL/TLS，容易佈署與維護。以 IPsec 加密兩部機器的 IP 流量；這是透明的編碼，在該等主機執行應用程式時不需修改 VPN。SSH 在傳統的功能外，也能提供 VPN。最後，可以用微軟的 PPTP 協定建立 VPN。其他的解決方案，就留給讀者自行探索。
		</div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.openvpn"></a>10.2.1. OpenVPN</h3></div></div></div><a
            id="id-1.13.5.7.2"
            class="indexterm"></a><div
            class="para">
				OpenVPN 用於建立虛擬專用網路的一個軟體。在 VPN 伺服器及客戶端建立虛擬專用網路；支援 <code
              class="literal">tun</code> (IP 層面的通道) 和 <code
              class="literal">tap</code> (Ethernet 層面的通道) 介面。實務上，常用的是 <code
              class="literal">tun</code> 介面，除非 VPN 客戶端難以經由 Ethernet 橋接器整合入伺服器的區域網路。
			</div><div
            class="para">
				OpenVPN 所有的 SSL/TLS 加密與其他功能 (機密性、認證、完整性、不可否認性)，均有賴於 OpenSSL。可以用公鑰基礎設施的共享私鑰或使用 X.509 認證的方式組態它。建議使用後者的方式組態，以漫遊方式近用 VPN 的使用者可享有更多的彈性。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>文化</em></span> SSL 和 TLS</strong></p></div></div></div><a
              id="id-1.13.5.7.5.2"
              class="indexterm"></a><a
              id="id-1.13.5.7.5.3"
              class="indexterm"></a><div
              class="para">
				Netscape 研發的 SSL 協定 (<span
                class="emphasis"><em>Secure Socket Layer</em></span>) 為安全連線至網站伺服器的工具。後來被 IETF 標準化為 TLS (<span
                class="emphasis"><em>Transport Layer Security</em></span>)。後來，在 SSL 裡發現多個設計的缺失，棄置後，改使用 TLS。
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="sect.easy-rsa"></a>10.2.1.1. 公鑰基礎設施：<span
                      class="emphasis"><em>easy-rsa</em></span></h4></div></div></div><a
              id="id-1.13.5.7.6.2"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.3"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.4"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.5"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.6"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.7"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.8"
              class="indexterm"></a><div
              class="para">
					RSA 演算法是使用廣泛的公鑰加密法。以 “密鑰配對” 法比對私鑰與公鑰。兩鑰密切連在一起，以公鑰演算加密的訊息，祗能被知道私鑰的人解開，以保障其安全。反之亦然，以私鑰加密的訊息，祗能被公鑰解開，也就是讓擁有私鑰的人，可以向指定的社群發出訊息。以數位雜湊 (MD5、SHA1、或其他) 方式演算，適用於任何簽名機制的訊息。
				</div><div
              class="para">
					任何人都可以新增密鑰配對。採用 <span
                class="emphasis"><em>授權認證</em></span> (CA)，即 X.509 標準。此術語指的是擁有信任密鑰配對做為 <span
                class="emphasis"><em>root 認證</em></span>。此認證祗用於簽署另個認證 (密鑰配對)，經過適當的程序，檢查儲存在密鑰配對的內容。使用 X.509 可以檢查其中的認證。
				</div><div
              class="para">
					OpenVPN 遵守此法則。因為公共 CA 放出的認證係用於交換 (巨大) 的費用，可以在公司內部生成專用的認證機制。<span
                class="pkg pkg">easy-rsa</span> 套件可做為 X.509 認證基礎建設，應用於 <code
                class="command">openssl</code> 命令的腳本內。
				</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>說明</em></span> <span
                          class="emphasis"><em>easy-rsa</em></span> 早於 <span
                          class="distribution distribution">Jessie</span> 之前</strong></p></div></div></div><div
                class="para">
					在 Debian <span
                  class="distribution distribution">Wheezy</span> 之前的版本，<span
                  class="emphasis"><em>easy-rsa</em></span> 做為 <span
                  class="pkg pkg">openvpn</span> 套件的一部份，其腳本在 <code
                  class="filename">/usr/share/doc/openvpn/examples/easy-rsa/2.0/</code> 之內。複製該資料夾就能設定成 CA，不必使用 <code
                  class="command">make-cadir</code> 命令。
				</div></div><div
              class="para">
					Falcot 公司的管理者以此工具新增必要的伺服器與客戶端認證。可以把所有的客戶端組態成類似的狀態，因為他們祗需信件 Falcot 在地 CA 的認證。此 CA 是率先認證的；為此工作，管理者在適當的地方建立新的資料夾，供 CA 的檔案使用，最好放在離線的地方，杜絕私鑰被竊的危險。
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>make-cadir pki-falcot
</code></strong><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>cd pki-falcot</code></strong></pre><div
              class="para">
					把必要的參數儲存在 <code
                class="filename">vars</code> 檔案內，特別是以 <code
                class="literal">KEY_</code> 開頭的部份；這些變數整合入環境：
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>vim vars
</code></strong><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>grep KEY_ vars
</code></strong><code
                class="computeroutput">export KEY_CONFIG=`$EASY_RSA/whichopensslcnf $EASY_RSA`
export KEY_DIR="$EASY_RSA/keys"
echo NOTE: If you run ./clean-all, I will be doing a rm -rf on $KEY_DIR
export KEY_SIZE=2048
export KEY_EXPIRE=3650
export KEY_COUNTRY="FR"
export KEY_PROVINCE="Loire"
export KEY_CITY="Saint-Étienne"
export KEY_ORG="Falcot Corp"
export KEY_EMAIL="admin@falcot.com"
export KEY_OU="Certificate authority"
export KEY_NAME="Certificate authority for Falcot Corp"
# If you'd like to sign all keys with the same Common Name, uncomment the KEY_CN export below
# export KEY_CN="CommonName"
$ </code><strong
                class="userinput"><code>. ./vars
</code></strong><code
                class="computeroutput">NOTE: If you run ./clean-all, I will be doing a rm -rf on /home/roland/pki-falcot/keys
$ </code><strong
                class="userinput"><code>./clean-all
</code></strong></pre><div
              class="para">
					接著新增 CA 密鑰配對本身 (在此階段把兩組鑰匙儲存在 <code
                class="filename">keys/ca.crt</code> 和 <code
                class="filename">keys/ca.key</code>)：
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-ca</code></strong>
<code
                class="computeroutput">Generating a 2048 bit RSA private key
...................................................................+++
...+++
writing new private key to 'ca.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:
Common Name (eg, your name or your server's hostname) [Falcot Corp CA]:
Name [Certificate authority for Falcot Corp]:
Email Address [admin@falcot.com]:
</code></pre><div
              class="para">
					現在 VPN 伺服器的認證完成，Diffie-Hellman 參數供伺服器的 SSL/TLS 連結亦完成。VPN 伺服器以其 DNS 名稱 <code
                class="literal">vpn.falcot.com</code> 識別；此名稱再次使用於新增鑰匙檔案 (<code
                class="filename">keys/vpn.falcot.com.crt</code> 供公鑰，<code
                class="filename">keys/vpn.falcot.com.key</code> 供私鑰)：
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-key-server vpn.falcot.com
</code></strong><code
                class="computeroutput">Generating a 2048 bit RSA private key
.....................................................................................................................+++
...........+++
writing new private key to 'vpn.falcot.com.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:
Common Name (eg, your name or your server's hostname) [vpn.falcot.com]:
Name [Certificate authority for Falcot Corp]:
Email Address [admin@falcot.com]:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
Using configuration from /home/roland/pki-falcot/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'FR'
stateOrProvinceName   :PRINTABLE:'Loire'
localityName          :T61STRING:'Saint-\0xFFFFFFC3\0xFFFFFF89tienne'
organizationName      :PRINTABLE:'Falcot Corp'
organizationalUnitName:PRINTABLE:'Certificate authority'
commonName            :PRINTABLE:'vpn.falcot.com'
name                  :PRINTABLE:'Certificate authority for Falcot Corp'
emailAddress          :IA5STRING:'admin@falcot.com'
Certificate is to be certified until Mar  6 14:54:56 2025 GMT (3650 days)
Sign the certificate? [y/n]:</code><strong
                class="userinput"><code>y
</code></strong><code
                class="computeroutput">

1 out of 1 certificate requests certified, commit? [y/n]</code><strong
                class="userinput"><code>y
</code></strong><code
                class="computeroutput">Write out database with 1 new entries
Data Base Updated
$ </code><strong
                class="userinput"><code>./build-dh
</code></strong><code
                class="computeroutput">Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
[…]
</code></pre><div
              class="para">
					以上的步驟新增 VPN 客戶；每個使用 VPN 的電腦或使用者都需有個認證：
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-key JoeSmith
</code></strong><code
                class="computeroutput">Generating a 2048 bit RSA private key
................................+++
..............................................+++
writing new private key to 'JoeSmith.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:</code><strong
                class="userinput"><code>Development unit
</code></strong><code
                class="computeroutput">Common Name (eg, your name or your server's hostname) [JoeSmith]:</code><strong
                class="userinput"><code>Joe Smith
</code></strong><code
                class="computeroutput">[…]</code></pre><div
              class="para">
					新的認證建好後，需複製至適當的地方：超級使用者公鑰 (<code
                class="filename">keys/ca.crt</code>) 儲存在所有機器 (伺服器與客戶端) 的 <code
                class="filename">/etc/ssl/certs/Falcot_CA.crt</code>。伺服器的認證僅安裝在伺服器 (<code
                class="filename">keys/vpn.falcot.com.crt</code> 的 <code
                class="filename">/etc/ssl/vpn.falcot.com.crt</code>，以及 <code
                class="filename">keys/vpn.falcot.com.key</code> 在 <code
                class="filename">/etc/ssl/private/vpn.falcot.com.key</code> 限制其權限為管理者才能讀取)，對應至 Diffie-Hellman 參數 (<code
                class="filename">keys/dh2048.pem</code>) 安裝在 <code
                class="filename">/etc/openvpn/dh2048.pem</code>。客戶端認證則類似的方式，安裝在對應的 VPN 各戶端。
				</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="id-1.13.5.7.7"></a>10.2.1.2. 組態 OpenVPN 伺服器</h4></div></div></div><div
              class="para">
					預設，OpenVPN 初始化的腳本在 <code
                class="filename">/etc/openvpn/*.conf</code> 啟動所有虛擬專用網路。設定 VPN 伺服器就是在此資料夾儲存對應的組態檔。<code
                class="filename">/usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz</code> 是個好的起點，建立相當標準伺服器。當然，還有若干參數需要調整：<code
                class="literal">ca</code>、<code
                class="literal">cert</code>、<code
                class="literal">key</code> 和 <code
                class="literal">dh</code> 需指定其地點 (分別是 <code
                class="literal">/etc/ssl/certs/Falcot_CA.crt</code>、<code
                class="literal">/etc/ssl/vpn.falcot.com.crt</code>、<code
                class="literal">/etc/ssl/private/vpn.falcot.com.key</code> 和 <code
                class="literal">/etc/openvpn/dh2048.pem</code>)。<code
                class="literal">server 10.8.0.0 255.255.255.0</code> 設定 VPN 的次網路；此伺服器使用此範圍內的第一個 IP 位址 (<code
                class="literal">10.8.0.1</code>) 然後把其他的位址保留給客戶端。
				</div><div
              class="para">
					在這種組態下，通常以 <code
                class="literal">tun0</code> 之名，新增 OpenVPN 的虛擬網路介面。然而，有時在啟動 OpenVPN 前，把防火牆組態成真實的網路介面。最好固定新增的虛擬網路介面，OpenVPN 使用預存的介面。進一步選擇介面的名稱。到了這個階段，<code
                class="command">openvpn --mktun --dev vpn --dev-type tun</code> 新增一個虛擬網路介面名稱為 <code
                class="literal">vpn</code> 型態為 <code
                class="literal">tun</code>；這個命令可以整合入防火牆組態腳本，或 <code
                class="literal">up</code> 指向 <code
                class="filename">/etc/network/interfaces</code> 檔案。OpenVPN 組態檔必須跟著更新，直接使用 <code
                class="literal">dev vpn</code> 和 <code
                class="literal">dev-type tun</code>。
				</div><div
              class="para">
					禁止進一步的行動，VPN 客戶端祗能經由 <code
                class="literal">10.8.0.1</code> 位址近用 VPN 伺服器。為了授權客戶近用在地網路 (192.168.0.0/24)，需在 OpenVPN 組態中加入 <code
                class="literal">推送路徑 192.168.0.0 255.255.255.0</code>，讓 VPN 客戶端自動取得網路路由，使其明瞭經由 VPN 可以進入該網路。此外，在地網路的機器也需被告知，經由 VPN 伺服器 (在閘道安裝 VPN 伺服器即自動啟用) 進入VPN。另外，VPN 伺服器可以組態後執行偽裝 IP 的工作，讓來自 VPN 客戶端的訊息顯示成來自 VPN 伺服器 (見 <a
                class="xref"
                href="network-infrastructure.html#sect.gateway">節 10.1, “閘道器”</a>)。
				</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="id-1.13.5.7.8"></a>10.2.1.3. 組態 OpenVPN 客戶端</h4></div></div></div><div
              class="para">
					需組態 <code
                class="filename">/etc/openvpn/</code> 內的檔案才能設定 OpenVPN 客戶端。標準的組態方法可從使用 <code
                class="filename">/usr/share/doc/openvpn/examples/sample-config-files/client.conf</code> 這個檔案開始。<code
                class="literal">remote vpn.falcot.com 1194</code> 介紹 OpenVPN 伺服器的位址及埠號；描述密鑰文件位址時，需參考 <code
                class="literal">ca</code>、<code
                class="literal">cert</code> 和 <code
                class="literal">key</code>。
				</div><div
              class="para">
					若開機時無法自動進入 VPN，則需設定 <code
                class="literal">AUTOSTART</code> 為 <code
                class="literal">none</code> 於 <code
                class="filename">/etc/default/openvpn</code> 檔案內。以命令 <code
                class="command">service openvpn@<em
                  class="replaceable">name</em> start</code> 和 <code
                class="command">service openvpn@<em
                  class="replaceable">name</em> stop</code> (其中的 <em
                class="replaceable">name</em> 就是在 <code
                class="filename">/etc/openvpn/<em
                  class="replaceable">name</em>.conf</code> 中設定的名稱) 就能啟用或停用指定的 VPN 連結。
				</div><div
              class="para">
					此 <span
                class="pkg pkg">network-manager-openvpn-gnome</span> 套件包括允許管理 OpenVPN 虛擬專屬網路的延伸網路管理者 (見 <a
                class="xref"
                href="sect.network-config.html#sect.roaming-network-config">節 8.2.4, “網路自動組態漫遊使用者”</a>)。允許每個使用者以圖形介面組態 OpenVPN 且從網路管理圖示控制它們。 <a
                id="id-1.13.5.7.8.4.3"
                class="indexterm"></a>
				</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.ssh-vpn"></a>10.2.2. SSH 下的虛擬專屬網路</h3></div></div></div><a
            id="id-1.13.5.8.2"
            class="indexterm"></a><a
            id="id-1.13.5.8.3"
            class="indexterm"></a><div
            class="para">
				實際上有兩種方法以 SSH 新增虛擬專屬網路。較舊的是以 SSH 建立 PPP 層連結。此方法在 HOWTO 文件詳細說明：<div
              class="url">→ <a
                href="http://www.tldp.org/HOWTO/ppp-ssh/">http://www.tldp.org/HOWTO/ppp-ssh/</a></div>
			</div><div
            class="para">
				第二個方法較新，適用於 OpenSSH 4.3；可以在 OpenSSH 之下建立虛擬網路介面 (<code
              class="literal">tun*</code>) 於 SSH 連結的兩端，且可以精準地組態這些虛擬介面，就像在實體介面環境下。必須先設定 <code
              class="literal">PermitTunnel</code> 為 “yes” 於 SSH 伺服器組態檔 (<code
              class="filename">/etc/ssh/sshd_config</code>)，才能啟用此隧道系統。啟用 SSH 連結後，新增的隧道必須以 <code
              class="literal">-w any:any</code> 選項 (<code
              class="literal">any</code> 可以用期望的 <code
              class="literal">tun</code> 設備名稱取代) 請求連結。兩端的使用者需有管理者權限，才能新增網路設備 (換句話說，必須以超級使用者的身份才能建立連結)。
			</div><div
            class="para">
				以 SSH 建立虛擬專屬網路的兩種方法都很直接。然而，它們提供的 VPN 不是最有效的；特別是，無法有效處理高階的流量。
			</div><div
            class="para">
				當 TCP/IP 堆疊封裝在 TCP/IP 連結 (供 SSH 使用) 時，TCP 協定用了兩次，一次給 SSH 連結用，另一次使用於通道。問題就在這裡，尤其是 TCP 改變網路延遲時間的狀態。詳情見：<div
              class="url">→ <a
                href="http://sites.inka.de/sites/bigred/devel/tcp-tcp.html">http://sites.inka.de/sites/bigred/devel/tcp-tcp.html</a></div> 所以在 SSH 環境下的 VPN 應限制於無效能限制的一次性通道。
			</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.ipsec"></a>10.2.3. 網際網路安全協定</h3></div></div></div><a
            id="id-1.13.5.9.2"
            class="indexterm"></a><a
            id="id-1.13.5.9.3"
            class="indexterm"></a><a
            id="id-1.13.5.9.4"
            class="indexterm"></a><div
            class="para">
				僅管 IPsec 已是 IP VPN 的標準，不過在應用層面仍有待加強。IPsec 引擎本身已經整合入 Linux 核心；控制與組態工具等必備的使用者部份，已由 <span
              class="pkg pkg">ipsec-tools</span> 套件提供。具體來說，每個主機的 <code
              class="filename">/etc/ipsec-tools.conf</code> 包括給 <span
              class="emphasis"><em>IPsec tunnels</em></span> (或 <span
              class="emphasis"><em>Security Associations</em></span>，以 IPsec 術語來說) 使用的參數，讓主機連進來；<code
              class="command">/etc/init.d/setkey</code> 腳本提供啟用與停止通道的方法 (每個通道是安全連結至另個主機虛擬私有網路)。可以參考 <span
              class="citerefentry"><span
                class="refentrytitle">setkey</span>(8)</span> 手冊提供的文件，以人工方式建立此檔案。然而，撰寫供所有主機使用的參數，並不輕鬆反而極為煩瑣，因為通道的數量急劇增加。安裝 IKE 排程 (如 <span
              class="emphasis"><em>IPsec Key Exchange</em></span>) 就像 <span
              class="pkg pkg">racoon</span> 或 <span
              class="pkg pkg">strongswan</span> 把管理帶入中央的點，就可簡化此程序，而且定期更換金鑰，顯得更安全。
			</div><a
            id="id-1.13.5.9.6"
            class="indexterm"></a><a
            id="id-1.13.5.9.7"
            class="indexterm"></a><a
            id="id-1.13.5.9.8"
            class="indexterm"></a><a
            id="id-1.13.5.9.9"
            class="indexterm"></a><div
            class="para">
				僅管其狀態為參照，IPsec 的設定限制其用途。必備的通道不多也不是動態時，OpenVPN-based 解決方案較受用。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>注意</em></span> IPsec 與 NAT</strong></p></div></div></div><div
              class="para">
				NAT 的防火牆與 IPsec 無法併用：因為 IPsec 是套件，任何改變將引發防火牆的作用，套件就會被拒絕。不同的 IPsec 應用包括：<span
                class="emphasis"><em>NAT-T</em></span> 技術 (給 <span
                class="emphasis"><em>NAT Traversal</em></span>)，把 IPsec 套件包裝在標準的 UDP 封包內。
			</div><a
              id="id-1.13.5.9.11.3"
              class="indexterm"></a><a
              id="id-1.13.5.9.11.4"
              class="indexterm"></a></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>安全</em></span> IPsec 與防火牆</strong></p></div></div></div><div
              class="para">
				IPsec 的標準操作模式在 UDP 埠號 500 做鍵值交換 (使用 NAT-T 時，也可在 UDP 埠號 4500)。而且，IPsec 封包使用兩個固定的 IP 協定允許防火牆通過；收到這些封包的基礎是其協定編號，50 (ESP) 與 51 (AH)。
			</div><a
              id="id-1.13.5.9.12.3"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.4"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.5"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.6"
              class="indexterm"></a></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.pptp"></a>10.2.4. PPTP</h3></div></div></div><div
            class="para">
				PPTP (𪅈原文是 <span
              class="emphasis"><em>Point-to-Point Tunneling Protocol</em></span>) 用到兩種通訊閘道，一個控制資料另個酬載資料；後者使用 GRE 協定 (<span
              class="emphasis"><em>Generic Routing Encapsulation</em></span>)。標準的 PPP 連結建立在資料交換閘道。
			</div><a
            id="id-1.13.5.10.3"
            class="indexterm"></a><a
            id="id-1.13.5.10.4"
            class="indexterm"></a><a
            id="id-1.13.5.10.5"
            class="indexterm"></a><a
            id="id-1.13.5.10.6"
            class="indexterm"></a><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="sect.pptp-config-client"></a>10.2.4.1. 設定客戶端</h4></div></div></div><div
              class="para">
					此 <span
                class="pkg pkg">pptp-linux</span> 封包含有易於組態的 Linux 客戶端 PPTP。以下說明取自官方文件：<div
                class="url">→ <a
                  href="http://pptpclient.sourceforge.net/howto-debian.phtml">http://pptpclient.sourceforge.net/howto-debian.phtml</a></div>
				</div><a
              id="id-1.13.5.10.7.3"
              class="indexterm"></a><div
              class="para">
					Falcot 管理者新增若干檔案：<code
                class="filename">/etc/ppp/options.pptp</code>、<code
                class="filename">/etc/ppp/peers/falcot</code>、<code
                class="filename">/etc/ppp/ip-up.d/falcot</code>、與 <code
                class="filename">/etc/ppp/ip-down.d/falcot</code>。
				</div><div
              class="example"><a
                id="example.ppp-options.pptp"></a><p
                class="title"><strong>範例 10.2. <code
                    class="filename">/etc/ppp/options.pptp</code> 檔案</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# PPP options used for a PPTP connection
lock
noauth
nobsdcomp
nodeflate</pre></div></div><div
              class="example"><a
                id="example.ppp-peers-falcot"></a><p
                class="title"><strong>範例 10.3. <code
                    class="filename">/etc/ppp/peers/falcot</code> 檔案</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# vpn.falcot.com is the PPTP server
pty "pptp vpn.falcot.com --nolaunchpppd"
# the connection will identify as the "vpn" user
user vpn
remotename pptp
# encryption is needed
require-mppe-128
file /etc/ppp/options.pptp
ipparam falcot</pre></div></div><div
              class="example"><a
                id="example.ppp-ip-up.d-falcot"></a><p
                class="title"><strong>範例 10.4. <code
                    class="filename">/etc/ppp/ip-up.d/falcot</code> 檔案</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Create the route to the Falcot network
if [ "$6" = "falcot" ]; then
  # 192.168.0.0/24 is the (remote) Falcot network
  route add -net 192.168.0.0 netmask 255.255.255.0 dev $1
fi</pre></div></div><div
              class="example"><a
                id="example.ppp-ip-down.d-falcot"></a><p
                class="title"><strong>範例 10.5. <code
                    class="filename">/etc/ppp/ip-down.d/falcot</code> 檔案</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Delete the route to the Falcot network
if [ "$6" = "falcot" ]; then
  # 192.168.0.0/24 is the (remote) Falcot network
  route del -net 192.168.0.0 netmask 255.255.255.0 dev $1
fi</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>安全</em></span> MPPE</strong></p></div></div></div><div
                class="para">
					加密的 PPTP 涉及使用 MPPE 功能 (<span
                  class="emphasis"><em>Microsoft Point-to-Point Encryption</em></span>)，可從 Debian 官方的核心取得模組。
				</div><a
                id="id-1.13.5.10.7.9.3"
                class="indexterm"></a><a
                id="id-1.13.5.10.7.9.4"
                class="indexterm"></a></div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="sect.pptp-config-serveur"></a>10.2.4.2. 組態伺服器</h4></div></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>注意</em></span> PPTP 與防火牆</strong></p></div></div></div><div
                class="para">
					需組態中間防火牆讓 IP 封包使用埠號 47 (GRE)。此外，需打開 PPTP 伺服器的埠號 1723以使用通訊閘道。
				</div></div><div
              class="para">
					<code
                class="command">pptpd</code> 是 Linux 的 PPTP 伺服器。它的主要組態檔是，<code
                class="filename">/etc/pptpd.conf</code>，應做若干改變：<span
                class="emphasis"><em>localip</em></span> (內網 IP 位址) 與 <span
                class="emphasis"><em>remoteip</em></span> (外網 IP 位址)。在下例中，PPTP 伺服器總是使用 <code
                class="literal">192.168.0.199</code> 位址，以及從 <code
                class="literal">192.168.0.200</code> 至 <code
                class="literal">192.168.0.250</code> 之間接收 PPTP 客戶端的 IP 位址。
				</div><div
              class="example"><a
                id="example.pptpd.conf"></a><p
                class="title"><strong>範例 10.6. <code
                    class="filename">/etc/pptpd.conf</code> 檔案</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# TAG: speed
#
#       Specifies the speed for the PPP daemon to talk at.
#
speed 115200

# TAG: option
#
#       Specifies the location of the PPP options file.
#       By default PPP looks in '/etc/ppp/options'
#
option /etc/ppp/pptpd-options

# TAG: debug
#
#       Turns on (more) debugging to syslog
#
# debug

# TAG: localip
# TAG: remoteip
#
#       Specifies the local and remote IP address ranges.
#
#       You can specify single IP addresses separated by commas or you can
#       specify ranges, or both. For example:
#
#               192.168.0.234,192.168.0.245-249,192.168.0.254
#
#       IMPORTANT RESTRICTIONS:
#
#       1. No spaces are permitted between commas or within addresses.
#
#       2. If you give more IP addresses than MAX_CONNECTIONS, it will
#          start at the beginning of the list and go until it gets
#          MAX_CONNECTIONS IPs. Others will be ignored.
#
#       3. No shortcuts in ranges! ie. 234-8 does not mean 234 to 238,
#          you must type 234-238 if you mean this.
#
#       4. If you give a single localIP, that's ok - all local IPs will
#          be set to the given one. You MUST still give at least one remote
#          IP for each simultaneous client.
#
#localip 192.168.0.234-238,192.168.0.245
#remoteip 192.168.1.234-238,192.168.1.245
#localip 10.0.1.1
#remoteip 10.0.1.2-100
localip 192.168.0.199
remoteip 192.168.0.200-250</pre></div></div><div
              class="para">
					PPP 採用 PPTP 伺服器組態時也需在 <code
                class="filename">/etc/ppp/pptpd-options</code> 做若干改變。 重要的參數有伺服器名稱 (<code
                class="literal">pptp</code>)、網域名稱 (<code
                class="literal">falcot.com</code>)、以及 DNS 與 WINS 伺服器的 IP 位址。
				</div><div
              class="example"><a
                id="example.ppp-pptpd-options"></a><p
                class="title"><strong>範例 10.7. <code
                    class="filename">/etc/ppp/pptpd-options</code> 檔案</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
## turn pppd syslog debugging on
#debug

## change 'servername' to whatever you specify as your server name in chap-secrets
name pptp
## change the domainname to your local domain
domain falcot.com

## these are reasonable defaults for WinXXXX clients
## for the security related settings
# The Debian pppd package now supports both MSCHAP and MPPE, so enable them
# here. Please note that the kernel support for MPPE must also be present!
auth
require-chap
require-mschap
require-mschap-v2
require-mppe-128

## Fill in your addresses
ms-dns 192.168.0.1
ms-wins 192.168.0.1

## Fill in your netmask
netmask 255.255.255.0

## some defaults
nodefaultroute
proxyarp
lock
</pre></div></div><div
              class="para">
					登錄 <code
                class="literal">vpn</code> 使用者 (及其密碼) 於 <code
                class="filename">/etc/ppp/chap-secrets</code> 檔案的最後一個步驟。其他的作為裡，星號 (<code
                class="literal">*</code>) 是有作用的，在此的伺服器名稱必須明示出來。而且，Windows PPTP 客戶端以 <code
                class="literal"><em
                  class="replaceable">DOMAIN</em>\\<em
                  class="replaceable">USER</em></code> 形式辨識，不是以使用者名稱區別。這就說明了在 <code
                class="literal">FALCOT\\vpn</code> 使用者必須提及的檔案。也可以指定使用者使用特定的 IP 位址；此欄位內的星號用於指定動態的位址。
				</div><div
              class="example"><a
                id="example.ppp-chap-secrets"></a><p
                class="title"><strong>範例 10.8. 該 <code
                    class="filename">/etc/ppp/chap-secrets</code> 檔案</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Secrets for authentication using CHAP
# client        server  secret      IP addresses
vpn             pptp    f@Lc3au     *
FALCOT\\vpn     pptp    f@Lc3au     *</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>安全</em></span> PPTP 漏洞</strong></p></div></div></div><div
                class="para">
					𧢒微軟的第一個 PPTP 應用發生重大的瑕疪，因為出現很多安全漏洞；多半在新版已修正了。本節的組態文件使用最新版的協定。移除部份選項 (如 <code
                  class="literal">require-mppe-128</code> 與 <code
                  class="literal">require-mschap-v2</code>) 仍可能再出現服務漏洞。
				</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="network-infrastructure.html"><strong>前一頁</strong>章 10. 網路架構</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上一層</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>起始頁</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.quality-of-service.html"><strong>下一頁</strong>10.3. 品質服務</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/sect.virtual-private-network.html">ar-MA</a></li><li><a
              href="../da-DK/sect.virtual-private-network.html">da-DK</a></li><li><a
              href="../de-DE/sect.virtual-private-network.html">de-DE</a></li><li><a
              href="../el-GR/sect.virtual-private-network.html">el-GR</a></li><li><a
              href="../en-US/sect.virtual-private-network.html">en-US</a></li><li><a
              href="../es-ES/sect.virtual-private-network.html">es-ES</a></li><li><a
              href="../fa-IR/sect.virtual-private-network.html">fa-IR</a></li><li><a
              href="../fr-FR/sect.virtual-private-network.html">fr-FR</a></li><li><a
              href="../hr-HR/sect.virtual-private-network.html">hr-HR</a></li><li><a
              href="../id-ID/sect.virtual-private-network.html">id-ID</a></li><li><a
              href="../it-IT/sect.virtual-private-network.html">it-IT</a></li><li><a
              href="../ja-JP/sect.virtual-private-network.html">ja-JP</a></li><li><a
              href="../ko-KR/sect.virtual-private-network.html">ko-KR</a></li><li><a
              href="../nb-NO/sect.virtual-private-network.html">nb-NO</a></li><li><a
              href="../pl-PL/sect.virtual-private-network.html">pl-PL</a></li><li><a
              href="../pt-BR/sect.virtual-private-network.html">pt-BR</a></li><li><a
              href="../ro-RO/sect.virtual-private-network.html">ro-RO</a></li><li><a
              href="../ru-RU/sect.virtual-private-network.html">ru-RU</a></li><li><a
              href="../tr-TR/sect.virtual-private-network.html">tr-TR</a></li><li><a
              href="../vi-VN/sect.virtual-private-network.html">vi-VN</a></li><li><a
              href="../zh-CN/sect.virtual-private-network.html">zh-CN</a></li><li><a
              href="../zh-TW/sect.virtual-private-network.html">zh-TW</a></li></ul></div></body></html>
