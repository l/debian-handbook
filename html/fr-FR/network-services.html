<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">Chapitre 11. Services réseau : Postfix, Apache, NFS, Samba, Squid, LDAP</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.1" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-fr-FR-1.0-1" /><meta
        name="keywords"
        content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP" /><link
        rel="home"
        href="index.html"
        title="Le cahier de l'administrateur Debian" /><link
        rel="up"
        href="index.html"
        title="Le cahier de l'administrateur Debian" /><link
        rel="prev"
        href="sect.network-diagnosis-tools.html"
        title="10.8. Outils de diagnostic réseau" /><link
        rel="next"
        href="sect.http-web-server.html"
        title="11.2. Serveur web (HTTP)" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/fr-FR/network-services.html" /></head><body
      class="draft "><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="http://debian-handbook.info"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>Précédent</strong></a></li><li
          class="home">Le cahier de l'administrateur Debian</li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>Suivant</strong></a></li></ul><div
        xml:lang="fr-FR"
        class="chapter"
        lang="fr-FR"><div
          class="titlepage"><div><div><h1
                class="title"><a
                  id="network-services"></a>Chapitre 11. Services réseau : Postfix, Apache, NFS, Samba, Squid, LDAP</h1></div></div></div><div
          class="toc"><dl
            class="toc"><dt><span
                class="section"><a
                  href="network-services.html#sect.smtp-mail-server">11.1. Serveur de messagerie électronique</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="network-services.html#idm140565674063504">11.1.1. Installation de Postfix</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140565670473344">11.1.2. Configuration de domaines virtuels</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140565685607856">11.1.3. Restrictions à la réception et à l'envoi</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140565666362864">11.1.4. Mise en place du <span
                        class="foreignphrase"><em
                          class="foreignphrase">greylisting</em></span></a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140565666338256">11.1.5. Personnalisation des filtres en fonction du destinataire</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#sect.postfix-antivirus">11.1.6. Intégration d'un antivirus</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140565666298192">11.1.7. SMTP authentifié</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-web-server.html">11.2. Serveur web (HTTP)</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140565666263344">11.2.1. Installation d'Apache</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140565687332400">11.2.2. Configuration d'hôtes virtuels</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140565687308528">11.2.3. Directives courantes</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140565687227376">11.2.4. Analyseur de logs</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ftp-file-server.html">11.3. Serveur de fichiers FTP</a></span></dt><dt><span
                class="section"><a
                  href="sect.nfs-file-server.html">11.4. Serveur de fichiers NFS</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140565687166992">11.4.1. Sécuriser NFS (au mieux)</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140565687131072">11.4.2. Serveur NFS</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140565665108192">11.4.3. Client NFS</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.windows-file-server-with-samba.html">11.5. Partage Windows avec Samba</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm140565665088976">11.5.1. Samba en serveur</a></span></dt><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm140565665039248">11.5.2. Samba en client</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-ftp-proxy.html">11.6. Mandataire HTTP/FTP</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140565664998848">11.6.1. Installation</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140565664993552">11.6.2. Configuration d'un cache</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140565664989776">11.6.3. Configuration d'un filtre</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ldap-directory.html">11.7. Annuaire LDAP</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140565664966960">11.7.1. Installation</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140565664947376">11.7.2. Remplissage de l'annuaire</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140565664917616">11.7.3. Utiliser LDAP pour gérer les comptes</a></span></dt></dl></dd></dl></div><div
          class="highlights"><div
            class="para">
		Les services réseau sont les programmes interagissant directement avec les utilisateurs dans leur travail quotidien. C'est la partie émergée de l'iceberg « système d'information » présenté dans ce chapitre. La partie immergée, l'infrastructure, sur laquelle ils s'appuient, reste en arrière-plan.
	</div></div><div
          class="section"><div
            class="titlepage"><div><div><h2
                  class="title"><a
                    id="sect.smtp-mail-server"></a>11.1. Serveur de messagerie électronique</h2></div></div></div><div
            class="para">
			Les administrateurs de Falcot SA ont retenu Postfix comme serveur de courrier électronique en raison de sa simplicité de configuration et de sa fiabilité. En effet, sa conception réduit au maximum les droits de chacune de ses sous-tâches, ce qui limite l'impact de toute faille de sécurité.
		</div><a
            id="idm140565667569696"
            class="indexterm"></a><a
            id="idm140565677371440"
            class="indexterm"></a><a
            id="idm140565676376240"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>ALTERNATIVE</em></span> Le serveur Exim4</strong></p></div></div></div><a
              id="idm140565670911488"
              class="indexterm"></a><div
              class="para">
			Debian emploie Exim4 comme serveur de messagerie par défaut (il est donc automatiquement installé pendant l'installation initiale). La configuration, fournie par le paquet <span
                class="pkg pkg">exim4-config</span>, est automatiquement personnalisée grâce à un certain nombre de questions debconf très similaires à celles posées par <span
                class="pkg pkg">postfix</span>.
		</div><div
              class="para">
			La configuration est, au choix, soit dans un seul gros fichier (<code
                class="filename">/etc/exim4/exim4.conf.template</code>), soit dans un certain nombre de fragments de fichiers répartis dans <code
                class="filename">/etc/exim4/conf.d/</code>. Dans les deux cas, les fichiers sont exploités par la commande <code
                class="command">update-exim4.conf</code> comme modèles pour générer <code
                class="filename">/var/lib/exim4/config.autogenerated</code>, qui est le fichier utilisé par Exim4. Grâce à ce mécanisme, les valeurs obtenues par la configuration debconf de Exim (stockées dans <code
                class="filename">/etc/exim4/update-exim4.conf.conf</code>) peuvent être injectées dans le fichier de configuration d'Exim, et cela même si l'administrateur ou un autre paquet ont modifié la configuration Exim par défaut.
		</div><div
              class="para">
			La syntaxe de configuration d'Exim4 est assez particulière et il faut un certain temps pour s'y accoutumer. Toutefois, une fois que ces particularités sont maîtrisées, il s'agit d'un serveur de messagerie très complet et très puissant. Il suffit de parcourir les dizaines de pages de documentation pour s'en rendre compte. <div
                class="url">→ <a
                  href="http://www.exim.org/docs.html">http://www.exim.org/docs.html</a></div>
		</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140565674063504"></a>11.1.1. Installation de Postfix</h3></div></div></div><div
              class="para">
				Le paquet Debian <span
                class="pkg pkg">postfix</span> contient le démon SMTP principal. Divers modules (comme <span
                class="pkg pkg">postfix-ldap</span> ou <span
                class="pkg pkg">postfix-pgsql</span>) offrent des fonctionnalités supplémentaires à Postfix (notamment en termes d'accès à des bases de données de correspondances). Ne les installez que si vous en avez déjà perçu le besoin.
			</div><div
              class="sidebar"><a
                id="sidebar.smtp"></a><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>B.A.-BA</em></span> SMTP</strong></p></div></div></div><a
                id="idm140565675907152"
                class="indexterm"></a><a
                id="idm140565675906192"
                class="indexterm"></a><a
                id="idm140565675905104"
                class="indexterm"></a><div
                class="para">
				SMTP (<span
                  class="emphasis"><em>Simple Mail Transfer Protocol</em></span>) est le protocole employé par les serveurs de messagerie pour s'échanger et router les courriers électroniques.
			</div></div><div
              class="para">
				Au cours de l'installation du paquet, plusieurs questions sont posées par l'intermédiaire de <code
                class="command">debconf</code>. Les réponses permettront de générer un premier fichier <code
                class="filename">/etc/postfix/main.cf</code>.
			</div><div
              class="para">
				La première question porte sur le type d'installation. Parmi les choix proposés, seuls deux sont pertinents dans le cadre d'un serveur connecté à Internet. Il s'agit de <span
                class="guimenuitem"><strong>Site Internet</strong></span> et de <span
                class="guimenuitem"><strong>Site Internet utilisant un smarthost</strong></span>. Le premier choix est adapté à un serveur qui reçoit et envoie le courrier directement à ses destinataires, mode retenu par les administrateurs de Falcot. Le second correspond à un serveur qui reçoit directement le courrier mais en envoie par le biais d'un serveur SMTP intermédiaire — désigné par le terme <span
                class="foreignphrase"><em
                  class="foreignphrase">smarthost</em></span> — plutôt que directement au serveur du destinataire. C'est surtout utile pour les particuliers disposant d'une adresse IP dynamique, parce que certains serveurs de messagerie refusent tout message provenant directement d'une telle adresse IP. Le <span
                class="foreignphrase"><em
                  class="foreignphrase">smarthost</em></span> sera ici le serveur SMTP du fournisseur d'accès à Internet (FAI), qui est toujours configuré pour transmettre le courrier provenant de ses clients. Cette solution est également intéressante pour toute machine qui n'est pas connectée en permanence, car cela lui évite de devoir gérer une file d'attente des messages non délivrables qu'il faudra réessayer d'expédier plus tard.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>VOCABULAIRE</em></span> FAI</strong></p></div></div></div><a
                id="idm140565677544560"
                class="indexterm"></a><div
                class="para">
				FAI est l'abréviation de « Fournisseur d'Accès à Internet ». Il s'agit d'une entité (souvent société commerciale) qui fournit des connexions à Internet ainsi que les services de base associés (serveur de messagerie électronique, de news, etc.). Parmi les FAI français, on peut citer Free, Orange (ex-Wanadoo), SFR, AOL, FDN, etc. L'abréviation anglaise correspondante est ISP pour <span
                  class="foreignphrase"><em
                    class="foreignphrase">Internet Service Provider</em></span>.
			</div><div
                class="para">
			</div></div><div
              class="para">
				La deuxième question porte sur le nom complet de la machine, employé pour générer une adresse de courrier électronique depuis un nom d'utilisateur local (c'est la partie suivant l'arobase « <code
                class="literal">@</code> »). Pour Falcot, la réponse est <code
                class="literal">mail.falcot.com</code>. C'est la seule question posée en standard, mais elle ne suffit pas pour avoir une configuration satisfaisante, les administrateurs exécutent donc <code
                class="command">dpkg-reconfigure postfix</code> afin de pouvoir personnaliser plus de paramètres.
			</div><div
              class="para">
				Parmi les questions supplémentaires, l'ordinateur demande de saisir tous les noms de domaines associés à cette machine. La liste proposée inclut le nom complet de la machine et des synonymes de <code
                class="literal">localhost</code>, mais pas le domaine principal <code
                class="literal">falcot.com</code>, qu'il faut ajouter manuellement. D'une manière générale, il convient habituellement de donner ici tous les noms de domaines pour lesquels cette machine fait office de serveur MX (c'est-à-dire tous ceux pour lesquels le DNS indique qu'elle est apte à accepter du courrier). Ces informations sont ensuite stockées dans la variable <code
                class="literal">mydestination</code> du fichier <code
                class="filename">/etc/postfix/main.cf</code> (principal fichier de configuration de Postfix).
			</div><a
              id="idm140565684367088"
              class="indexterm"></a><a
              id="idm140565684365648"
              class="indexterm"></a><div
              class="figure"><a
                id="idm140565684364208"></a><div
                class="figure-contents"><div
                  class="mediaobject"><img
                    src="images/mail-server.png"
                    alt="Rôle de l'enregistrement DNS MX dans un envoi de courrier électronique" /></div></div><p
                class="title"><strong>Figure 11.1. Rôle de l'enregistrement DNS <span
                    class="emphasis"><em>MX</em></span> dans un envoi de courrier électronique</strong></p></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>COMPLÉMENTS</em></span> Interrogation des enregistrements MX</strong></p></div></div></div><div
                class="para">
				Si le serveur DNS ne publie pas d'enregisrement MX pour un domaine, le serveur de messagerie tentera d'envoyer le courrier à la machine de même nom. Il emploiera donc l'enregistrement de type A correspondant (ou AAAA en IPv6).
			</div></div><div
              class="para">
				Selon les cas, l'installation peut également demander d'indiquer les réseaux habilités à envoyer du courrier par l'intermédiaire de cette machine. Par défaut, Postfix est configuré pour n'accepter que des courriers électroniques issus de la machine elle-même ; il faut généralement ajouter le réseau local. Les administrateurs ont donc ajouté <code
                class="literal">192.168.0.0/16</code> à la réponse par défaut. Si la question n'est pas posée, il faut modifier le fichier de configuration et y changer la variable <code
                class="literal">mynetworks</code>, comme on le voit sur l'exemple plus loin.
			</div><div
              class="para">
				L'emploi de <code
                class="command">procmail</code> peut aussi être proposé pour délivrer le courrier localement. Cet outil permet aux utilisateurs de trier leur courrier entrant, ce pour quoi ils doivent indiquer des règles de tri dans leur fichier <code
                class="filename">~/.procmailrc</code>.
			</div><a
              id="idm140565670484368"
              class="indexterm"></a><a
              id="idm140565670483248"
              class="indexterm"></a><a
              id="idm140565670481808"
              class="indexterm"></a><div
              class="para">
				Après cette première étape, les administrateurs ont obtenu le fichier de configuration ci-dessous. Il va servir de base pour les sections suivantes, qui le modifieront pour activer certaines fonctionnalités.
			</div><div
              class="example"><a
                id="idm140565670480192"></a><p
                class="title"><strong>Exemple 11.1. Fichier <code
                    class="filename">/etc/postfix/main.cf</code> initial</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SÉCURITÉ</em></span> Certificat SSL <span
                          class="foreignphrase"><em
                            class="foreignphrase">snake oil</em></span></strong></p></div></div></div><div
                class="para">
				L'expression anglaise <span
                  class="foreignphrase"><em
                    class="foreignphrase">snake oil</em></span> pourrait se traduire par « poudre aux yeux ». Les certificats mentionnés dans l'exemple n'ont aucune valeur de protection, puisqu'ils sont générés de la même manière sur tous les systèmes Debian (donc avec la même partie privée). Ils ne sauraient être utilisés qu'à des fins de test, le fonctionnement normal se devant d'utiliser de vrais certificats. On pourra par exemple utiliser la procédure décrite dans la <a
                  class="xref"
                  href="sect.virtual-private-network.html#sect.easy-rsa">Section 10.2.1.1, « Infrastructure de clés publiques <span
                    class="emphasis"><em>easy-rsa</em></span> »</a>.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140565670473344"></a>11.1.2. Configuration de domaines virtuels</h3></div></div></div><a
              id="idm140565670472576"
              class="indexterm"></a><a
              id="idm140565670471136"
              class="indexterm"></a><div
              class="para">
				Le serveur de messagerie peut recevoir le courrier pour d'autres domaines que le domaine principal ; on parle alors de domaines virtuels. Dans ces situations, il est rare que le courrier soit destiné aux utilisateurs locaux. Postfix offre deux fonctionnalités intéressantes pour gérer ces domaines virtuels.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>ATTENTION</em></span> Domaines virtuels et domaines canoniques</strong></p></div></div></div><div
                class="para">
				Aucun des domaines virtuels ne doit être indiqué dans la variable <code
                  class="literal">mydestination</code>. Celle-ci contient uniquement les noms des domaines « canoniques », directement associés à la machine et à ses utilisateurs locaux.
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140565667606672"></a>11.1.2.1. Domaine virtuel d'alias</h4></div></div></div><a
                id="idm140565667605872"
                class="indexterm"></a><a
                id="idm140565667604432"
                class="indexterm"></a><div
                class="para">
					Un domaine virtuel d'alias ne contient que des alias, c'est-à-dire des adresses électroniques renvoyant le courrier vers d'autres adresses électroniques.
				</div><div
                class="para">
					Pour activer un tel domaine, il faut préciser son nom dans la variable <code
                  class="literal">virtual_alias_domains</code> et indiquer le fichier stockant les correspondances d'adresses dans la variable <code
                  class="literal">virtual_alias_maps</code>.
				</div><div
                class="example"><a
                  id="idm140565667600992"></a><p
                  class="title"><strong>Exemple 11.2. Directives à ajouter au fichier <code
                      class="filename">/etc/postfix/main.cf</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual
</pre></div></div><div
                class="para">
					The <code
                  class="filename">/etc/postfix/virtual</code> file describes a mapping with a rather straightforward syntax: each line contains two fields separated by whitespace; the first field is the alias name, the second field is a list of email addresses where it redirects. The special <code
                  class="literal">@domain.com</code> syntax covers all remaining aliases in a domain.
				</div><div
                class="example"><a
                  id="idm140565667597664"></a><p
                  class="title"><strong>Exemple 11.3. Exemple de fichier <code
                      class="filename">/etc/postfix/virtual</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# The alias below is generic and covers all addresses within 
# the falcotsbrand.com domain not otherwise covered by this file.
# These addresses forward email to the same user name in the
# falcot.com domain.
@falcotsbrand.com           @falcot.com
</pre></div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140565667595408"></a>11.1.2.2. Domaine virtuel de boîtes aux lettres</h4></div></div></div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>ATTENTION</em></span> Domaine virtuel mixte ?</strong></p></div></div></div><div
                  class="para">
					Il n'est pas permis d'indiquer le même domaine dans les variables <code
                    class="literal">virtual_alias_domains</code> et <code
                    class="literal">virtual_mailbox_domains</code>. En revanche, tout domaine de <code
                    class="literal">virtual_mailbox_domains</code> est implicitement compris dans <code
                    class="literal">virtual_alias_domains</code>. Il est donc possible de mélanger alias et boîtes aux lettres au sein d'un domaine virtuel.
				</div></div><a
                id="idm140565685623888"
                class="indexterm"></a><a
                id="idm140565685622960"
                class="indexterm"></a><div
                class="para">
					Les courriers destinés à un domaine virtuel de boîtes aux lettres sont stockés dans des boîtes aux lettres qui ne sont pas associées à un utilisateur local du système.
				</div><div
                class="para">
					Pour activer un domaine virtuel de boîtes aux lettres, il faut l'écrire dans la variable <code
                  class="literal">virtual_mailbox_domains</code> et préciser le fichier donnant les boîtes aux lettres avec la variable <code
                  class="literal">virtual_mailbox_maps</code>. Le paramètre <code
                  class="literal">virtual_mailbox_base</code> indique le répertoire sous lequel les différentes boîtes aux lettres seront stockées.
				</div><div
                class="para">
					Les paramètres <code
                  class="literal">virtual_uid_maps</code> et <code
                  class="literal">virtual_gid_maps</code> définissent des tables de correspondances entre l'adresse électronique, l'utilisateur et le groupe Unix propriétaire de la boîte aux lettres. Pour indiquer systématiquement le même propriétaire, la syntaxe <code
                  class="literal">static:5000</code> dénote un UID/GID fixe.
				</div><div
                class="example"><a
                  id="idm140565685616992"></a><p
                  class="title"><strong>Exemple 11.4. Directives à ajouter au fichier <code
                      class="filename">/etc/postfix/main.cf</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts
</pre></div></div><div
                class="para">
					Le format du fichier <code
                  class="filename">/etc/postfix/vmailbox</code> est de nouveau très simple : deux champs séparés par des blancs. Le premier indique une adresse électronique de l'un des domaines virtuels et le second l'emplacement relatif de la boîte aux lettres associée (par rapport au répertoire donné par <span
                  class="emphasis"><em>virtual_mailbox_base</em></span>). Si le nom de la boîte aux lettres se termine par une barre de division (<code
                  class="literal">/</code>), cette boîte sera stockée au format <span
                  class="emphasis"><em>maildir</em></span> ; dans le cas contraire, c'est le traditionnel <span
                  class="emphasis"><em>mbox</em></span> qui sera retenu. Le format <span
                  class="emphasis"><em>maildir</em></span> emploie un répertoire complet pour représenter la boîte aux lettres et chaque message est stocké dans un fichier. A contrario, une boîte aux lettres au format <span
                  class="emphasis"><em>mbox</em></span> est stockée dans un seul fichier et chaque ligne débutant par <code
                  class="literal">From </code> (<code
                  class="literal">From</code> suivi d'une espace) marque le début d'un nouveau message électronique.
				</div><div
                class="example"><a
                  id="idm140565685610192"></a><p
                  class="title"><strong>Exemple 11.5. Fichier <code
                      class="filename">/etc/postfix/vmailbox</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
# Jean's email is stored as maildir, with
# one file per email in a dedicated directory
jean@falcot.org falcot.org/jean/
# Sophie's email is stored in a traditional "mbox" file,
# with all mails concatenated into one single file
sophie@falcot.org falcot.org/sophie
</pre></div></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140565685607856"></a>11.1.3. Restrictions à la réception et à l'envoi</h3></div></div></div><div
              class="para">
				Avec le nombre croissant de messages non sollicités (<span
                class="foreignphrase"><em
                  class="foreignphrase">spams</em></span>), il est nécessaire d'être de plus en plus strict sur les messages que le serveur accepte. Cette section présente les différentes stratégies intégrées à Postfix.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CULTURE</em></span> Le problème du spam</strong></p></div></div></div><a
                id="idm140565685604880"
                class="indexterm"></a><div
                class="para">
				Le terme de spam désigne toutes les publicités non sollicitées (en anglais, on parle d'UCE — <span
                  class="foreignphrase"><em
                    class="foreignphrase">Unsolicited Commercial Email</em></span>) qui inondent nos boîtes aux lettres électroniques et les spammeurs sont les gens sans scrupules qui les expédient. Peu leur importent les nuisances qu'ils causent, statistiquement il suffit qu'un très faible pourcentage de personnes se laissent tenter par leurs offres pour qu'ils rentrent dans leurs frais. Le coût d'expédition d'un message électronique est en effet très faible. Toute adresse électronique publique (par exemple, employée sur un forum web, apparaissant dans une archive de liste de diffusion, citée dans un blog, etc.) sera découverte par les robots des spammeurs et sera soumise à un flux incessant de messages non sollicités.
			</div><div
                class="para">
				Face à ces nuisances, tous les administrateurs informatiques essaient de mettre en place des filtres anti-spam, mais les spammeurs cherchent sans arrêt à les contourner. Certains n'hésitent pas à faire appel aux services de réseaux mafieux contrôlant de nombreuses machines compromises par un ver. Les dernières statistiques estiment que 95% des courriers expédiés sont des spams !
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140565685601344"></a>11.1.3.1. Restreindre l'accès en fonction de l'adresse IP</h4></div></div></div><div
                class="para">
					La directive <code
                  class="literal">smtpd_client_restrictions</code> contrôle les machines autorisées à communiquer avec le serveur de courrier électronique.
				</div><div
                class="example"><a
                  id="idm140565685599680"></a><p
                  class="title"><strong>Exemple 11.6. Restrictions en fonction de l'adresse du client</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org
</pre></div></div><div
                class="para">
					Lorsqu'une variable contient une liste de règles comme dans l'exemple ci-dessus, il faut savoir que celles-ci sont évaluées dans l'ordre, de la première à la dernière. Chaque règle peut accepter le message, le refuser ou le laisser poursuivre son chemin à travers celles qui suivent. L'ordre a donc une importance et l'inversion de deux règles peut mettre en place un comportement très différent.
				</div><div
                class="para">
					La directive <code
                  class="literal">permit_mynetworks</code>, placée en tête de la liste des règles, accepte inconditionnellement toute machine du réseau local (tel que défini par la variable <code
                  class="literal">mynetworks</code> dans la configuration).
				</div><div
                class="para">
					La deuxième directive refuse normalement les machines dépourvues de configuration DNS totalement valide. Une configuration valide dispose d'une résolution inverse fonctionnelle et le nom DNS renvoyé pointe sur l'adresse IP employée. Cette restriction est généralement trop sévère, de nombreux serveurs de courrier électronique ne disposant pas de DNS inverse. C'est pourquoi les administrateurs de Falcot ont précédé la directive <code
                  class="literal">reject_unknown_client</code> de <code
                  class="literal">warn_if_reject</code>, qui transforme le refus en simple avertissement enregistré dans les logs. Ils peuvent ainsi surveiller le nombre de messages qui auraient été refusés et décider plus tard d'activer ou non cette règle en connaissant pleinement ses effets.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>ASTUCE</em></span> Tables <span
                            class="foreignphrase"><em
                              class="foreignphrase">access</em></span></strong></p></div></div></div><div
                  class="para">
					Les différents critères de restriction incluent des tables (modifiables par les administrateurs) de combinaisons expéditeurs/adresses IP/noms de machines autorisés ou interdits. Ces tables peuvent être créées en recopiant une version décompressée du fichier <code
                    class="filename">/usr/share/doc/postfix-doc/examples/access.gz</code> sous le nom indiqué. C'est un modèle auto-documenté dans ses commentaires. Chaque table documentera ainsi sa propre syntaxe.
				</div><div
                  class="para">
					La table <code
                    class="filename">/etc/postfix/access_clientip</code> donne la liste des adresses IP et réseau. La table <code
                    class="filename">/etc/postfix/access_helo</code> fournit celle des noms de machines et de domaines. Enfin, la table <code
                    class="filename">/etc/postfix/access_sender</code> précise les adresses électroniques. Après toute modification, chacun de ces fichiers doit être transformé en table de hachage, c'est-à-dire en une forme optimisée pour les accès rapides, par la commande <code
                    class="command">postmap /etc/postfix/<em
                      class="replaceable">fichier</em></code>.
				</div></div><div
                class="para">
					La troisième directive permet à l'administrateur de mettre en place une liste noire et une liste blanche de serveurs de courriers électroniques, stockées dans le fichier <code
                  class="filename">/etc/postfix/access_clientip</code>. Une liste blanche permet à l'administrateur de préciser les serveurs de confiance dispensés des règles suivantes.
				</div><div
                class="para">
					Les deux dernières règles de l'exemple refusent tout message provenant d'un serveur présent dans l'une des différentes listes noires indiquées (RBL signifie <span
                  class="foreignphrase"><em
                    class="foreignphrase">Remote Black Lists</em></span>, ou listes noires distantes). Celles-ci recensent les machines mal configurées employées par les spammeurs pour relayer leur courrier, ainsi que les relais inhabituels que constituent des machines infectées par des vers ou virus ayant cet effet.
				</div><a
                id="idm140565685585328"
                class="indexterm"></a><a
                id="idm140565685584368"
                class="indexterm"></a><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>ASTUCE</em></span> Liste blanche et RBL</strong></p></div></div></div><div
                  class="para">
					Les listes noires recensent parfois un serveur légitime victime d'un incident. Tout courrier issu de ce serveur serait alors refusé à moins que vous ne l'ayez listé dans la liste blanche associée au fichier <code
                    class="filename">/etc/postfix/access_clientip</code>.
				</div><div
                  class="para">
					Pour cette raison, il est prudent de placer dans une liste blanche les serveurs de messagerie de confiance et avec qui vous échangez beaucoup de courriers.
				</div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140565685580048"></a>11.1.3.2. Vérifier la validité de la commande <code
                        class="literal">EHLO</code> ou <code
                        class="literal">HELO</code></h4></div></div></div><div
                class="para">
					Chaque échange SMTP doit débuter par l'envoi d'une commande <code
                  class="literal">HELO</code> (ou <code
                  class="literal">EHLO</code>) suivie du nom du serveur de courrier électronique, dont il est possible de vérifier la validité.
				</div><a
                id="idm140565685576976"
                class="indexterm"></a><a
                id="idm140565685575856"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140565685574736"></a><p
                  class="title"><strong>Exemple 11.7. Restrictions sur le nom annoncé lors du <code
                      class="literal">EHLO</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname
</pre></div></div><div
                class="para">
					La première directive <code
                  class="literal">permit_mynetworks</code> autorise toutes les machines du réseau local à s'annoncer librement. C'est important car certains logiciels de courrier électronique respectent mal cette partie du protocole SMTP et peuvent donc annoncer des noms fantaisistes.
				</div><div
                class="para">
					La règle <code
                  class="literal">reject_invalid_hostname</code> refuse tout courrier dont l'annonce <code
                  class="literal">EHLO</code> indique un nom de machine syntaxiquement incorrect. La règle <code
                  class="literal">reject_non_fqdn_hostname</code> refuse tout message dont le nom de machine annoncé n'est pas complètement qualifié (un nom qualifié inclut le nom de domaine). La règle <code
                  class="literal">reject_unknown_hostname</code> refuse le courrier si la machine annoncée n'existe pas dans la base de données du DNS. Cette dernière règle refusant malheureusement trop de messages, elle est atténuée par le <code
                  class="literal">warn_if_reject</code> pour évaluer son impact avant de décider de l'activer ou non.
				</div><div
                class="para">
					L'emploi de <code
                  class="literal">permit_mynetworks</code> au début a l'effet secondaire intéressant de n'appliquer les règles suivantes qu'à des machines extérieures au réseau local. Il est ainsi possible de mettre en liste noire tous ceux qui s'annoncent membres du réseau <code
                  class="literal">falcot.com</code>... ce qui s'effectue en ajoutant la ligne <code
                  class="literal">falcot.com REJECT You're not in our network!</code> au fichier <code
                  class="filename">/etc/postfix/access_helo</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140565685565952"></a>11.1.3.3. Accepter ou refuser en fonction de l'émetteur (annoncé)</h4></div></div></div><div
                class="para">
					Chaque message envoyé est associé à un expéditeur annoncé par la commande <code
                  class="literal">MAIL FROM</code> du protocole SMTP, information qu'il est possible de vérifier de plusieurs manières.
				</div><a
                id="idm140565685564288"
                class="indexterm"></a><a
                id="idm140565685563168"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140565666409424"></a><p
                  class="title"><strong>Exemple 11.8. Vérifications sur l'expéditeur</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender
</pre></div></div><div
                class="para">
					La table <code
                  class="filename">/etc/postfix/access_sender</code> associe des traitements particuliers à certains expéditeurs. En général, il s'agit simplement de les placer dans une liste blanche ou noire.
				</div><div
                class="para">
					La règle <code
                  class="literal">reject_unknown_sender_domain</code> requiert un domaine d'expéditeur valide, nécessaire à une adresse valide. La règle <code
                  class="literal">reject_unlisted_sender</code> refuse les expéditeurs locaux si leur adresse n'existe pas. Personne ne peut ainsi envoyer de courrier issu d'une adresse invalide dans le domaine <code
                  class="literal">falcot.com</code>. Tout message d'expéditeur <code
                  class="literal">tartempion@falcot.com</code> ne serait donc accepté que si cette adresse existe vraiment.
				</div><div
                class="para">
					Enfin, la règle <code
                  class="literal">reject_non_fqdn_sender</code> refuse les adresses électroniques dépourvues de domaine complètement qualifié. Concrètement, elle refusera un courrier provenant de <code
                  class="literal">utilisateur@machine</code> : celui-ci doit s'annoncer comme <code
                  class="literal">utilisateur@machine.domaine.fr</code> ou <code
                  class="literal">utilisateur@domaine.fr</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140565666401776"></a>11.1.3.4. Accepter ou refuser en fonction du destinataire</h4></div></div></div><div
                class="para">
					Chaque courrier compte un ou plusieurs destinataires, communiqués par l'intermédiaire de la commande <code
                  class="literal">RCPT TO</code> du protocole SMTP. On pourra également vérifier ces informations, même si c'est moins intéressant que pour l'expéditeur.
				</div><a
                id="idm140565666399840"
                class="indexterm"></a><a
                id="idm140565666398880"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140565666397472"></a><p
                  class="title"><strong>Exemple 11.9. Vérifications sur le destinataire</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient
</pre></div></div><div
                class="para">
					<code
                  class="literal">reject_unauth_destination</code> is the basic rule that requires outside messages to be addressed to us; messages sent to an address not served by this server are rejected. Without this rule, a server becomes an open relay that allows spammers to send unsolicited emails; this rule is therefore mandatory, and it will be best included near the beginning of the list, so that no other rules may authorize the message before its destination has been checked.
				</div><div
                class="para">
					La règle <code
                  class="literal">reject_unlisted_recipient</code> refuse les messages à destination d'utilisateurs locaux inexistants (ce qui est assez logique). Enfin, la règle <code
                  class="literal">reject_non_fqdn_recipient</code> refuse les adresses électroniques non qualifiées. Il est ainsi impossible d'écrire à <code
                  class="literal">jean</code> ou à <code
                  class="literal">jean@machine</code> ; il faut impérativement employer la forme complète de l'adresse : <code
                  class="literal">jean@machine.falcot.com</code> ou <code
                  class="literal">jean@falcot.com</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140565666391104"></a>11.1.3.5. Restrictions associées à la commande <code
                        class="literal">DATA</code></h4></div></div></div><div
                class="para">
					La commande <code
                  class="literal">DATA</code> du protocole SMTP précède l'envoi des données contenues dans le message. Elle ne fournit aucune information en soi, mais prévient de ce qui va suivre. Il est pourtant possible de lui mettre en place des contrôles.
				</div><a
                id="idm140565666388848"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140565666387728"></a><p
                  class="title"><strong>Exemple 11.10. Restriction sur la commande <code
                      class="literal">DATA</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_data_restrictions = reject_unauth_pipelining
</pre></div></div><div
                class="para">
					La règle <code
                  class="literal">reject_unauth_pipelining</code> refuse le message si le correspondant envoie une commande sans avoir attendu la réponse à la commande précédente. Les robots des spammeurs font régulièrement cela : pour travailler plus vite, ils se moquent des réponses et visent seulement à envoyer un maximum de courriers, dans le laps de temps le plus court.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140565666384640"></a>11.1.3.6. Application des restrictions</h4></div></div></div><div
                class="para">
					Bien que toutes les règles évoquées ci-dessus soient prévues pour vérifier les informations à différents moments d'un échange SMTP, le refus réel n'est signifié par Postfix que lors de la réponse à la commande <code
                  class="literal">RCPT TO</code> (annonce du destinataire).
				</div><div
                class="para">
					Ainsi, même si le message est refusé suite à une commande <code
                  class="literal">EHLO</code> invalide, Postfix connaîtra l'émetteur et le destinataire lorsqu'il annoncera le refus. Il peut donc enregistrer un message de log plus explicite que s'il avait interrompu la connexion dès le début. De plus, beaucoup de clients SMTP ne s'attendent pas à subir un échec sur l'une des premières commandes du protocole SMTP et les clients mal programmés seront moins perturbés par ce refus tardif.
				</div><div
                class="para">
					Dernier avantage de ce choix : les règles peuvent associer les informations obtenues à différents stades de l'échange SMTP. On pourra ainsi refuser une connexion non locale si elle s'annonce avec un émetteur local.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140565666380560"></a>11.1.3.7. Filtrer en fonction du contenu du message</h4></div></div></div><div
                class="para">
					The validation and restriction system would not be complete without a way to apply checks to the message contents. Postfix differentiates the checks applying to the email headers from those applying to the email body.
				</div><div
                class="example"><a
                  id="idm140565666379104"></a><p
                  class="title"><strong>Exemple 11.11. Activation des filtres sur le contenu</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks
</pre></div></div><a
                id="idm140565666377728"
                class="indexterm"></a><div
                class="para">
					Les deux fichiers contiennent une liste d'expressions rationnelles (<span
                  class="foreignphrase"><em
                    class="foreignphrase">regexp</em></span>). Chacune est associée à une action à exécuter si elle est satisfaite par les en-têtes ou le corps du message.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>DÉCOUVERTE</em></span> Tables <span
                            class="foreignphrase"><em
                              class="foreignphrase">regexp</em></span></strong></p></div></div></div><div
                  class="para">
					Le fichier <code
                    class="filename">/usr/share/doc/postfix-doc/examples/header_checks.gz</code> peut servir de modèle pour créer les fichiers <code
                    class="filename">/etc/postfix/header_checks</code> et <code
                    class="filename">/etc/postfix/body_checks</code>. Il contient de nombreux commentaires explicatifs.
				</div></div><div
                class="example"><a
                  id="idm140565666371888"></a><p
                  class="title"><strong>Exemple 11.12. Exemple de fichier <code
                      class="filename">/etc/postfix/header_checks</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification
</pre></div></div><div
                class="sidebar"><a
                  id="sidebar.regexp"></a><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>B.A.-BA</em></span> Expression rationnelle</strong></p></div></div></div><div
                  class="para">
					Le terme d'expression rationnelle (en anglais, <span
                    class="foreignphrase"><em
                      class="foreignphrase">regular expression</em></span> ou <span
                    class="foreignphrase"><em
                      class="foreignphrase">regexp</em></span>) désigne une notation générique servant à décrire le contenu et/ou la structure d'une chaîne de caractères recherchée. Certains caractères spéciaux permettent de définir des alternatives (par exemple, « assez|trop » pour « assez » ou « trop »), des ensembles de caractères possibles (« [0-9] » pour un chiffre entre 0 et 9, ou « . » pour n'importe quel caractère), des quantifications (« s? » pour « » ou « s », à savoir 0 ou une fois le caractère « s » ; « s+ » pour un ou plusieurs caractères « s » consécutifs, etc.). La parenthèse permet de grouper des motifs de recherche.
				</div><div
                  class="para">
					La syntaxe précise de ces expressions varie selon l'outil qui les emploie mais les fonctionnalités de base restent les mêmes. <div
                    class="url">→ <a
                      href="http://fr.wikipedia.org/wiki/Expression_rationnelle">http://fr.wikipedia.org/wiki/Expression_rationnelle</a></div>
				</div></div><div
                class="para">
					La première vérifie l'en-tête indiquant le logiciel de courrier électronique envoyé : si elle trouve <code
                  class="literal">GOTO Sarbacane</code> (un logiciel d'envoi en masse de courriers), elle refuse le message. La seconde expression contrôle le sujet du message : s'il indique une notification de virus sans intérêt, elle accepte le message mais le supprime immédiatement.
				</div><div
                class="para">
					L'emploi de ces filtres est à double tranchant, car il est facile de les faire trop génériques et de perdre des courriers légitimes. Dans ce cas, non seulement les messages seront perdus, mais leurs expéditeurs recevront des messages d'erreur inopportuns — souvent agaçants.
				</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140565666362864"></a>11.1.4. Mise en place du <span
                      class="foreignphrase"><em
                        class="foreignphrase">greylisting</em></span></h3></div></div></div><a
              id="idm140565666361744"
              class="indexterm"></a><div
              class="para">
				“Greylisting” is a filtering technique according to which a message is initially rejected with a temporary error code, and only accepted on a further try after some delay. This filtering is particularly efficient against spam sent by the many machines infected by worms and viruses, since this software rarely acts as a full SMTP agent (by checking the error code and retrying failed messages later), especially since many of the harvested addresses are really invalid and retrying would only mean losing time.
			</div><div
              class="para">
				Postfix n'offre pas cette fonctionnalité de manière native, mais il permet d'externaliser la décision d'accepter ou rejeter un message donné. Le paquet <span
                class="pkg pkg">postgrey</span> propose justement un logiciel prévu pour s'interfacer avec ce service de délégation des politiques d'accès.
			</div><div
              class="para">
				<span
                class="pkg pkg">postgrey</span> installé, il se présente comme un démon en attente de connexions sur le port 10 023. Il suffit alors d'employer le paramètre <code
                class="literal">check_policy_service</code> comme restriction supplémentaire :
			</div><pre
              class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023
</pre><div
              class="para">
				À chaque fois que Postfix doit évaluer cette restriction, il va se connecter au démon <code
                class="command">postgrey</code> et lui envoyer des informations concernant le message concerné. De son côté, Postgrey récupère le triplet (adresse IP, expéditeur, destinataire) et regarde dans sa base de données s'il l'a déjà rencontré récemment. Si oui, il répond en ordonnant d'accepter le message, sinon il répond de le refuser temporairement et enregistre dans sa base de données le triplet en question.
			</div><div
              class="para">
				Évidemment, le grand désavantage du greylisting est qu'il va retarder la réception des courriels légitimes et parfois ces délais sont inacceptables. Il inflige également un coût important aux serveurs qui envoient de nombreux courriers légitimes.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EN PRATIQUE</em></span> Limites du greylisting</strong></p></div></div></div><div
                class="para">
				En théorie, le greylisting ne retarde que le premier courriel d'un expéditeur donné pour un destinataire donné et le délai est de l'ordre de quelques minutes à quelques dizaines de minutes. Cependant, la réalité n'est pas toujours si simple. En effet, certains gros fournisseurs d'accès emploient plusieurs serveurs SMTP en grappe et après le premier refus, rien ne garantit que le même serveur effectue la deuxième tentative. Si ce n'est pas le cas, la deuxième tentative échouera à nouveau et, au lieu d'un délai de quelques minutes, on peut constater des délais de plusieurs heures (jusqu'à ce que l'on retombe sur un serveur qui avait déjà essayé) car à chaque nouvelle erreur, le serveur SMTP augmente le délai d'attente avant le prochain essai.
			</div><div
                class="para">
				Ainsi donc, l'adresse IP entrante pour un expéditeur donné n'est pas forcément fixe dans le temps. De même, l'adresse d'un expéditeur donné n'est pas forcément fixe non plus. De nombreux logiciels de listes de diffusion encodent des informations dans l'adresse de l'expéditeur afin de traiter de manière automatisée les retours d'erreurs (<span
                  class="foreignphrase"><em
                    class="foreignphrase">bounces</em></span>). Chaque nouveau message d'une liste de diffusion peut devoir repasser par le filtre du greylisting, ce qui implique à l'émetteur de le stocker. Pour les très grosses listes avec des dizaines de milliers d'abonnés, cela peut rapidement devenir problématique.
			</div><div
                class="para">
				Pour ces raisons, Postgrey dispose d'une liste blanche de sites correspondant à ces caractéristiques. Pour ceux-là, il répond d'accepter le message immédiatement. Il est possible de la personnaliser en éditant le fichier <code
                  class="filename">/etc/postgrey/whitelist_clients</code>.
			</div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>POUR ALLER PLUS LOIN</em></span> Greylisting sélectif avec <span
                          class="pkg pkg">milter-greylist</span></strong></p></div></div></div><div
                class="para">
				Pour limiter les inconvénients du greylisting, il est possible de ne l'appliquer qu'à un sous-ensemble des clients qui sont d'ores et déjà considérés comme des sources probables de spam parce qu'ils apparaissent dans une liste noire DNS. C'est le service que propose <span
                  class="pkg pkg">whitelister</span>, un autre démon de gestion de politique d'accès pour Postfix. Cette manœuvre n'est pas prise en charge directement par Postgrey, mais le paquet <span
                  class="pkg pkg">milter-greylist</span> permet de l'effectuer.
			</div><div
                class="para">
				Comme Whitelister ne déclenche aucun refus définitif, il est possible de lui faire employer des listes noires DNS assez agressives et notamment celles qui listent toutes les adresses IP des clients des fournisseurs d'accès, comme <code
                  class="literal">pbl.spamhaus.org</code>. Cela se configure avec le paramètre <code
                  class="literal">rbl</code> dans <code
                  class="filename">/etc/whitelister.conf</code>.
			</div><div
                class="para">
				Comme <span
                  class="pkg pkg">milter-greylist</span> utilise l'interface standard de <span
                  class="emphasis"><em>milter</em></span> définie par Sendmail, la configuration du côté Postfix des choses se limite à <code
                  class="literal">smtpd_milters = unix:/var/milter-greylist/milter-greylist.sock</code>. La page de manuel <span
                  class="citerefentry"><span
                    class="refentrytitle">greylist.conf</span>(5)</span> documente le fichier <code
                  class="filename">/etc/milter-greylist/greylist.conf</code> et les différentes façons de configurer <span
                  class="pkg pkg">milter-greylist</span>.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140565666338256"></a>11.1.5. Personnalisation des filtres en fonction du destinataire</h3></div></div></div><div
              class="para">
				Les deux dernières sections ont passé en revue un grand nombre de restrictions possibles. Ces dernières servent essentiellement à limiter le nombre de spams reçus, mais elles présentent toutes des petits inconvénients. C'est pourquoi il est de plus en plus fréquent de devoir personnaliser le filtrage effectué en fonction du destinataire. Chez Falcot, le greylisting s'avérera intéressant pour la plupart des utilisateurs sauf quelques personnes dont le travail dépend de la faible latence du courrier électronique (le service d'assistance technique, par exemple). De même, le service commercial rencontre parfois des difficultés pour recevoir les réponses de certains fournisseurs asiatiques car ils sont répertoriés dans des listes noires. Ils ont donc demandé une adresse e-mail non filtrée pour pouvoir correspondre malgré tout.
			</div><div
              class="para">
				Postfix gère cela grâce à un concept de « classes de restrictions ». On référence les classes dans la variable <code
                class="literal">smtpd_restriction_classes</code> et on les définit par simple affectation tout comme on définirait <code
                class="literal">smtpd_recipient_restrictions</code>. Ensuite la directive <code
                class="literal">check_recipient_access</code> permet d'employer une table de correspondances pour définir les restrictions à employer pour un destinataire donné.
			</div><div
              class="example"><a
                id="idm140565666334112"></a><p
                class="title"><strong>Exemple 11.13. Définir des classes de restriction dans <code
                    class="filename">main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access
</pre></div></div><div
              class="example"><a
                id="idm140565666332000"></a><p
                class="title"><strong>Exemple 11.14. Fichier <code
                    class="filename">/etc/postfix/recipient_access</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting
</pre></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="sect.postfix-antivirus"></a>11.1.6. Intégration d'un antivirus</h3></div></div></div><a
              id="idm140565666328736"
              class="indexterm"></a><div
              class="para">
				Avec les nombreux virus circulant en pièce jointe des courriers électroniques, il est important de placer un antivirus à l'entrée du réseau de l'entreprise car, même après une campagne de sensibilisation sur ce sujet, certains utilisateurs cliqueront sur l'icône d'une pièce jointe liée à un message manifestement très suspect.
			</div><div
              class="para">
				L'antivirus libre retenu par les administrateurs de Falcot est <code
                class="command">clamav</code>. En plus du paquet <span
                class="pkg pkg">clamav</span>, ils ont installé les paquets <span
                class="pkg pkg">arj</span>, <span
                class="pkg pkg">unzoo</span>, <span
                class="pkg pkg">unrar</span> et <span
                class="pkg pkg">lha</span>, qui permettent aussi à l'antivirus d'analyser le contenu d'archives dans l'un de ces formats.
			</div><a
              id="idm140565666322736"
              class="indexterm"></a><a
              id="idm140565666321616"
              class="indexterm"></a><div
              class="para">
				Pour interfacer cet antivirus au serveur de messagerie, on emploiera le logiciel <code
                class="command">clamav-milter</code>. Un <span
                class="emphasis"><em>milter</em></span> (terme dérivé de l'expression <span
                class="foreignphrase"><em
                  class="foreignphrase">mail filter</em></span>) est un logiciel de filtrage de courriers spécialement conçu pour s'interfacer avec les serveurs de courriers électroniques. Les <span
                class="emphasis"><em>milters</em></span> exploitent une interface de programmation (API) dédiée qui assure de bien meilleures performances comparé aux filtres gérés en dehors des serveurs de courriers. <span
                class="emphasis"><em>Sendmail</em></span> a été le premier à introduire cette technologie mais <span
                class="emphasis"><em>Postfix</em></span> lui a emboîté le pas.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>DÉCOUVERTE</em></span> Un milter pour Spamassassin</strong></p></div></div></div><a
                id="idm140565666315920"
                class="indexterm"></a><div
                class="para">
				Le paquet <span
                  class="pkg pkg">spamass-milter</span> contient un filtre basé sur le célèbre logiciel de détection de courriels non-sollicités <span
                  class="emphasis"><em>SpamAssassin</em></span>. Il peut être employé pour marquer les messages comme des spams probables (en ajoutant un en-tête supplémentaire) et/ou pour les rejeter si le score du message dépasse une certaine limite.
			</div></div><div
              class="para">
				Une fois le paquet <span
                class="pkg pkg">clamav-milter</span> installé, le milter devrait être reconfiguré pour utiliser un port TCP plutôt que la socket nommée proposée par défaut. Lors de l'exécution de <code
                class="command">dpkg-reconfigure clamav-milter</code>, il s'agit de répondre <code
                class="literal">inet:10002@127.0.0.1</code> à la question portant sur l'interface de communication avec SEndmail.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NOTE</em></span> Vrai port TCP ou socket nommée ?</strong></p></div></div></div><div
                class="para">
				La raison pour laquelle nous utilisons un vrai port TCP plutôt qu'une socket nommée est que le démon Postfix est souvent enfermé dans un <span
                  class="foreignphrase"><em
                    class="foreignphrase">chroot</em></span> et n'a pas accès au répertoire dans lequel la socket est créée. Il serait toutefois possible de conserver l'utilisation de la socket, en modifiant son emplacement pour qu'elle soit dans le <span
                  class="foreignphrase"><em
                    class="foreignphrase">chroot</em></span> (donc sous <code
                  class="filename">/var/spool/postfix/</code>).
			</div></div><div
              class="para">
				La configuration standard de <code
                class="command">clamav</code> convient dans la majorité des situations mais <code
                class="command">dpkg-reconfigure clamav-base</code> permet de personnaliser les paramètres les plus importants.
			</div><div
              class="para">
				La dernière étape consiste à demander à Postfix d'utiliser le logiciel de filtrage que l'on vient de configurer. Cela se fait simplement en ajoutant une directive dans <code
                class="filename">/etc/postfix/main.cf</code> :
			</div><pre
              class="programlisting">
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002
</pre><div
              class="para">
				En cas de problèmes avec l'antivirus, il suffira de commenter cette ligne et d'exécuter la commande <code
                class="command">/etc/init.d/postfix reload</code> pour faire prendre en compte cette modification.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EN PRATIQUE</em></span> Tester l'antivirus</strong></p></div></div></div><div
                class="para">
				Une fois l'antivirus mis en place, il convient de vérifier qu'il opère correctement. Pour cela, le plus simple est d'envoyer un courrier électronique test avec en pièce jointe le fichier <code
                  class="filename">eicar.com</code> ou <code
                  class="filename">eicar.com.zip</code> que l'on peut récupérer en ligne : <div
                  class="url">→ <a
                    href="http://www.eicar.org/anti_virus_test_file.htm">http://www.eicar.org/anti_virus_test_file.htm</a></div>
			</div><div
                class="para">
				Il ne s'agit pas d'un vrai virus mais d'un fichier reconnu comme tel par tous les antivirus du marché afin que chacun puisse facilement vérifier que l'installation fonctionne comme prévu.
			</div></div><div
              class="para">
				Les messages traités par Postfix passent désormais systématiquement par un détecteur-filtre antivirus.
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140565666298192"></a>11.1.7. SMTP authentifié</h3></div></div></div><div
              class="para">
				Being able to send emails requires an SMTP server to be reachable; it also requires said SMTP server to send emails through it. For roaming users, this may need regularly changing the configuration of the SMTP client, since Falcot's SMTP server rejects messages coming from IP addresses apparently not belonging to the company. Two solutions exist: either the roaming user installs an SMTP server on their computer, or they still use the company server with some means of authenticating as an employee. The former solution is not recommended since the computer won't be permanently connected, and it won't be able to retry sending messages in case of problems; we will focus on the latter solution.
			</div><div
              class="para">
				L'authentification SMTP de Postfix s'appuie sur SASL (<span
                class="foreignphrase"><em
                  class="foreignphrase">Simple Authentication and Security Layer</em></span>). Il faut installer les paquets <span
                class="pkg pkg">libsasl2-modules</span> et <span
                class="pkg pkg">sasl2-bin</span>, puis il convient d'enregistrer un mot de passe dans la base SASL pour chaque utilisateur qui doit pouvoir s'authentifier sur le serveur SMTP. On utilise pour cela la commande <code
                class="command">saslpasswd2</code>. L'option <code
                class="literal">-u</code> précise le domaine d'authentification il doit correspondre au paramètre <code
                class="literal">smtpd_sasl_local_domain</code> de Postfix. L'option <code
                class="literal">-c</code> sert à créer un utilisateur et l'option <code
                class="literal">-f</code> permet de modifier une base SASL située ailleurs qu'à son emplacement standard (<code
                class="filename">/etc/sasldb2</code>).
			</div><pre
              class="screen scale">
<code
                class="computeroutput"># </code><strong
                class="userinput"><code>saslpasswd2 -h `postconf -h myhostname` -f /var/spool/postfix/etc/sasldb2 -c jean</code></strong>
<code
                class="computeroutput">[... saisir deux fois le mot de passe de jean ...]</code></pre><div
              class="para">
				Notons au passage que l'on a créé la base de données SASL dans le répertoire de Postfix. Par souci de cohérence, on va faire pointer <code
                class="filename">/etc/sasldb2</code> vers la base employée par Postfix. Cela s'effectue avec la commande <code
                class="command">ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</code>.
			</div><div
              class="para">
				Reste maintenant à configurer Postfix pour faire usage de SASL. En premier lieu, il faut ajouter l'utilisateur <code
                class="literal">postfix</code> dans le groupe <code
                class="literal">sasl</code> afin qu'il puisse accéder à la base de données des comptes SASL. Ensuite, il faut ajouter quelques paramètres pour activer SASL, puis modifier le paramètre <code
                class="literal">smtpd_recipient_restrictions</code> pour autoriser les clients authentifiés par SASL à envoyer des courriels à tous les destinataires.
			</div><div
              class="example"><a
                id="idm140565666285456"></a><p
                class="title"><strong>Exemple 11.15. Modification de <code
                    class="filename">/etc/postfix/main.cf</code> pour activer SASL</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>COMPLÉMENTS</em></span> Client SMTP authentifié</strong></p></div></div></div><div
                class="para">
				La plupart des logiciels de messagerie électronique savent désormais s'authentifier auprès d'un serveur SMTP pour expédier le courrier sortant. Il suffit de configurer les paramètres correspondants. Si ce n'est pas le cas, il est possible d'employer un serveur Postfix local et de le configurer pour relayer le courrier vers le serveur SMTP distant. Dans ce cas, Postfix sera le client dans l'authentification SASL. Voici les paramètres nécessaires :
			</div><pre
                class="programlisting">
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]
</pre><div
                class="para">
				Le fichier <code
                  class="filename">/etc/postfix/sasl_passwd</code> doit contenir le nom d'utilisateur et le mot de passe à employer pour s'authentifier sur le serveur smtp.falcot.com. Voici un exemple :
			</div><pre
                class="programlisting">
[mail.falcot.com]   joe:LyinIsji
</pre><div
                class="para">
				Comme pour toutes les tables de correspondance Postfix, il faut penser à employer <code
                  class="command">postmap</code> pour régénérer <code
                  class="filename">/etc/postfix/sasl_passwd.db</code>.
			</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>Précédent</strong>10.8. Outils de diagnostic réseau</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>Niveau supérieur</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>Sommaire</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>Suivant</strong>11.2. Serveur web (HTTP)</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/network-services.html">ar-MA</a></li><li><a
              href="../da-DK/network-services.html">da-DK</a></li><li><a
              href="../de-DE/network-services.html">de-DE</a></li><li><a
              href="../el-GR/network-services.html">el-GR</a></li><li><a
              href="../en-US/network-services.html">en-US</a></li><li><a
              href="../es-ES/network-services.html">es-ES</a></li><li><a
              href="../fa-IR/network-services.html">fa-IR</a></li><li><a
              href="../fr-FR/network-services.html">fr-FR</a></li><li><a
              href="../hr-HR/network-services.html">hr-HR</a></li><li><a
              href="../id-ID/network-services.html">id-ID</a></li><li><a
              href="../it-IT/network-services.html">it-IT</a></li><li><a
              href="../ja-JP/network-services.html">ja-JP</a></li><li><a
              href="../pl-PL/network-services.html">pl-PL</a></li><li><a
              href="../pt-BR/network-services.html">pt-BR</a></li><li><a
              href="../ro-RO/network-services.html">ro-RO</a></li><li><a
              href="../ru-RU/network-services.html">ru-RU</a></li><li><a
              href="../tr-TR/network-services.html">tr-TR</a></li><li><a
              href="../zh-CN/network-services.html">zh-CN</a></li></ul></div></body></html>
