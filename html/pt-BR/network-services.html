<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">Capítulo 11. Serviços de Rede: Postfix, Apache, NFS, Samba, Squid, LDAP</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.1" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-pt-BR-1.0-1" /><meta
        name="keywords"
        content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP" /><link
        rel="home"
        href="index.html"
        title="O Manual do Administrador Debian" /><link
        rel="up"
        href="index.html"
        title="O Manual do Administrador Debian" /><link
        rel="prev"
        href="sect.network-diagnosis-tools.html"
        title="10.8. Ferramentas de Diagnóstico de Rede" /><link
        rel="next"
        href="sect.http-web-server.html"
        title="11.2. Servidor web (HTTP)" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/pt-BR/network-services.html" /></head><body
      class="draft "><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="http://debian-handbook.info"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>Anterior</strong></a></li><li
          class="home">O Manual do Administrador Debian</li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>Próxima</strong></a></li></ul><div
        xml:lang="pt-BR"
        class="chapter"
        lang="pt-BR"><div
          class="titlepage"><div><div><h1
                class="title"><a
                  id="network-services"></a>Capítulo 11. Serviços de Rede: Postfix, Apache, NFS, Samba, Squid, LDAP</h1></div></div></div><div
          class="toc"><dl
            class="toc"><dt><span
                class="section"><a
                  href="network-services.html#sect.smtp-mail-server">11.1. Servidor de Correio Eletrônico</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="network-services.html#idm140194923405920">11.1.1. Instalando o Postfix</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140194928980576">11.1.2. Configurando Domínios Virtuais</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140194931268224">11.1.3. Restrições para Recebimento e Envio</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140194921432128">11.1.4. Configurando "listas cinzas" (<span
                        class="foreignphrase"><em
                          class="foreignphrase">greylisting</em></span>)</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140194921409600">11.1.5. Personalização de filtros baseados no destinatário</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#sect.postfix-antivirus">11.1.6. Integração com um antivírus</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140194921371344">11.1.7. SMTP autenticado</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-web-server.html">11.2. Servidor web (HTTP)</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140194921335632">11.2.1. Instalação do Apache</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140194930842800">11.2.2. Configuração de servidores virtuais</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140194930819328">11.2.3. Diretivas comuns</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140194930737696">11.2.4. Analisadores de Log</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ftp-file-server.html">11.3. Servidor de Arquivos FTP</a></span></dt><dt><span
                class="section"><a
                  href="sect.nfs-file-server.html">11.4. Servidor de Arquivos NFS</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140194930677312">11.4.1. Proteção do NFS</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140194930641664">11.4.2. Servidor NFS</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140194920341008">11.4.3. Cliente NFS</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.windows-file-server-with-samba.html">11.5. Configurando um Compartilhamento Windows com o Samba</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm140194920321824">11.5.1. Servidor Samba</a></span></dt><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm140194920272368">11.5.2. Cliente Samba</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-ftp-proxy.html">11.6. Proxy HTTP/FTP</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140194920233136">11.6.1. Instalando</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140194920228032">11.6.2. Configurando um Cache</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140194920224256">11.6.3. Configurando um Filtro</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ldap-directory.html">11.7. Diretório LDAP</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140194920201984">11.7.1. Instalando</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140194920182672">11.7.2. Preenchendo o Diretório</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140194920153648">11.7.3. Gerenciando Contas com LDAP</a></span></dt></dl></dd></dl></div><div
          class="highlights"><div
            class="para">
		Serviços de rede são programas que os usuários interagem diretamente no seu dia-a-dia. Eles são a ponta do icebergue da informação, e este capítulo foca neles; as partes escondidas nas quais eles dependem são a infraestrutura que nós já descrevemos.
	</div></div><div
          class="section"><div
            class="titlepage"><div><div><h2
                  class="title"><a
                    id="sect.smtp-mail-server"></a>11.1. Servidor de Correio Eletrônico</h2></div></div></div><div
            class="para">
			Os administradores da Falcot Corp selecionaram o Postfiz como servidor de correio eletrônico, devido a sua confiabilidade e fácil configuração. De fato, seu projeto reforça que cada tarefa é implementada em um processo com um conjunto mínimo de permissões, que é uma medida de mitigação contra problemas de segurança.
		</div><a
            id="idm140194933532640"
            class="indexterm"></a><a
            id="idm140194934235488"
            class="indexterm"></a><a
            id="idm140194937106448"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>ALTERNATIVA</em></span> O servidor Exim4</strong></p></div></div></div><a
              id="idm140194936377440"
              class="indexterm"></a><div
              class="para">
			O Debian utiliza os Exim4 como o servidor de e-mail padrão (eis o porque da instalação inicial incluir o Exim4). A configuração é provida por um pacote diferente, <span
                class="pkg pkg">exim4-config</span>, e automaticamente customizado baseado nas respostas de um conjunto de questões no Debconf muito similar as questões feitas pelo pacote <span
                class="pkg pkg">postfix</span>.
		</div><div
              class="para">
			A configuração pode ser tanto em um único arquivo (<code
                class="filename">/etc/exim4/exim4.conf.template</code>) ou divido em alguns trechos de configuração armazenados em <code
                class="filename">/etc/exim4/conf.d/</code>. Em ambos os casos, os arquivos são usados pelo <code
                class="command">update-exim4.conf</code> como modelo para gerar o <code
                class="filename">/var/lib/exim4/config.autogenerated</code>. Este último é utilizado pelo Exim4. Graças ao seu mecanismo, os valores obtidos através da configuração debconf do Exim - que é armazenado em <code
                class="filename">/etc/exim4/update-exim4.conf.conf</code> - pode ser injetado no arquivo de configuração do Exim, mesmo quando o administrador ou outro pacote alterou a configuração padrão do Exim.
		</div><div
              class="para">
			A sintaxe do arquivo de configuração do Exim4 tem suas particularidades e sua curva de aprendizado, contudo, uma vez que essas particularidades são compreendidas, o Exim4 se torna um servidor de e-mail muito completo e poderoso, como evidenciado pelas suas muitas páginas de documentação. <div
                class="url">→ <a
                  href="http://www.exim.org/docs.html">http://www.exim.org/docs.html</a></div>
		</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140194923405920"></a>11.1.1. Instalando o Postfix</h3></div></div></div><div
              class="para">
				O pacote <span
                class="pkg pkg">postfix</span> incluí um o daemon SMTP principal. Outros pacotes (como o <span
                class="pkg pkg">postfix-ldap</span> e <span
                class="pkg pkg">postfix-pgsql</span>) adicionam funcionalidades extras ao Postfix, incluindo acesso a bancos de dados. Você só deve instalá-los se souber que precisa dos mesmos.
			</div><div
              class="sidebar"><a
                id="sidebar.smtp"></a><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>DE VOLTA AO BÁSICO</em></span> SMTP</strong></p></div></div></div><a
                id="idm140194935098928"
                class="indexterm"></a><a
                id="idm140194935097968"
                class="indexterm"></a><a
                id="idm140194935097040"
                class="indexterm"></a><div
                class="para">
				SMTP (<span
                  class="emphasis"><em>Protocolo Simples para Transferência de Correio</em></span>) é um protocolo usado por servidores de e-mail para intercambiar e rotear e-mails.
			</div></div><div
              class="para">
				Diversas questões Debconf são feitas durante o processo de instalação do pacote. As respostas permitem gerar a primeira versão do arquivo de configuração <code
                class="filename">/etc/postfix/main.cf</code>.
			</div><div
              class="para">
				A primeira pergunta é sobre qual o tipo de instalação. Apenas duas das respostas propostas são relevantes no caso de um servidor conectado à Internet , "site de Internet" e "Internet com smarthost". O primeiro é apropriado para um servidor que recebe e-mails entrantes e envia e-mails saintes diretamente aos seus destinatários, e portanto é se adapta bem ao caso da Falcot Corp . o último é apropriado para um servidor que recebe e-mails recebidos normalmente, mas que envia e-mails saintes através de um servidor SMTP intermediário - o "smarthost" - ao invés de diretamente para o servidor do destinatário . Isto é útil para os indivíduos com um endereço IP dinâmico , uma vez que muitos servidores de e-mail rejeitam mensagens diretas do referido endereço IP. Neste caso, o smarthost será geralmente o servidor SMTP do ISP, que é sempre configurado para aceitar e-mail proveniente de clientes do ISP e transmiti-los de forma adequada. Esta configuração (com um smarthost) também é relevante para os servidores que não estão permanentemente conectados à internet, uma vez que se evita ter de gerenciar uma fila de mensagens não entregues que precisam ser repetida mais tarde.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>VOCABULÁRIO</em></span> ISP</strong></p></div></div></div><a
                id="idm140194937374832"
                class="indexterm"></a><div
                class="para">
				ISP é acrônico para "Internet Service Provider" (Provedor de Serviços de Internet). Isto cobre uma entidade, normalmente uma empresa, que provê conexões a internet e seus serviços básicos associados (e-mail, notícias e assim por diante).
			</div><div
                class="para">
			</div></div><div
              class="para">
				A segunda questão diz respeito ao nome completo da máquina, utilizada para gerar os endereços de e-mail a partir de um nome de usuário local; o nome completo da máquina acaba como a parte após o arroba ("@"). No caso da Falcot, a resposta deveria ser <code
                class="literal">mail.falcot.com</code>. Esta é a única pergunta feita por padrão, mas a configuração gerada não é completa o suficiente para as necessidades de Falcot, razão pela qual os administradores executam o <code
                class="command">dpkg-reconfigure postfix</code>, para personalizar mais parâmetros.
			</div><div
              class="para">
				Uma das questões extras pede para todos os nomes de domínio relacionados com esta máquina. A lista padrão inclui o seu nome completo, bem como alguns sinônimos para <code
                class="literal">localhost</code>, mas o principal domínio <code
                class="literal">falcot.com</code> precisa ser adicionado manualmente. De modo geral, esta questão deve ser respondida normalmente com todos os nomes de domínio para que esta máquina deve servir como um servidor MX; em outras palavras, todos os nomes de domínio para o qual o DNS diz que esta máquina vai aceitar e-mail. Esta informação acaba na variável <code
                class="literal">mydestination</code> do principal arquivo de configuração do Postfix - <code
                class="filename">/etc/postfix/main.cf</code>.
			</div><a
              id="idm140194928233456"
              class="indexterm"></a><a
              id="idm140194928232016"
              class="indexterm"></a><div
              class="figure"><a
                id="idm140194928230576"></a><div
                class="figure-contents"><div
                  class="mediaobject"><img
                    src="images/mail-server.png"
                    alt="Papel do registro MX no DNS ao enviar um e-mail" /></div></div><p
                class="title"><strong>Figura 11.1. Papel do registro <span
                    class="emphasis"><em>MX</em></span> no DNS ao enviar um e-mail</strong></p></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> Consultando os registros MX</strong></p></div></div></div><div
                class="para">
				Quando o DNS não contém um registro MX para o domínio, o servidor e-mail tentará enviar as mensagens para o hospedeiro em si, usando o registro correspondente A (ou AAAA em IPv6).
			</div></div><div
              class="para">
				Em alguns casos, a instalação pode perguntar quais redes devem ser permitidas a enviar e-mail usando a máquina. Em sua configuração padrão, o Postfix somente aceita e-mails vindo da máquina em si, a rede local normalmente será adicionada. Os administradores da Falcot Corp adicionaram <code
                class="literal">192.168.0.0/16</code> na pergunta padrão. Se a questão não é feita, a variável relevante no arquivo de configuração é <code
                class="literal">mynetworks</code>, como visto no exemplo abaixo.
			</div><div
              class="para">
				E-mails locais podem ser enviados através do comando <code
                class="command">procmail</code>. Esta ferramenta permite aos usuários organizarem seus e-mail de entrada de acordo com a regras armazenadas em seu arquivo <code
                class="filename">~/.procmailrc</code>.
			</div><a
              id="idm140194928221904"
              class="indexterm"></a><a
              id="idm140194928220784"
              class="indexterm"></a><a
              id="idm140194928989328"
              class="indexterm"></a><div
              class="para">
				Após este primeiro passo, os administradores conseguiram o seguinte arquivo de configuração; ele será usado como ponto de partida para adicionarmos funcionalidades extras nas próximas seções.
			</div><div
              class="example"><a
                id="idm140194928987696"></a><p
                class="title"><strong>Exemplo 11.1. Arquivo inicial <code
                    class="filename">/etc/postfix/main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SEGURANÇA</em></span> Certificados SSL <span
                          class="emphasis"><em>Snake oil</em></span></strong></p></div></div></div><div
                class="para">
				Os certificados <span
                  class="emphasis"><em>snake oil</em></span>, como o "remédio" <span
                  class="emphasis"><em>óleo de cobra</em></span> vendido por charlatães sem escrúpulos nos velhos tempos, não tem absolutamente nenhum valor, já que eles são gerados de forma semelhante em todos os sistemas Debian, com a mesma parte "privada". Eles só devem ser usados para fins de teste e, em serviço normal deve utilizar certificados reais; estes podem ser gerados com o procedimento descrito no <a
                  class="xref"
                  href="sect.virtual-private-network.html#sect.easy-rsa">Seção 10.2.1.1, “Infraestrutura de Chaves Públicas: <span
                    class="emphasis"><em>easy-rsa</em></span>”</a>.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140194928980576"></a>11.1.2. Configurando Domínios Virtuais</h3></div></div></div><a
              id="idm140194928979808"
              class="indexterm"></a><a
              id="idm140194928978368"
              class="indexterm"></a><div
              class="para">
				O servidor de e-mails pode receber e-mails de outros domínios além do domínio principal; estes são conhecidos como domínios virtuais. Na maioria dos casos quando isto ocorre, os e-mails não ultimamente destinados aos usuários locais. O Postfix provê duas funcionalidades interessantes para manipular domínios virtuais.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>ATENÇÃO</em></span> Domínios virtuais e domínios canônicos</strong></p></div></div></div><div
                class="para">
				Nenhum dos domínios virtuais deve ser referenciado na variável <code
                  class="literal">mydestination</code>; está variável somente contém os nomes "canônicos" dos domínios diretamente associados a máquina e seus usuários locais.
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140194928974320"></a>11.1.2.1. Alias de domínios virtuais</h4></div></div></div><a
                id="idm140194928200816"
                class="indexterm"></a><a
                id="idm140194928199408"
                class="indexterm"></a><div
                class="para">
					Um alias de domínio virtual contém somente aliases, isto é, endereços que encaminham unicamente os e-mails para outros endereços.
				</div><div
                class="para">
					Tal domínio é ativado ao se adicionar seu nome a variável <code
                  class="literal">virtual_alias_domains</code>, e referenciar um arquivo de mapa de endereços a variável <code
                  class="literal">virtual_alias_maps</code>.
				</div><div
                class="example"><a
                  id="idm140194928196016"></a><p
                  class="title"><strong>Exemplo 11.2. Diretivas para serem adicionadas no arquivo <code
                      class="filename">/etc/postfix/main.cf</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual
</pre></div></div><div
                class="para">
					The <code
                  class="filename">/etc/postfix/virtual</code> file describes a mapping with a rather straightforward syntax: each line contains two fields separated by whitespace; the first field is the alias name, the second field is a list of email addresses where it redirects. The special <code
                  class="literal">@domain.com</code> syntax covers all remaining aliases in a domain.
				</div><div
                class="example"><a
                  id="idm140194928192688"></a><p
                  class="title"><strong>Exemplo 11.3. Arquivo de exemplo <code
                      class="filename">/etc/postfix/virtual</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# The alias below is generic and covers all addresses within 
# the falcotsbrand.com domain not otherwise covered by this file.
# These addresses forward email to the same user name in the
# falcot.com domain.
@falcotsbrand.com           @falcot.com
</pre></div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140194928190432"></a>11.1.2.2. Domínios Virtuais de Caixa de Correio</h4></div></div></div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>ATENÇÃO</em></span> Domínio virtual combinado?</strong></p></div></div></div><div
                  class="para">
					O Postfix não permitir o uso do mesmo domínio, tanto <code
                    class="literal">virtual_alias_domains</code> e <code
                    class="literal">virtual_mailbox_domains</code>. No entanto, todos os domínios da <code
                    class="literal">virtual_mailbox_domains</code> está implicitamente incluído no <code
                    class="literal">virtual_alias_domains</code>, o que torna possível misturar aliases e caixas de correio dentro de um domínio virtual.
				</div></div><a
                id="idm140194928186144"
                class="indexterm"></a><a
                id="idm140194928185216"
                class="indexterm"></a><div
                class="para">
					As mensagens endereçadas a um domínio de caixa de correio virtual são armazenadas em caixas de correio não atribuídos a um usuário do sistema local.
				</div><div
                class="para">
					Ativando um domínio de caixa de correio virtual requer nomear este domínio na variável <code
                  class="literal">virtual_mailbox_domains</code>, e referenciar um arquivo de mapeamento de caixa de correio no <code
                  class="literal">virtual_mailbox_maps</code>. O parâmetro <code
                  class="literal">virtual_mailbox_base</code> contém o diretório sob o qual as caixas de correio serão armazenadas.
				</div><div
                class="para">
					O parâmetro <code
                  class="literal">virtual_uid_maps</code> (<code
                  class="literal">virtual_gid_maps</code> respectivamente) faz referência ao arquivo que contém o mapeamento entre o endereço de e-mail e o usuário do sistema (grupo respectivamente) que "possui" a caixa correspondente. Para obter todas as caixas de correio de propriedade do mesmo dono/grupo, a sintaxe <code
                  class="literal">static:5000</code> atribui um UID/GID fixo (de valor 5000 aqui).
				</div><div
                class="example"><a
                  id="idm140194931277504"></a><p
                  class="title"><strong>Exemplo 11.4. Diretivas para serem adicionadas no arquivo <code
                      class="filename">/etc/postfix/main.cf</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts
</pre></div></div><div
                class="para">
					Novamente, a sintaxe do arquivo <code
                  class="filename">/etc/postfix/vmailbox</code> é bastante simples: dois campos separados por espaço em branco. O primeiro campo é um endereço de e-mail dentro de um dos domínios virtuais, e o segundo campo é a localização da caixa de correio associada (relativo ao diretório especificado no <span
                  class="emphasis"><em>virtual_mailbox_base</em></span>). Se o nome da caixa de correio termina com uma barra (<code
                  class="literal">/</code>), os e-mails serão armazenados no formato <span
                  class="emphasis"><em>maildir</em></span>; caso contrário, o tradicional formato <span
                  class="emphasis"><em> mbox</em></span> será usado. O formato <span
                  class="emphasis"><em>maildir</em></span> usa um diretório inteiro para armazenar a caixa de correio, cada mensagem que está sendo armazenada em um arquivo separado. No formato <span
                  class="emphasis"><em>mbox</em></span>, por outro lado, toda a caixa de correio é armazenado em um arquivo, e cada linha começando com "<code
                  class="literal">De </code>" (<code
                  class="literal">De</code> seguido de um espaço) indica o início de uma nova mensagem.
				</div><div
                class="example"><a
                  id="idm140194931270560"></a><p
                  class="title"><strong>Exemplo 11.5. O arquivo <code
                      class="filename">/etc/postfix/vmailbox</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
# Jean's email is stored as maildir, with
# one file per email in a dedicated directory
jean@falcot.org falcot.org/jean/
# Sophie's email is stored in a traditional "mbox" file,
# with all mails concatenated into one single file
sophie@falcot.org falcot.org/sophie
</pre></div></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140194931268224"></a>11.1.3. Restrições para Recebimento e Envio</h3></div></div></div><div
              class="para">
				O crescente número de e-mails em massa não solicitados (<span
                class="emphasis"><em>spams</em></span>) requer cada vez ser mais rigoroso ao decidir quais e-mails um servidor deve aceitar. Esta seção apresenta algumas das estratégias incluídas no Postfix.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CULTURA</em></span> O problema do spam</strong></p></div></div></div><a
                id="idm140194931265184"
                class="indexterm"></a><div
                class="para">
				"Spam" é um termo genérico usado para designar todos os e-mails comerciais não solicitadas (também conhecidas como UCEs) que inundam nossas caixas de correio eletrônico; indivíduos sem escrúpulos que os enviam são conhecidos como spammers. Eles pouco se importam com o incômodo que causam já que os custos de envio de e-mail custa muito pouco e precisam somente atrair para suas ofertas uma percentagem muito pequena de quem os recebe para que a operação de spam gere mais dinheiro do que custa. O processo é praticamente todo automatizado, e qualquer endereço de e-mail tornado público (por exemplo, em um fórum na web, ou nos arquivos de uma lista de discussão, ou em um blog, e assim por diante) será descoberto pelos robôs dos spammers, e submetido para um fluxo interminável de mensagens não solicitadas.
			</div><div
                class="para">
				Todos os administradores de sistema tentam enfrentar esse incômodo com filtros de spam, mas os spammers, claro, mantém os ajustes para tentar contornar esses filtros. Alguns até mesmo alugam redes de máquinas comprometidas por um worm de vários sindicatos do crime. Estatísticas recentes estimam que até 95% de todos os e-mails que circulam na Internet são spam!
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140194931261920"></a>11.1.3.1. Restrições de Acesso Baseados no IP</h4></div></div></div><div
                class="para">
					A diretiva <code
                  class="literal">smtpd_client_restrictions</code> controla quais máquinas tem permissão para se comunicar com o servidor de e-mail.
				</div><div
                class="example"><a
                  id="idm140194931260256"></a><p
                  class="title"><strong>Exemplo 11.6. Restrições Baseadas no Endereço do Cliente</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org
</pre></div></div><div
                class="para">
					Quando uma variável contém uma lista de regras, como no exemplo acima, essas regras são avaliadas em ordem, desde a primeira até a última. Cada regra pode aceitar a mensagem, rejeitá-la, ou deixar a decisão para a seguinte regra. Como consequência, a ordem importa e simplesmente mudar duas regras pode levar a um comportamento completamente diferente.
				</div><div
                class="para">
					A diretiva <code
                  class="literal">permit_mynetworks</code>, usada como primeira regra, aceita e-mails vindos de uma máquina na rede local (como definido na variável de configuração <span
                  class="emphasis"><em>mynetworks</em></span>).
				</div><div
                class="para">
					A segunda diretiva normalmente rejeitaria e-mails provenientes de máquinas sem uma configuração de DNS completamente válido. Tal configuração válida significa que o endereço IP pode ser resolvida para um nome, e que esse nome, por sua vez, resolve o endereço IP. Essa restrição é muitas vezes demasiada rigorosa, uma vez que muitos servidores de e-mail não tem um DNS reverso para o seu endereço IP. Isso explica por que os administradores da Falcot prefixaram o modificador <code
                  class="literal">warn_if_reject</code> para a diretiva <code
                  class="literal">reject_unknown_client</code>: este modificador transforma a rejeição em uma simples advertência registrada nos logs. Os administradores podem, em seguida, manter um olho sobre o número de mensagens que seriam rejeitadas se a regra fosse realmente cumprida, e tomar uma decisão informada mais tarde, se quiser ativar essa aplicação.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>DICA</em></span> tabelas de <span
                            class="emphasis"><em>acesso</em></span></strong></p></div></div></div><div
                  class="para">
					Os critérios de restrição incluem tabelas administrativas modificáveis listando combinações de remetentes, endereços IP e nomes de host permitidos ou proibidos. Essas tabelas podem ser criadas a partir de uma cópia descompactada do <code
                    class="filename">/usr/share/doc/postfix-doc/examples/access.gz</code>. Este modelo é auto-documentado em suas observações, o que significa que cada tabela descreve sua própria sintaxe.
				</div><div
                  class="para">
					A tabela <code
                    class="filename">/etc/postfix/access_clientip</code> lista os endereços IP e redes; <code
                    class="filename">/etc/postfix/access_helo</code> lista nomes de domínio; <code
                    class="filename">/etc/postfix/access_sender</code> contém endereços de e-mail do remetente. Todos esses arquivos precisam ser transformados em tabelas-hash (um formato otimizado para acesso rápido) após cada alteração, com o comando <code
                    class="command">postmap /etc/postfix/<em
                      class="replaceable">arquivo</em></code>.
				</div></div><div
                class="para">
					A terceira diretiva permite ao administrador criar uma lista negra e uma lista branca de servidores de e-mail, armazenados em <code
                  class="filename">/etc/postfix/access_clientip</code>. Servidores na lista branca são considerados de confiança e os e-mails vindos de lá, portanto, não passam pelas regras seguintes de filtragem.
				</div><div
                class="para">
					As últimas duas regras rejeitam qualquer mensagem proveniente de um servidor listados em uma das listas negras indicadas. RBL é um acrônimo para <span
                  class="emphasis"><em>Remote Black List</em></span> (Lista Negra Remota); existem várias dessas listas, mas todas elas listam servidores mal configurados em que os spammers usam para transmitir seus e-mails, bem como encaminham e-mails inesperados bem como máquinas infectadas com worms ou vírus.
				</div><a
                id="idm140194931245904"
                class="indexterm"></a><a
                id="idm140194931244944"
                class="indexterm"></a><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>DICA</em></span> Listas brancas e RBLs</strong></p></div></div></div><div
                  class="para">
					Listas negras, por vezes, incluem um servidor legítimo que tem sofrido um incidente. Nestas situações, todos os e-mails provenientes de um desses servidores seria rejeitado a menos que o servidor esteja listado em uma lista branca definida em <code
                    class="filename">/etc/postfix/access_clientip</code>.
				</div><div
                  class="para">
					A prudência recomenda a inclusão de todos os servidores confiáveis na lista branca de onde muito e-mail são geralmente recebidos.
				</div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140194931240768"></a>11.1.3.2. Verificando a Validade dos Comandos <code
                        class="literal">EHLO</code> ou <code
                        class="literal">HELO</code></h4></div></div></div><div
                class="para">
					Toda troca SMTP começa com um comando <code
                  class="literal">HELO</code> (ou <code
                  class="literal">EHLO</code>), seguido do nome do servidor de e-mail enviante; verificar a validade deste nome pode ser interessante.
				</div><a
                id="idm140194931237696"
                class="indexterm"></a><a
                id="idm140194931236576"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140194931235456"></a><p
                  class="title"><strong>Exemplo 11.7. Restrições no nome anunciado com <code
                      class="literal">EHLO</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname
</pre></div></div><div
                class="para">
					A primeira diretiva <code
                  class="literal">permit_mynetworks</code> permite que todas as máquinas da rede local se apresentem livremente. Isso é importante, porque alguns programas de e-mail não respeitam essa parte do protocolo SMTP de forma suficientemente correta e podem se apresentar com nomes sem sentido.
				</div><div
                class="para">
					A regra <code
                  class="literal">reject_invalid_hostname</code> rejeita e-mails quando o anuncio <code
                  class="literal">EHLO</code> lista um nome de host incorreto sintaticamente. A regra <code
                  class="literal">reject_non_fqdn_hostname</code> rejeita mensagens quando o nome do host anunciado não é um nome de domínio totalmente qualificado (incluindo um nome de domínio, bem como um nome de host). A regra <code
                  class="literal">reject_unknown_hostname</code> rejeita mensagens se o nome anunciado não existe no DNS. Uma vez que esta última regra infelizmente leva a muitas rejeições,os administradores converteram seu efeito em uma simples advertência com o modificador <code
                  class="literal">warn_if_reject</code> como um primeiro passo; eles podem decidir remover este modificador em uma etapa posterior, após a auditoria dos resultados desta regra.
				</div><div
                class="para">
					Usando <code
                  class="literal">permit_mynetworks</code> como a primeira regra tem um efeito colateral interessante: as regras seguintes aplicam-se apenas aos hosts fora da rede local. Isso permite bloquear todos os hosts que se anunciam como parte do <code
                  class="literal">falcot.com</code>, por exemplo, adicionando uma linha <code
                  class="literal">falcot.com REJECT Você não é da nossa rede!</code> para o arquivo <code
                  class="filename">/etc/postfix/access_helo</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140194931226368"></a>11.1.3.3. Aceitando ou recusando baseado em remetente anunciado</h4></div></div></div><div
                class="para">
					Toda mensagem tem um remetente, anunciado pelo comando <code
                  class="literal">MAIL FROM</code> do protocolo SMTP; novamente esta informação pode ser validada de diversas maneiras.
				</div><a
                id="idm140194931224624"
                class="indexterm"></a><a
                id="idm140194931223504"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140194931222096"></a><p
                  class="title"><strong>Exemplo 11.8. Verificações do Remetente</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender
</pre></div></div><div
                class="para">
					A tabela <code
                  class="filename">/etc/postfix/access_sender</code> mapeia algum tratamento especial a alguns remetentes. Isso geralmente significa listar alguns remetentes em uma lista branca ou uma lista negra.
				</div><div
                class="para">
					A regra <code
                  class="literal">reject_unknown_sender_domain</code> exige um domínio de remetente válido, já que tal domínio é necessário para um endereço válido. A regra <code
                  class="literal">reject_unlisted_sender</code> rejeita remetentes locais se o endereço não existe; isso impede que emails sejam enviados a partir de um endereço inválido no domínio <code
                  class="literal">falcot.com</code>, e as mensagens que se originam de <code
                  class="literal">joe.bloggs@falcot.com</code> são apenas aceitas se tal endereço realmente existe.
				</div><div
                class="para">
					Finalmente, a regra <code
                  class="literal">reject_non_fqdn_sender</code> rejeita e-mails que pretendem vir de endereços sem um nome de domínio totalmente qualificado. Na prática, isso significa rejeitar e-mails vindos de um usuário <code
                  class="literal">@máquina</code>: o endereço deve ser anunciado como <code
                  class="literal">user@machine.example.com</code> ou <code
                  class="literal">user@example.com</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140194921475248"></a>11.1.3.4. Aceitando e Rejeitando Baseado no Destinatário</h4></div></div></div><div
                class="para">
					Todo e-mail tem ao menos um destinatário, anunciado com o comando <code
                  class="literal">RCPT TO</code> no protocolo SMTP. Estes endereços também são passíveis de validação, mesmo que sejam menos relevantes do que as verificações feitas no endereço do remetente.
				</div><a
                id="idm140194921473392"
                class="indexterm"></a><a
                id="idm140194921472432"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140194921471024"></a><p
                  class="title"><strong>Exemplo 11.9. Verificações pelo Destinatário</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient
</pre></div></div><div
                class="para">
					<code
                  class="literal">reject_unauth_destination</code> is the basic rule that requires outside messages to be addressed to us; messages sent to an address not served by this server are rejected. Without this rule, a server becomes an open relay that allows spammers to send unsolicited emails; this rule is therefore mandatory, and it will be best included near the beginning of the list, so that no other rules may authorize the message before its destination has been checked.
				</div><div
                class="para">
					A regra <code
                  class="literal">reject_unlisted_recipient</code> rejeita mensagens enviadas para usuários locais não-existentes, o que faz sentido. Finalmente, a regra <code
                  class="literal">reject_non_fqdn_recipient</code> rejeita endereços não totalmente qualificados; isso faz com que seja impossível para enviar um e-mail para <code
                  class="literal">jean</code> ou <code
                  class="literal">jean@máquina</code>, e em vez disso requer o uso do endereço completo, como <code
                  class="literal">jean@machine.falcot.com</code> ou <code
                  class="literal">jean@falcot.com</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140194921464448"></a>11.1.3.5. Restrições Associadas ao Comando <code
                        class="literal">DATA</code></h4></div></div></div><div
                class="para">
					O comando <code
                  class="literal">DATA</code> do SMTP é emitido antes do conteúdo da mensagem. Ele não fornece qualquer informação, por si só, além de anunciar o que vem a seguir. Pode ainda ser submetidos a verificações.
				</div><a
                id="idm140194921462224"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140194921461104"></a><p
                  class="title"><strong>Exemplo 11.10. Verificações pelo <code
                      class="literal">DATA</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_data_restrictions = reject_unauth_pipelining
</pre></div></div><div
                class="para">
					A diretiva <code
                  class="literal">reject_unauth_pipelining</code> faz com que a mensagem seja rejeitada se o remetente envia um comando antes da resposta ao comando anterior foi enviado. Isso evita uma otimização comum usada por robôs de spammers, uma vez que eles geralmente não se importam em nada pelas respostas e se concentram apenas no envio de tantos e-mails quanto possível em tão curto espaço de tempo possível.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140194921457936"></a>11.1.3.6. Aplicando as Restrições</h4></div></div></div><div
                class="para">
					Embora os comandos acima validam as informações em vários estágios de troca SMTP, o Postfix só envia uma rejeição real como uma resposta ao comando <code
                  class="literal">RCPT TO</code>.
				</div><div
                class="para">
					Isto significa que mesmo se a mensagem for rejeitada devido a um comando <code
                  class="literal">EHLO</code> inválido, o Postfix conhece o remetente e o destinatário ao anunciar a rejeição. Então ele pode registrar uma mensagem mais explícita do que ele poderia se a transação havia sido interrompida desde o início. Além disso, um número de clientes SMTP não esperam falhas nos comandos SMTP iniciais, e esses clientes serão menos perturbados por esta rejeição tardia.
				</div><div
                class="para">
					A vantagem final para esta escolha é que as regras podem acumular informação durante as várias fases do intercâmbio SMTP; este permite definir permissões mais refinadas, como a rejeição de uma conexão não-local se ele se anuncia com um remetente local.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140194921453872"></a>11.1.3.7. Filtrando Baseado no Conteúdo da Mensagem</h4></div></div></div><div
                class="para">
					The validation and restriction system would not be complete without a way to apply checks to the message contents. Postfix differentiates the checks applying to the email headers from those applying to the email body.
				</div><div
                class="example"><a
                  id="idm140194921452416"></a><p
                  class="title"><strong>Exemplo 11.11. Habilitação de filtros baseados em conteúdo</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks
</pre></div></div><a
                id="idm140194921451040"
                class="indexterm"></a><div
                class="para">
					Ambos os arquivos contêm uma lista de expressões regulares (comumente conhecido como <span
                  class="emphasis"><em>regexps</em></span> ou <span
                  class="emphasis"><em>regexes</em></span>) e ações associadas a serem acionadas quando os cabeçalhos de e-mail (ou corpo) coincidir com a expressão.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>OLHADA RÁPIDA</em></span> Tabelas de expressões regulares (regexp)</strong></p></div></div></div><div
                  class="para">
					O arquivo <code
                    class="filename">/usr/share/doc/postfix-doc/examples/header_checks.gz</code> contém muitos comentários explicativos e podem ser usados como ponto de partida para a criação dos arquivos <code
                    class="filename">/etc/postfix/header_checks</code> e <code
                    class="filename">/etc/postfix/body_checks</code>.
				</div></div><div
                class="example"><a
                  id="idm140194921444928"></a><p
                  class="title"><strong>Exemplo 11.12. Exemplos do arquivo <code
                      class="filename">/etc/postfix/header_checks</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification
</pre></div></div><div
                class="sidebar"><a
                  id="sidebar.regexp"></a><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>DE VOLTA AO BASICO</em></span> Expressão regular</strong></p></div></div></div><div
                  class="para">
					o termo <span
                    class="emphasis"><em>expressão regular</em></span> (abreviado como <span
                    class="emphasis"><em>regexp</em></span> ou <span
                    class="emphasis"><em>regex</em></span>) faz referência a uma notação genérica para expressar uma descrição do conteúdo e/ou da estrutura de um conjunto de caracteres. Alguns caracteres especiais permitem a definição de alternativas (por exemplo, <code
                    class="literal">foo|bar</code> corresponde a "foo" ou "bar"), conjuntos de caracteres permitidos (por exemplo, <code
                    class="literal">[0-9]</code> significa qualquer dígito, e <code
                    class="literal">.</code> - um ponto - significa qualquer caractere), quantificações (<code
                    class="literal">s:</code> corresponde ou <code
                    class="literal">s</code> ou a cadeia vazia, em outras palavras 0 ou 1 ocorrência de <code
                    class="literal">s</code>, <code
                    class="literal">s+</code> corresponde a um ou mais caracteres <code
                    class="literal">s</code> consecutivos, e assim por diante). Parênteses permite o agrupamento dos resultados da pesquisa.
				</div><div
                  class="para">
					A sintaxe precisa dessas expressões varia entre as ferramentas que as usam, mas as características básicas são semelhantes. <div
                    class="url">→ <a
                      href="http://en.wikipedia.org/wiki/Regular_expression">http://en.wikipedia.org/wiki/Regular_expression</a></div>
				</div></div><div
                class="para">
					O primeiro verifica o cabeçalho mencionando o software de e-mail; a mensagem será rejeitada se <code
                  class="literal">GOTO Sarbacane</code> (um software de e-mail em massa) for encontrado. A segunda expressão controla o assunto da mensagem; se menciona uma notificação de vírus, podemos decidir não rejeitar a mensagem, mas descartá-lo imediatamente.
				</div><div
                class="para">
					Usando esses filtros é uma espada de dois gumes, porque é fácil de fazer as regras demasiadamente genéricas e como consequência perder e-mails legítimos. Nestes casos, não apenas as mensagens serão perdidas, mas seus remetentes receberão mensagens de erro indesejadas (e chatas).
				</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140194921432128"></a>11.1.4. Configurando "listas cinzas" (<span
                      class="foreignphrase"><em
                        class="foreignphrase">greylisting</em></span>)</h3></div></div></div><a
              id="idm140194921430880"
              class="indexterm"></a><div
              class="para">
				“Greylisting” is a filtering technique according to which a message is initially rejected with a temporary error code, and only accepted on a further try after some delay. This filtering is particularly efficient against spam sent by the many machines infected by worms and viruses, since this software rarely acts as a full SMTP agent (by checking the error code and retrying failed messages later), especially since many of the harvested addresses are really invalid and retrying would only mean losing time.
			</div><div
              class="para">
				Postfix não fornece lista cinza nativamente, mas existe uma funcionalidade na qual a decisão de aceitar ou rejeitar uma dada mensagem pode ser delegada a um programa externo. O pacote <span
                class="pkg pkg">postgrey</span> contém tal programa, feito para ser uma interface com este serviço de delegação de políticas de acesso.
			</div><div
              class="para">
				Uma vez o <span
                class="pkg pkg">postgrey</span> estando instalado, ele roda como um daemon e ouve na porta 10023. O Postfix pode então ser configurado para usá-lo. adicionando o parâmetro <code
                class="literal">check_policy_service</code> como uma restrição extra:
			</div><pre
              class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023
</pre><div
              class="para">
				Cada vez que o Postfix alcança esta regra no conjunto de regras, ele irá se conectar ao daemon <code
                class="command">postgrey</code> e enviar a ele informações a respeito de mensagens relevantes. Do seu lado, o Postgrey, considera a tripla endereço IP/remetente/destinatário e verifica em seu banco de dados se a mesma tripla foi vista recentemente. Se sim, o Postgrey responde que a mensagem foi aceita; se não, a resposta indica que a mensagem deve ser rejeitada temporariamente, e a tripla é registrada no banco de dados.
			</div><div
              class="para">
				A principal desvantagem de listas cinza é que mensagens legítimas podem ser atrasadas, o que nem sempre é aceitável. também aumenta a carga em servidores que mandam muitos email legítimos.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NA PRÁTICA</em></span> Desvantagens das listas cinzas</strong></p></div></div></div><div
                class="para">
				Teoricamente, a lista cinza deve apenas atrasar o primeiro email de um determinado remetente para um determinado destinatário e o atraso típico é da ordem de minutos. A realidade, contudo, pode diferir ligeiramente. Alguns grandes ISPs usam clusters de servidores SMTP e quando uma mensagem é rejeitada inicialmente, o servidor que repete a transmissão pode não ser o mesmo que o inicial. Quando isso acontece, o segundo servidor obtém uma mensagem de erro temporária devido à lista cinza também e assim por diante; Pode levar várias horas até que a transmissão seja tentada por um servidor que já esteve envolvido, uma vez que servidores SMTP geralmente aumentam o intervalo entre tentativas após cada falha.
			</div><div
                class="para">
				Como consequência, o endereço IP de entrada pode variar no tempo, mesmo para um único remetente. Porém isso vai mais além: até mesmo o endereço do remetente pode mudar. Por exemplo, muitos servidores de lista de discussão (mailing-list) codificam informações extra no endereço do remetente a fim de serem capazes de lidar com mensagens de erro (conhecidas como <span
                  class="emphasis"><em>bounces</em></span>). Cada nova mensagem enviada para uma lista de discussão pode então precisar passar por uma lista cinza, O que significa que ela tem que ser armazenada (temporariamente) no servidor do remetente. Para listas de discussão muito grandes (com dezenas de milhares de assinantes), isso pode em breve tornar-se um problema.
			</div><div
                class="para">
				Para atenuar esses inconvenientes, o Postgrey gerencia uma lista branca de tais sites, e mensagens que são emanadas a partir deles são imediatamente aceitas sem passar pela lista cinza. Essa lista pode ser facilmente adaptada às necessidades locais, desde que ela seja armazenada no arquivo <code
                  class="filename">/etc/postgrey/whitelist_clients</code>.
			</div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>INDO MAIS LONGE</em></span> greylisting seletivas com <span
                          class="pkg pkg">milter-greylist</span></strong></p></div></div></div><div
                class="para">
				Os inconvenientes de uma lista cinza podem ser atenuados se a lista cinza só for usada em um subconjunto de clientes que já são considerados como prováveis fontes de spam (porque eles são listados em uma lista negra de DNS). Isso não é possível com o <span
                  class="pkg pkg">postgrey</span> mas o <span
                  class="pkg pkg">milter-greylist</span> pode ser utilizado para esse fim.
			</div><div
                class="para">
				Neste cenário, como a lista negra do DNS nunca desencadeia uma rejeição definitiva, torna-se razoável usar listas negras agressivas, incluindo aquelas que listam todos os endereços IP dinâmicos de clientes ISP (tais como <code
                  class="literal">pbl.spamhaus.org</code> ou <code
                  class="literal">dul.dnsbl.sorbs.net</code>).
			</div><div
                class="para">
				Como a milter-greylist usa a interface milter do Sendmail, a configuração do lado do postfix é limitada a "<code
                  class="literal">smtpd_milters = unix:/var/milter-greylist/milter-greylist.sock</code>”. A página de manual de <span
                  class="citerefentry"><span
                    class="refentrytitle">greylist.conf</span>(5)</span> documenta o <code
                  class="filename">/etc/milter-greylist/greylist.conf</code> e as inúmeras maneiras de configurar a milter-greylist.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140194921409600"></a>11.1.5. Personalização de filtros baseados no destinatário</h3></div></div></div><div
              class="para">
				As duas últimas seções revisaram muitas das restrições possíveis. Todas objetivam limitar a quantidade de spam recebido, mas todas têm suas desvantagens. É portanto, mais e mais comum personalizar o conjunto de filtros dependendo do destinatário. Na Falcot Corp, a lista cinza é interessante para a maioria dos usuários, mas isso dificulta o trabalho de alguns usuários que precisam de baixa latência em seus e-mails (como o serviço de suporte técnico). De maneira similar, o serviço comercial às vezes tem problemas para receber e-mails de alguns provedores asiáticos que podem constar em listas negras; este serviço pede um endereço não filtrado de modo a ser capaz de corresponder.
			</div><div
              class="para">
				O Postfix fornece tal customização de filtros com o conceito de “classe de restrição”. As classes são declaradas no parâmetro <code
                class="literal">smtpd_restriction_classes</code>, e definidas da mesma maneira como <code
                class="literal">smtpd_recipient_restrictions</code>. A diretiva <code
                class="literal">check_recipient_access</code> então define uma tabela de mapeamento de um determinado destinatário para o conjunto apropriado de restrições.
			</div><div
              class="example"><a
                id="idm140194921405600"></a><p
                class="title"><strong>Exemplo 11.13. Definição de classes de restrição em <code
                    class="filename">main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access
</pre></div></div><div
              class="example"><a
                id="idm140194921403488"></a><p
                class="title"><strong>Exemplo 11.14. O arquivo <code
                    class="filename">/etc/postfix/recipient_access</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting
</pre></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="sect.postfix-antivirus"></a>11.1.6. Integração com um antivírus</h3></div></div></div><a
              id="idm140194921400224"
              class="indexterm"></a><div
              class="para">
				Os muitos vírus circulando como anexos de e-mails fazem importante a configuração um antivírus no ponto de entrada de rede da empresa, pois mesmo após uma campanha de conscientização alguns usuários ainda abrirão anexos de mensagens obviamente obscuras.
			</div><div
              class="para">
				Os administradores da Falcot selecionaram o <code
                class="command">clamav</code> como seu antivírus livre. O pacote principal é o <span
                class="pkg pkg">clamav</span>, mas eles também instalaram alguns pacotes extras como o <span
                class="pkg pkg">arj</span>, <span
                class="pkg pkg">unzoo</span>, <span
                class="pkg pkg">unrar</span> e <span
                class="pkg pkg">lha</span>, já que eles são necessários para o antivírus poder analisar arquivos anexados em um desses formatos.
			</div><a
              id="idm140194921394128"
              class="indexterm"></a><a
              id="idm140194921393008"
              class="indexterm"></a><div
              class="para">
				A tarefa de fazer a interface entre o antivírus e o servidor de email vai para o <code
                class="command">clamav-milter</code>. Um<span
                class="emphasis"><em>milter</em></span> (abreviação de <span
                class="emphasis"><em>mail filter</em></span>) é um programa de filtragem especialmente projetado para fazer a interface com os servidores de email. O milter usa uma interface de programação de aplicativo (API) padrão que fornece uma performace muito melhor que os filtros externos para servidores de email. Os milters foram inicialmente introduzidos pelo <span
                class="emphasis"><em>Sendmail</em></span>, mas o <span
                class="emphasis"><em>Postfix</em></span> o adotou em seguida.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>OLHADA RÁPIDA</em></span> Um milter para Spamassassin</strong></p></div></div></div><a
                id="idm140194921387680"
                class="indexterm"></a><div
                class="para">
				O pacote <span
                  class="pkg pkg">spamass-milter</span> provê um milter baseado no <span
                  class="emphasis"><em>SpamAssassin</em></span>, o famoso detector de email não solicitado. Ele pode ser usado para sinalizar mensagens como prováveis spams (adicionando um cabeçalho extra) e/ou rejeitar as mensagens por completo se sua pontuação de “spam” ultrapassar um determinado limiar.
			</div></div><div
              class="para">
				Uma vez que o pacote <span
                class="pkg pkg">clamav-milter</span> esteja instalado, o milter deve ser reconfigurado para rodar em uma porta TCP ao invés do soquete nomeado padrão. Isso pode ser feito com <code
                class="command">dpkg-reconfigure clamav-milter</code>. Quando questionado pela “Communication interface with Sendmail”, responda “<code
                class="literal">inet:10002@127.0.0.1</code>”.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NOTA</em></span> Porta TCP real versus soquete nomeado</strong></p></div></div></div><div
                class="para">
				A razão porque nós usamos uma porta TCP real ao invés de um socket nomeado é que os daemons do postfix geralmente são executados em um ambiente "chrooted" e não têm acesso ao diretório que hospeda o socket nomeado. Você também poderia decidir continuar usando um socket nomeado e escolher um local dentro do ambiente "chroot" (<code
                  class="filename">/var/spool/postfix/</code>).
			</div></div><div
              class="para">
				A configuração padrão do ClamAV se encaixa na maioria das situações, mas alguns parâmetros importantes ainda podem ser customizados com <code
                class="command">dpkg-reconfigure clamav-base</code>.
			</div><div
              class="para">
				O último passo envolve informar ao Postfix para usar o filtro recém-configurado. Isso é uma simples questão de adicionar a seguinte diretiva ao <code
                class="filename">/etc/postfix/main.cf</code>:
			</div><pre
              class="programlisting">
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002
</pre><div
              class="para">
				Se o antivírus causa problemas, essa linha pode ser comentada, e o <code
                class="command">/etc/init.d/postfix reload</code> deve ser executado para que essa alteração seja levada em conta.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NA PRÁTICA</em></span> Testando o antivírus</strong></p></div></div></div><div
                class="para">
				Uma vez que o antivírus esteja configurado, seu comportamento correto deve ser testado. A maneira mais simples de fazer isso é enviar um email de teste com um anexo contendo o arquivo <code
                  class="filename">eicar.com</code> (ou <code
                  class="filename">eicar.com.zip</code>), o qual pode ser baixado online em: <div
                  class="url">→ <a
                    href="http://www.eicar.org/anti_virus_test_file.htm">http://www.eicar.org/anti_virus_test_file.htm</a></div>
			</div><div
                class="para">
				Esse arquivo não é um vírus verdadeiro, mas um arquivo teste que todos os softwares de antivírus no mercado diagnosticam como um vírus para permitir a checagem das instalações.
			</div></div><div
              class="para">
				Todas as mensagens manipuladas pelo Postfix agora passam pelo filtro de antivírus.
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140194921371344"></a>11.1.7. SMTP autenticado</h3></div></div></div><div
              class="para">
				Being able to send emails requires an SMTP server to be reachable; it also requires said SMTP server to send emails through it. For roaming users, this may need regularly changing the configuration of the SMTP client, since Falcot's SMTP server rejects messages coming from IP addresses apparently not belonging to the company. Two solutions exist: either the roaming user installs an SMTP server on their computer, or they still use the company server with some means of authenticating as an employee. The former solution is not recommended since the computer won't be permanently connected, and it won't be able to retry sending messages in case of problems; we will focus on the latter solution.
			</div><div
              class="para">
				A autenticação SMTP no Postfix se apoia no SASL (<span
                class="emphasis"><em>Simple Authentication and Security Layer</em></span>). Ela precisa dos pacotes <span
                class="pkg pkg">libsasl2-modules</span> e <span
                class="pkg pkg">sasl2-bin</span> instalados, e em seguida o registro de uma senha no banco de dados do SASL para cada usuário que precise autenticar no servidor SMTP. Isso é feito com o comando <code
                class="command">saslpasswd2</code>, o qual recebe vários parâmetros. A opção <code
                class="literal">-u</code> define o domínio de autenticação, que deve corresponder com o parâmetro <code
                class="literal">smtpd_sasl_local_domain</code> na configuração do Postfix. A opção <code
                class="literal">-c</code> permite criar um usuário, e <code
                class="literal">-f</code> permite especificar o arquivo a ser usado se o banco de dados do SASL precisar ser armazenado em um local diferente do padrão (<code
                class="filename">/etc/sasldb2</code>).
			</div><pre
              class="screen scale">
<code
                class="computeroutput"># </code><strong
                class="userinput"><code>saslpasswd2 -u `postconf -h nomedomeuhost` -f /var/spool/postfix/etc/sasldb2 -c jean</code></strong>
<code
                class="computeroutput">[... digite a senha de jean duas vezes ...]</code></pre><div
              class="para">
				Note que o banco de dados do SASL foi criado no diretório do Postfix. Para garantir consistência, nós também transformamos o <code
                class="filename">/etc/sasldb2</code> em uma ligação simbólica apontando para o banco de dados usado pelo Postfix, com o comando <code
                class="command">ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</code>.
			</div><div
              class="para">
				Agora nós precisamos configurar o Postfix para usar o SASL. Primeiro, o usuário <code
                class="literal">postfix</code> precisa ser adicionado ao grupo <code
                class="literal">sasl</code>, para que ele possa acessar a conta no banco de dados do SASL. Alguns novos parâmetros também são necessários para habilitar o SASL, e o parâmetro <code
                class="literal">smtpd_recipient_restrictions</code> precisa ser configurado para permitir que cliente autenticado pelo SASL possam enviar emails livremente.
			</div><div
              class="example"><a
                id="idm140194921358800"></a><p
                class="title"><strong>Exemplo 11.15. Ativando o SASL no <code
                    class="filename">/etc/postfix/main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> Cliente SMTP autenticado</strong></p></div></div></div><div
                class="para">
				A maioria dos clientes de e-mail são capazes de fazer autenticação em um servidor de SMTP antes de enviar mensagens de saída e usar esse recurso é uma simples questão de configurar os parâmetros apropriados. Se o cliente em uso não oferece esse recurso a solução alternativa é usar um servidor Postfix local e configurá-lo para fazer o relay do email através de um servidor SMTP remoto. Neste caso, o próprio Postfix local será o cliente que autentica com o SASL. Aqui estão os parâmetros necessários:
			</div><pre
                class="programlisting">
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]
</pre><div
                class="para">
				O arquivo <code
                  class="filename">/etc/postfix/sasl_passwd</code> precisa conter o nome de usuário e senha para autenticar no servidor <code
                  class="literal">mail.falcot.com</code>. Aqui está um exemplo:
			</div><pre
                class="programlisting">
[mail.falcot.com]   joe:LyinIsji
</pre><div
                class="para">
				Como em todos os mapeamentos do Postfix, esse arquivo tem que ser transformado em <code
                  class="filename">/etc/postfix/sasl_passwd.db</code> através do comando <code
                  class="command">postmap</code>.
			</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>Anterior</strong>10.8. Ferramentas de Diagnóstico de Rede</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>Acima</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>Principal</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>Próxima</strong>11.2. Servidor web (HTTP)</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/network-services.html">ar-MA</a></li><li><a
              href="../da-DK/network-services.html">da-DK</a></li><li><a
              href="../de-DE/network-services.html">de-DE</a></li><li><a
              href="../el-GR/network-services.html">el-GR</a></li><li><a
              href="../en-US/network-services.html">en-US</a></li><li><a
              href="../es-ES/network-services.html">es-ES</a></li><li><a
              href="../fa-IR/network-services.html">fa-IR</a></li><li><a
              href="../fr-FR/network-services.html">fr-FR</a></li><li><a
              href="../hr-HR/network-services.html">hr-HR</a></li><li><a
              href="../id-ID/network-services.html">id-ID</a></li><li><a
              href="../it-IT/network-services.html">it-IT</a></li><li><a
              href="../ja-JP/network-services.html">ja-JP</a></li><li><a
              href="../pl-PL/network-services.html">pl-PL</a></li><li><a
              href="../pt-BR/network-services.html">pt-BR</a></li><li><a
              href="../ro-RO/network-services.html">ro-RO</a></li><li><a
              href="../ru-RU/network-services.html">ru-RU</a></li><li><a
              href="../tr-TR/network-services.html">tr-TR</a></li><li><a
              href="../zh-CN/network-services.html">zh-CN</a></li></ul></div></body></html>
