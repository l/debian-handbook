<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">10.2. Виртуальная частная сеть</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-9-ru-RU-1.0-1" /><meta
        name="keywords"
        content="Сеть, Шлюз, TCP/IP, IPv6, DNS, Bind, DHCP, QoS" /><link
        rel="home"
        href="index.html"
        title="Настольная книга администратора Debian" /><link
        rel="up"
        href="network-infrastructure.html"
        title="Глава 10. Сетевая инфраструктура" /><link
        rel="prev"
        href="network-infrastructure.html"
        title="Глава 10. Сетевая инфраструктура" /><link
        rel="next"
        href="sect.quality-of-service.html"
        title="10.3. Quality of Service" /><meta
        name="viewport"
        content="width=device-width, initial-scale=1" /><meta
        name="flattr:id"
        content="4pz9jq" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/ru-RU/sect.virtual-private-network.html" /></head><body><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="../../"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="network-infrastructure.html"><strong>Пред.</strong></a></li><li
          class="home">Настольная книга администратора Debian</li><li
          class="next"><a
            accesskey="n"
            href="sect.quality-of-service.html"><strong>След.</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  id="sect.virtual-private-network"></a>10.2. Виртуальная частная сеть</h2></div></div></div><div
          class="para">
			<span
            class="emphasis"><em>Виртуальная частная сеть</em></span> (VPN) предоставляет возможность контакта для двух локальных сетей через интернет, используя туннель. Туннель обычно зашифрован для конфиденциальности. VPN сети часто используются для интеграции удалённой машины в локальную сеть компании.
		</div><a
          id="id-1.13.5.3"
          class="indexterm"></a><a
          id="id-1.13.5.4"
          class="indexterm"></a><a
          id="id-1.13.5.5"
          class="indexterm"></a><div
          class="para">
			Существуют несколько инструментов для организации такой сети. OpenVPN — это эффективное решение, легкое для развёртывания и поддержки, основано на SSL/TLS. Другая возможность состоит в использовании IPsec для шифрования IP трафика между двумя машинами. Такое шифрование прозрачно, это означает что приложения, запущенные на таких хостах не нуждаются в изменениях для добавления VPN в аккаунт. SSH, в дополнение к традиционным возможностям, также может использоваться как VPN. Наконец, VPN можно создать, используя протокол Microsoft PPTP. Существуют иные способы, которые остались за рамками этой книги.
		</div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.openvpn"></a>10.2.1. OpenVPN</h3></div></div></div><a
            id="id-1.13.5.7.2"
            class="indexterm"></a><div
            class="para">
				OpenVPN используется для создания виртуальных частных сетей. В его настройку входит создание частных сетевых интерфейсов на VPN сервере и на клиенте (клиентах). Оба <code
              class="literal">tun</code> (для туннелей уровня IP) и <code
              class="literal">tap</code> (для туннелей уровня Ethernet) интерфейса поддерживаются. На практике <code
              class="literal">tun</code> используется чаще, за исключением необходимости интеграции VPN клиентов в локальную сеть сервера через Ethernet мост.
			</div><div
            class="para">
				Для использования SSL/TLS криптографии и смежных возможностей (конфиденциальность, аутентификация, целостность, неапеллируемость) OpenVPN полагается на OpenSSL. Конфигурация осуществляется с помощью общего секретного ключа или используя сертификаты X.509, основанные на инфраструктуре публичного ключа.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>КУЛЬТУРА</em></span> SSL и TLS</strong></p></div></div></div><a
              id="id-1.13.5.7.5.2"
              class="indexterm"></a><a
              id="id-1.13.5.7.5.3"
              class="indexterm"></a><div
              class="para">
				Протокол SSL (<span
                class="emphasis"><em> уровень защищённых cокетов</em></span>) был разработан Netscape для защиты соединений веб-серверов. Позднее он был стандартизирован IETF под акронимом TLS (<span
                class="emphasis"><em> безопасность транспортного уровня</em></span>). TLS продолжает развиваться и по сей день, в то время как SSL не используется из-за множества недостатков в дизайне.
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="sect.easy-rsa"></a>10.2.1.1. Инфраструктура открытых ключей: <span
                      class="emphasis"><em>easy-rsa</em></span></h4></div></div></div><a
              id="id-1.13.5.7.6.2"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.3"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.4"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.5"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.6"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.7"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.8"
              class="indexterm"></a><div
              class="para">
					Алгоритм RSA широко используется в криптографии публичного ключа. Он включает «пару ключей», содержащую частный и публичный ключ. Два ключа тесно связаны между собой и их математические свойства тоже, например, сообщение зашифрованное с публичным ключом может быть расшифровано тем, кто знает частный ключ, что обеспечивает конфиденциальность. Наоборот, сообщение, зашифрованное с частным ключом, может расшифровать любой, знающий публичный ключ — это гарантия установления подлинности сообщения, т. к. создать такое мог только человек с доступом к частному ключу. Если есть связь с цифровой хэш-функцией (MD5, SHA1 или более современные), то это механизм подписи, который может быть применён к любому сообщению.
				</div><div
              class="para">
					Однако кто угодно может создать пару ключей, наполнить её любой информацией, касаемой индивидуальных данных какого-либо лица, и притвориться в любой момент, что он и есть та или иная "личность". Чтобы исключить такие ситуации, было решено создать Центр сертификации (открытых публичных ключей) - <span
                class="emphasis"><em>Certification Authority</em></span> (CA), работающий по стандарту X.509. Смысл в том, что данному центру доверяют хранить одну половинку ключа, известной как <span
                class="emphasis"><em>root certificate</em></span> (доверенный корневой сертификат). Этот сертификат (открытый публичный ключ) используется только для подписания других сертификатов (одной половины ключа от пары), после выполнения предварительных действий по подтверждению подлинности личности (организаций и физических лиц), сохраняемой в паре ключей. Программы, использующие X.509 могут затем проверить сертификаты, представленные им, при этом они должны знать о доверенных корневых сертификатах.
				</div><div
              class="para">
					OpenVPN придерживается этого правила. Поскольку публичные CA выпускают сертификаты только в обмен за деньги (здоровéнные), OpenVPN может создать свой приватный центр сертификации, авторизированный внутри компании (то есть независимый локальный центр сертификации) и выдавать самоподписанные сертификаты (то есть открытые публичные ключи). Пакет <span
                class="pkg pkg">easy-rsa</span> включает в себя инструменты, с помощью которых можно управлять инфраструктурой сертификации X.509, а также они включают в себя сценарии с использованием команды <code
                class="command">openssl</code>.
				</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>ЗАМЕТКА</em></span> <span
                          class="emphasis"><em>easy-rsa</em></span> до создания дистибутива <span
                          class="distribution distribution">Jessie</span></strong></p></div></div></div><div
                class="para">
					В более ранних версиях Debian, до <span
                  class="distribution distribution">Wheezy</span>, <span
                  class="emphasis"><em>easy-rsa</em></span> распространялся как часть пакета <span
                  class="pkg pkg">openvpn</span>, а месторасположение его сценариев было в <code
                  class="filename">/usr/share/doc/openvpn/examples/easy-rsa/2.0/</code>. Настройка CA включала в себя копирование этого каталога, тогда как сейчас используется команда <code
                  class="command">make-cadir</code>, как описано здесь.
				</div></div><div
              class="para">
					Администраторы Falcot Corp используют этот инструмент для создания нужных сертификатов, для обеих сторон - для сервера и клиентов. Это позволяет настраивать всех клиентов похожим образом, поскольку на клиентах надо только установить, чтобы они считали доверенными сертификатами те, что были выданы локальным CA, расположенным в Falcot. Этот CA в Falcot имеет порядковый номер - первый сертификат, который он выдал сам себе в самом начале своей работы. Для учёта и хранения выдаваемых сертификатов администраторы создают каталог с нужными файлами для CA в подходящем месте, предпочтительнее на машине, не подсоединённой к сети. Это делается для того, чтобы уменьшить риск кражи закрытых ключей, выданных локальным CA.
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>make-cadir pki-falcot
</code></strong><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>cd pki-falcot</code></strong></pre><div
              class="para">
					Нужные опции располагаются в файле <code
                class="filename">vars</code>, особенно те, что имеют в качестве приставки к словам <code
                class="literal">KEY_</code>; эти переменные затем интегрируются в в окружающую среду:
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>vim vars
</code></strong><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>grep KEY_ vars
</code></strong><code
                class="computeroutput">export KEY_CONFIG=`$EASY_RSA/whichopensslcnf $EASY_RSA`
export KEY_DIR="$EASY_RSA/keys"
echo NOTE: If you run ./clean-all, I will be doing a rm -rf on $KEY_DIR
export KEY_SIZE=2048
export KEY_EXPIRE=3650
export KEY_COUNTRY="FR"
export KEY_PROVINCE="Loire"
export KEY_CITY="Saint-Étienne"
export KEY_ORG="Falcot Corp"
export KEY_EMAIL="admin@falcot.com"
export KEY_OU="Certificate authority"
export KEY_NAME="Certificate authority for Falcot Corp"
# If you'd like to sign all keys with the same Common Name, uncomment the KEY_CN export below
# export KEY_CN="CommonName"
$ </code><strong
                class="userinput"><code>. ./vars
</code></strong><code
                class="computeroutput">NOTE: If you run ./clean-all, I will be doing a rm -rf on /home/roland/pki-falcot/keys
$ </code><strong
                class="userinput"><code>./clean-all
</code></strong></pre><div
              class="para">
					Следующим шагом является создание пары к ключу CA (то есть приватного ключа), то есть самому себе (при выполнении этого шага обе части ключа, или "пара", будут размещены под именами <code
                class="filename">keys/ca.crt</code> и <code
                class="filename">keys/ca.key</code>):
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-ca</code></strong>
<code
                class="computeroutput">Generating a 2048 bit RSA private key
....................................................................+++
...+++
writing new private key to 'ca.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:
Common Name (eg, your name or your server's hostname) [Falcot Corp CA]:
Name [Certificate authority for Falcot Corp]:
Email Address [admin@falcot.com]:
</code></pre><div
              class="para">
					А сейчас можно создать сертификат для сервера VPN, при необходимости активизировать и протокол Диффи-Хелмана для серверной стороны соединения по SSL/TLS. VPN сервер идентифицируется по его DNS имени <code
                class="literal">vpn.falcot.com</code>; это имя будет использоваться в дальнейшем для создания файлов ключей (<code
                class="filename">keys/vpn.falcot.com.crt</code> - для публичного сертификата - первой половинки ключа, <code
                class="filename">keys/vpn.falcot.com.key</code> - для закрытого ключа - второй половинки):
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-key-server vpn.falcot.com
</code></strong><code
                class="computeroutput">Generating a 2048 bit RSA private key
.....................................................................................................................+++
...........+++
writing new private key to 'vpn.falcot.com.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:
Common Name (eg, your name or your server's hostname) [vpn.falcot.com]:
Name [Certificate authority for Falcot Corp]:
Email Address [admin@falcot.com]:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
Using configuration from /home/roland/pki-falcot/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'FR'
stateOrProvinceName   :PRINTABLE:'Loire'
localityName          :T61STRING:'Saint-\0xFFFFFFC3\0xFFFFFF89tienne'
organizationName      :PRINTABLE:'Falcot Corp'
organizationalUnitName:PRINTABLE:'Certificate authority'
commonName            :PRINTABLE:'vpn.falcot.com'
name                  :PRINTABLE:'Certificate authority for Falcot Corp'
emailAddress          :IA5STRING:'admin@falcot.com'
Certificate is to be certified until Mar  6 14:54:56 2025 GMT (3650 days)
Sign the certificate? [y/n]:</code><strong
                class="userinput"><code>y
</code></strong><code
                class="computeroutput">

1 out of 1 certificate requests certified, commit? [y/n]</code><strong
                class="userinput"><code>y
</code></strong><code
                class="computeroutput">Write out database with 1 new entries
Data Base Updated
$ </code><strong
                class="userinput"><code>./build-dh
</code></strong><code
                class="computeroutput">Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
[…]
</code></pre><div
              class="para">
					Следующим шагом создаются сертификаты для клиентов VPN; один сертификат нужен каждому компьютеру или лицу, которым позволено использовать VPN:
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-key JoeSmith
</code></strong><code
                class="computeroutput">Generating a 2048 bit RSA private key
................................+++
..............................................+++
writing new private key to 'JoeSmith.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:</code><strong
                class="userinput"><code>Development unit
</code></strong><code
                class="computeroutput">Common Name (eg, your name or your server's hostname) [JoeSmith]:</code><strong
                class="userinput"><code>Joe Smith
</code></strong><code
                class="computeroutput">[…]</code></pre><div
              class="para">
					Now all certificates have been created, they need to be copied where appropriate: the root certificate's public key (<code
                class="filename">keys/ca.crt</code>) will be stored on all machines (both server and clients) as <code
                class="filename">/etc/ssl/certs/Falcot_CA.crt</code>. The server's certificate is installed only on the server (<code
                class="filename">keys/vpn.falcot.com.crt</code> goes to <code
                class="filename">/etc/ssl/vpn.falcot.com.crt</code>, and <code
                class="filename">keys/vpn.falcot.com.key</code> goes to <code
                class="filename">/etc/ssl/private/vpn.falcot.com.key</code> with restricted permissions so that only the administrator can read it), with the corresponding Diffie-Hellman parameters (<code
                class="filename">keys/dh2048.pem</code>) installed to <code
                class="filename">/etc/openvpn/dh2048.pem</code>. Client certificates are installed on the corresponding VPN client in a similar fashion.
				</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="id-1.13.5.7.7"></a>10.2.1.2. Настройка сервера OpenVPN</h4></div></div></div><div
              class="para">
					По умолчанию, при первоначальном запуске OpenVPN сценарий пытается запустить все виртуальные частные сети, описанные в файле <code
                class="filename">/etc/openvpn/*.conf</code>. Поэтому важно, настраивая VPN сервер, располагать соответствующие файлы конфигурации в этом каталоге. Хорошей отправной точкой может быть <code
                class="filename">/usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz</code>, в котором приведён довольно стандартный сервер. Конечно, некоторые опции нуждаются в уточнении: <code
                class="literal">ca</code>, <code
                class="literal">cert</code>, <code
                class="literal">key</code> и <code
                class="literal">dh</code> нужны для описания выбранного местоположения (соответственно, <code
                class="literal">/etc/ssl/certs/Falcot_CA.crt</code>, <code
                class="literal">/etc/ssl/vpn.falcot.com.crt</code>, <code
                class="literal">/etc/ssl/private/vpn.falcot.com.key</code> и <code
                class="literal">/etc/openvpn/dh2048.pem</code>). Директива <code
                class="literal">server 10.8.0.0 255.255.255.0</code> определяет подсеть, которая будет использоваться для VPN; сервер использует первый IP адрес в этом диапазоне (<code
                class="literal">10.8.0.1</code>), а остальные адреса распределяются клиентам.
				</div><div
              class="para">
					С этой конфигурацией, запущенный OpenVPN создаёт виртуальный сетевой интерфейс, обычно под именем <code
                class="literal">tun0</code>. Однако, брандмауэры часто настраиваются в одно время с настройкой реальных сетевых интерфейсов, и это обычно происходит ранее, до старта OpenVPN. Поэтому, уже имеющийся хороший опыт использования связки OpenVPN+брандмауэр рекомендует создать постоянный виртуальный сетевой интерфейс, и настроить OpenVPN использовать этот интерфейс. Тогда в будущем, можно будет подобрать имя для этого интерфейса. С этой целью, <code
                class="command">openvpn --mktun --dev vpn --dev-type tun</code> создаст виртуальный сетевой интерфейс, назвав его <code
                class="literal">vpn</code> с типом <code
                class="literal">tun</code>. Эта команда может быть быстро включена в сценарий настройки брэндмауэра, или в директиву <code
                class="literal">up</code> файла <code
                class="filename">/etc/network/interfaces</code>. Конфигурационный файл OpenVPN должен быть также обновлён соответствующим образом, с директивами <code
                class="literal">dev vpn</code> и <code
                class="literal">dev-type tun</code>.
				</div><div
              class="para">
					Для исключения отдалённых последствий, клиенты VPN могут только получать доступ к серверу VPN через адрес <code
                class="literal">10.8.0.1</code>. Для предоставления клиентам доступа в локальную сеть (192.168.0.0/24), необходимо добавить директиву <code
                class="literal">push route 192.168.0.0 255.255.255.0</code> в конфигурацию OpenVPN, тогда клиенты VPN автоматически получат уведомление о том, что сетевая маршрутизация к этой сети осуществляется через VPN. Кроме того, машины в локальной сети также должны быть информированы о том, что маршрутизация пакетов VPN должна осуществляться через сервер VPN (в случае установки сервера VPN на шлюз это происходит автоматически). И как альтернатива, сервер VPN можно настроить с возможностью использования IP masquerading (трансляция - замена одних IP на другие) таким образом, что соединения, приходящие от клиентов VPN будут появляться так, как будто они пришли с сервера VPN взамен (смотри вкладку <a
                class="xref"
                href="network-infrastructure.html#sect.gateway">Раздел 10.1, «Шлюз»</a>).
				</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="id-1.13.5.7.8"></a>10.2.1.3. Настройка клиента OpenVPN</h4></div></div></div><div
              class="para">
					При настройке клиента OpenVPN нужно тоже создать конфигурационный файл, поместив его в <code
                class="filename">/etc/openvpn/</code>. Стандартная конфигурация, которую можно принять за основу, расположена в примерах по адресу <code
                class="filename">/usr/share/doc/openvpn/examples/sample-config-files/client.conf</code>. Директива <code
                class="literal">remote vpn.falcot.com 1194</code> описывает адрес и порт сервера OpenVPN; <code
                class="literal">ca</code>, <code
                class="literal">cert</code> и <code
                class="literal">key</code> также нуждаются в редактировании описаний с уточнением месторасположения файлов ключей.
				</div><div
              class="para">
					Если нет необходимости запускать VPN сразу, при загрузке системы автоматически, то надо установить для директивы <code
                class="literal">AUTOSTART</code> опцию <code
                class="literal">none</code> в файле <code
                class="filename">/etc/default/openvpn</code>. Запуск и остановка данного соединения VPN всегда можно выполнить вручную командами <code
                class="command">service openvpn@<em
                  class="replaceable">name</em> start</code> и <code
                class="command">service openvpn@<em
                  class="replaceable">name</em> stop</code> (где название соединения <em
                class="replaceable">name</em> подходит к одному из определённых в файле <code
                class="filename">/etc/openvpn/<em
                  class="replaceable">name</em>.conf</code>).
				</div><div
              class="para">
					Пакет <span
                class="pkg pkg">network-manager-openvpn-gnome</span> содержит расширения для Менеджера Сети (смотри вкладку <a
                class="xref"
                href="sect.network-config.html#sect.roaming-network-config">Раздел 8.2.5, «Автоматическая настройки сети для мобильных пользователей»</a>), что позволяет управлять виртуальными частными сетями OpenVPN. С их помощью каждый пользователь может настраивать соединения OpenVPN в графическом виде и контролировать их из иконки сетевого управления. <a
                id="id-1.13.5.7.8.4.3"
                class="indexterm"></a>
				</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.ssh-vpn"></a>10.2.2. Виртуальные Частные Сети с SSH</h3></div></div></div><a
            id="id-1.13.5.8.2"
            class="indexterm"></a><a
            id="id-1.13.5.8.3"
            class="indexterm"></a><div
            class="para">
				В настоящее время фактически существуют два способа создания частных виртуальных сетей, использующих SSH. Исторически так сложилось, что одно из этих решений предполагает использование слоя PPP поверх соединения SSH. Этот вариант описывается в документе HOWTO: <div
              class="url">→ <a
                href="http://www.tldp.org/HOWTO/ppp-ssh/">http://www.tldp.org/HOWTO/ppp-ssh/</a></div>
			</div><div
            class="para">
				Второй способ является более современным, и был введён с появлением OpenSSH 4.3; теперь стало возможным для OpenSSH создание виртуальных сетевых интерфейсов (<code
              class="literal">tun*</code>) на обеих сторонах соединения SSH, и эти виртуальные интерфейсы можно настраивать так, как будто они являются физическими интерфейсами. Первоначально необходимо разрешить создание тунельной системы путём установки для <code
              class="literal">PermitTunnel</code> опции “yes” в конфигурационном файле сервера SSH(<code
              class="filename">/etc/ssh/sshd_config</code>). При устанавлении соединения SSH, необходимо ясно выразить желание создать тунель с опцией <code
              class="literal">-w any:any</code> (<code
              class="literal">any</code> может быть заменено на уже имеющееся в системе устройство с номером <code
              class="literal">tun</code>). Такое решение требует наличия на обеих сторонах соединения SSH у пользователя прав администратора, так как необходимо создавать сетевые устройства (другими словами, соединение должно устанавливаться администратором).
			</div><div
            class="para">
				Оба метода создания виртуальных частных сетей через SSH довольно просты. Однако, VPN поддерживает такие соединения не очень эффективно; в частности, не достигается высокий уровень скорости прохождения трафика, как бы хотелось.
			</div><div
            class="para">
				Объясняется это тем, что когда стек TCP/IP инкапсулируется внутрь соединения TCP/IP (для SSH), то протокол TCP используется дважды, сначала для соединения по SSH и затем уже внутри самого туннеля. Это приводит к проблемам, особенно из-за особенностей TCP подстраиваться под состояние сети путем изменения задержки тайм-аута. Следующий сайт описывает проблему более детально: <div
              class="url">→ <a
                href="http://sites.inka.de/sites/bigred/devel/tcp-tcp.html">http://sites.inka.de/sites/bigred/devel/tcp-tcp.html</a></div> Поэтому соединение VPN через SSH должно быть ограничено созданием разовых туннелей без ограничения производительности.
			</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.ipsec"></a>10.2.3. IPsec</h3></div></div></div><a
            id="id-1.13.5.9.2"
            class="indexterm"></a><a
            id="id-1.13.5.9.3"
            class="indexterm"></a><a
            id="id-1.13.5.9.4"
            class="indexterm"></a><div
            class="para">
				IPsec, despite being the standard in IP VPNs, is rather more involved in its implementation. The IPsec engine itself is integrated in the Linux kernel; the required user-space parts, the control and configuration tools, are provided by the <span
              class="pkg pkg">ipsec-tools</span> package. In concrete terms, each host's <code
              class="filename">/etc/ipsec-tools.conf</code> contains the parameters for <span
              class="emphasis"><em>IPsec tunnels</em></span> (or <span
              class="emphasis"><em>Security Associations</em></span>, in the IPsec terminology) that the host is concerned with; the <code
              class="command">/etc/init.d/setkey</code> script provides a way to start and stop a tunnel (each tunnel is a secure link to another host connected to the virtual private network). This file can be built by hand from the documentation provided by the <span
              class="citerefentry"><span
                class="refentrytitle">setkey</span>(8)</span> manual page. However, explicitly writing the parameters for all hosts in a non-trivial set of machines quickly becomes an arduous task, since the number of tunnels grows fast. Installing an IKE daemon (for <span
              class="emphasis"><em>IPsec Key Exchange</em></span>) such as <span
              class="pkg pkg">racoon</span> or <span
              class="pkg pkg">strongswan</span> makes the process much simpler by bringing administration together at a central point, and more secure by rotating the keys periodically.
			</div><a
            id="id-1.13.5.9.6"
            class="indexterm"></a><a
            id="id-1.13.5.9.7"
            class="indexterm"></a><a
            id="id-1.13.5.9.8"
            class="indexterm"></a><a
            id="id-1.13.5.9.9"
            class="indexterm"></a><div
            class="para">
				In spite of its status as the reference, the complexity of setting up IPsec restricts its usage in practice. OpenVPN-based solutions will generally be preferred when the required tunnels are neither too many nor too dynamic.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CAUTION</em></span> IPsec and NAT</strong></p></div></div></div><div
              class="para">
				NATing firewalls and IPsec do not work well together: since IPsec signs the packets, any change on these packets that the firewall might perform will void the signature, and the packets will be rejected at their destination. Various IPsec implementations now include the <span
                class="emphasis"><em>NAT-T</em></span> technique (for <span
                class="emphasis"><em>NAT Traversal</em></span>), which basically encapsulates the IPsec packet within a standard UDP packet.
			</div><a
              id="id-1.13.5.9.11.3"
              class="indexterm"></a><a
              id="id-1.13.5.9.11.4"
              class="indexterm"></a></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>SECURITY</em></span> IPsec and firewalls</strong></p></div></div></div><div
              class="para">
				The standard mode of operation of IPsec involves data exchanges on UDP port 500 for key exchanges (also on UDP port 4500 in the case that NAT-T is in use). Moreover, IPsec packets use two dedicated IP protocols that the firewall must let through; reception of these packets is based on their protocol numbers, 50 (ESP) and 51 (AH).
			</div><a
              id="id-1.13.5.9.12.3"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.4"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.5"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.6"
              class="indexterm"></a></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.pptp"></a>10.2.4. PPTP</h3></div></div></div><div
            class="para">
				PPTP (for <span
              class="emphasis"><em>Point-to-Point Tunneling Protocol</em></span>) uses two communication channels, one for control data and one for payload data; the latter uses the GRE protocol (<span
              class="emphasis"><em>Generic Routing Encapsulation</em></span>). A standard PPP link is then set up over the data exchange channel.
			</div><a
            id="id-1.13.5.10.3"
            class="indexterm"></a><a
            id="id-1.13.5.10.4"
            class="indexterm"></a><a
            id="id-1.13.5.10.5"
            class="indexterm"></a><a
            id="id-1.13.5.10.6"
            class="indexterm"></a><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="sect.pptp-config-client"></a>10.2.4.1. Configuring the Client</h4></div></div></div><div
              class="para">
					The <span
                class="pkg pkg">pptp-linux</span> package contains an easily-configured PPTP client for Linux. The following instructions take their inspiration from the official documentation: <div
                class="url">→ <a
                  href="http://pptpclient.sourceforge.net/howto-debian.phtml">http://pptpclient.sourceforge.net/howto-debian.phtml</a></div>
				</div><a
              id="id-1.13.5.10.7.3"
              class="indexterm"></a><div
              class="para">
					The Falcot administrators created several files: <code
                class="filename">/etc/ppp/options.pptp</code>, <code
                class="filename">/etc/ppp/peers/falcot</code>, <code
                class="filename">/etc/ppp/ip-up.d/falcot</code>, and <code
                class="filename">/etc/ppp/ip-down.d/falcot</code>.
				</div><div
              class="example"><a
                id="example.ppp-options.pptp"></a><p
                class="title"><strong>Пример 10.2. Файл <code
                    class="filename">/etc/ppp/options.pptp</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# PPP options used for a PPTP connection
lock
noauth
nobsdcomp
nodeflate
</pre></div></div><div
              class="example"><a
                id="example.ppp-peers-falcot"></a><p
                class="title"><strong>Пример 10.3. Файл <code
                    class="filename">/etc/ppp/peers/falcot</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# vpn.falcot.com is the PPTP server
pty "pptp vpn.falcot.com --nolaunchpppd"
# the connection will identify as the "vpn" user
user vpn
remotename pptp
# encryption is needed
require-mppe-128
file /etc/ppp/options.pptp
ipparam falcot
</pre></div></div><div
              class="example"><a
                id="example.ppp-ip-up.d-falcot"></a><p
                class="title"><strong>Пример 10.4. Файл <code
                    class="filename">/etc/ppp/ip-up.d/falcot</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Create the route to the Falcot network
if [ "$6" = "falcot" ]; then
  # 192.168.0.0/24 is the (remote) Falcot network
  route add -net 192.168.0.0 netmask 255.255.255.0 dev $1
fi
</pre></div></div><div
              class="example"><a
                id="example.ppp-ip-down.d-falcot"></a><p
                class="title"><strong>Пример 10.5. Файл <code
                    class="filename">/etc/ppp/ip-down.d/falcot</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Delete the route to the Falcot network
if [ "$6" = "falcot" ]; then
  # 192.168.0.0/24 is the (remote) Falcot network
  route del -net 192.168.0.0 netmask 255.255.255.0 dev $1
fi
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>БЕЗОПАСНОСТЬ</em></span> MPPE</strong></p></div></div></div><div
                class="para">
					Securing PPTP involves using the MPPE feature (<span
                  class="emphasis"><em>Microsoft Point-to-Point Encryption</em></span>), which is available in official Debian kernels as a module.
				</div><a
                id="id-1.13.5.10.7.9.3"
                class="indexterm"></a><a
                id="id-1.13.5.10.7.9.4"
                class="indexterm"></a></div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="sect.pptp-config-serveur"></a>10.2.4.2. Настройка сервера</h4></div></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CAUTION</em></span> PPTP and firewalls</strong></p></div></div></div><div
                class="para">
					Intermediate firewalls need to be configured to let through IP packets using protocol 47 (GRE). Moreover, the PPTP server's port 1723 needs to be open so that the communication channel can happen.
				</div></div><div
              class="para">
					<code
                class="command">pptpd</code> is the PPTP server for Linux. Its main configuration file, <code
                class="filename">/etc/pptpd.conf</code>, requires very few changes: <span
                class="emphasis"><em>localip</em></span> (local IP address) and <span
                class="emphasis"><em>remoteip</em></span> (remote IP address). In the example below, the PPTP server always uses the <code
                class="literal">192.168.0.199</code> address, and PPTP clients receive IP addresses from <code
                class="literal">192.168.0.200</code> to <code
                class="literal">192.168.0.250</code>.
				</div><div
              class="example"><a
                id="example.pptpd.conf"></a><p
                class="title"><strong>Пример 10.6. Файл <code
                    class="filename">/etc/pptpd.conf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# TAG: speed
#
#       Specifies the speed for the PPP daemon to talk at.
#
speed 115200

# TAG: option
#
#       Specifies the location of the PPP options file.
#       By default PPP looks in '/etc/ppp/options'
#
option /etc/ppp/pptpd-options

# TAG: debug
#
#       Turns on (more) debugging to syslog
#
# debug

# TAG: localip
# TAG: remoteip
#
#       Specifies the local and remote IP address ranges.
#
#       You can specify single IP addresses separated by commas or you can
#       specify ranges, or both. For example:
#
#               192.168.0.234,192.168.0.245-249,192.168.0.254
#
#       IMPORTANT RESTRICTIONS:
#
#       1. No spaces are permitted between commas or within addresses.
#
#       2. If you give more IP addresses than MAX_CONNECTIONS, it will
#          start at the beginning of the list and go until it gets
#          MAX_CONNECTIONS IPs. Others will be ignored.
#
#       3. No shortcuts in ranges! ie. 234-8 does not mean 234 to 238,
#          you must type 234-238 if you mean this.
#
#       4. If you give a single localIP, that's ok - all local IPs will
#          be set to the given one. You MUST still give at least one remote
#          IP for each simultaneous client.
#
#localip 192.168.0.234-238,192.168.0.245
#remoteip 192.168.1.234-238,192.168.1.245
#localip 10.0.1.1
#remoteip 10.0.1.2-100
localip 192.168.0.199
remoteip 192.168.0.200-250
</pre></div></div><div
              class="para">
					The PPP configuration used by the PPTP server also requires a few changes in <code
                class="filename">/etc/ppp/pptpd-options</code>. The important parameters are the server name (<code
                class="literal">pptp</code>), the domain name (<code
                class="literal">falcot.com</code>), and the IP addresses for DNS and WINS servers.
				</div><div
              class="example"><a
                id="example.ppp-pptpd-options"></a><p
                class="title"><strong>Пример 10.7. Файл <code
                    class="filename">/etc/ppp/pptpd-options</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
## turn pppd syslog debugging on
#debug

## change 'servername' to whatever you specify as your server name in chap-secrets
name pptp
## change the domainname to your local domain
domain falcot.com

## these are reasonable defaults for WinXXXX clients
## for the security related settings
# The Debian pppd package now supports both MSCHAP and MPPE, so enable them
# here. Please note that the kernel support for MPPE must also be present!
auth
require-chap
require-mschap
require-mschap-v2
require-mppe-128

## Fill in your addresses
ms-dns 192.168.0.1
ms-wins 192.168.0.1

## Fill in your netmask
netmask 255.255.255.0

## some defaults
nodefaultroute
proxyarp
lock
</pre></div></div><div
              class="para">
					The last step involves registering the <code
                class="literal">vpn</code> user (and the associated password) in the <code
                class="filename">/etc/ppp/chap-secrets</code> file. Contrary to other instances where an asterisk (<code
                class="literal">*</code>) would work, the server name must be filled explicitly here. Furthermore, Windows PPTP clients identify themselves under the <code
                class="literal"><em
                  class="replaceable">DOMAIN</em>\\<em
                  class="replaceable">USER</em></code> form, instead of only providing a user name. This explains why the file also mentions the <code
                class="literal">FALCOT\\vpn</code> user. It is also possible to specify individual IP addresses for users; an asterisk in this field specifies that dynamic addressing should be used.
				</div><div
              class="example"><a
                id="example.ppp-chap-secrets"></a><p
                class="title"><strong>Пример 10.8. Файл <code
                    class="filename">/etc/ppp/chap-secrets</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Secrets for authentication using CHAP
# client        server  secret      IP addresses
vpn             pptp    f@Lc3au     *
FALCOT\\vpn     pptp    f@Lc3au     *
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>БЕЗОПАСНОСТЬ</em></span> уязвимости PPTP</strong></p></div></div></div><div
                class="para">
					Microsoft's first PPTP implementation drew severe criticism because it had many security vulnerabilities; most have since then been fixed in more recent versions. The configuration documented in this section uses the latest version of the protocol. Be aware though that removing some options (such as <code
                  class="literal">require-mppe-128</code> and <code
                  class="literal">require-mschap-v2</code>) would make the service vulnerable again.
				</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="network-infrastructure.html"><strong>Пред.</strong>Глава 10. Сетевая инфраструктура</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>Наверх</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>Начало</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.quality-of-service.html"><strong>След.</strong>10.3. Quality of Service</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/sect.virtual-private-network.html">ar-MA</a></li><li><a
              href="../da-DK/sect.virtual-private-network.html">da-DK</a></li><li><a
              href="../de-DE/sect.virtual-private-network.html">de-DE</a></li><li><a
              href="../el-GR/sect.virtual-private-network.html">el-GR</a></li><li><a
              href="../en-US/sect.virtual-private-network.html">en-US</a></li><li><a
              href="../es-ES/sect.virtual-private-network.html">es-ES</a></li><li><a
              href="../fa-IR/sect.virtual-private-network.html">fa-IR</a></li><li><a
              href="../fr-FR/sect.virtual-private-network.html">fr-FR</a></li><li><a
              href="../hr-HR/sect.virtual-private-network.html">hr-HR</a></li><li><a
              href="../id-ID/sect.virtual-private-network.html">id-ID</a></li><li><a
              href="../it-IT/sect.virtual-private-network.html">it-IT</a></li><li><a
              href="../ja-JP/sect.virtual-private-network.html">ja-JP</a></li><li><a
              href="../ko-KR/sect.virtual-private-network.html">ko-KR</a></li><li><a
              href="../nb-NO/sect.virtual-private-network.html">nb-NO</a></li><li><a
              href="../pl-PL/sect.virtual-private-network.html">pl-PL</a></li><li><a
              href="../pt-BR/sect.virtual-private-network.html">pt-BR</a></li><li><a
              href="../ro-RO/sect.virtual-private-network.html">ro-RO</a></li><li><a
              href="../ru-RU/sect.virtual-private-network.html">ru-RU</a></li><li><a
              href="../tr-TR/sect.virtual-private-network.html">tr-TR</a></li><li><a
              href="../vi-VN/sect.virtual-private-network.html">vi-VN</a></li><li><a
              href="../zh-CN/sect.virtual-private-network.html">zh-CN</a></li><li><a
              href="../zh-TW/sect.virtual-private-network.html">zh-TW</a></li></ul></div></body></html>
