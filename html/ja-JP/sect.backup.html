<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">9.10. バックアップ</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-ja-JP-1.0-1" /><meta
        name="keywords"
        content="システム起動, 初期化スクリプト, SSH, Telnet, 権限, パーミッション, 管理, inetd, cron, バックアップ, ホットプラグ, PCMCIA, APM, ACPI" /><link
        rel="home"
        href="index.html"
        title="Debian 管理者ハンドブック" /><link
        rel="up"
        href="unix-services.html"
        title="第 9 章 Unix サービス" /><link
        rel="prev"
        href="sect.quotas.html"
        title="9.9. クォータ" /><link
        rel="next"
        href="sect.hotplug.html"
        title="9.11. ホットプラグ機能、hotplug" /><meta
        name="viewport"
        content="width=device-width, initial-scale=1" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/ja-JP/sect.backup.html" /></head><body><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="../../"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.quotas.html"><strong>戻る</strong></a></li><li
          class="home">Debian 管理者ハンドブック</li><li
          class="next"><a
            accesskey="n"
            href="sect.hotplug.html"><strong>次へ</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  id="sect.backup"></a>9.10. バックアップ</h2></div></div></div><div
          class="para">
			バックアップを取ることは管理者の主要な責任の 1 つです。しかし、これは通常極めるのが難しい強力なツールを使う複雑な問題です。
		</div><a
          id="id-1.12.13.3"
          class="indexterm"></a><a
          id="id-1.12.13.4"
          class="indexterm"></a><div
          class="para">
			バックアップ作業に関して言えば <code
            class="command">amanda</code>、<code
            class="command">bacula</code>、<code
            class="command">BackupPC</code> などの多くのプログラムが存在します。これらは多くの機能を備えるクライアント/サーバシステムで、その設定はかなり難しいです。いくつかのプログラムは難しさを和らげるためのユーザフレンドリーなウェブインターフェースを提供しています。しかし Debian には、すべての考え得る使用事例に対応できる、他の数多くのバックアップソフトウェアが含まれています。ソフトウェアを確認するには <code
            class="command">apt-cache search backup</code> を使ってください。
		</div><a
          id="id-1.12.13.6"
          class="indexterm"></a><a
          id="id-1.12.13.7"
          class="indexterm"></a><a
          id="id-1.12.13.8"
          class="indexterm"></a><div
          class="para">
			この節ではプログラムの使い方を詳細に説明するのではなく、Falcot Corp の管理者がバックアップ戦略を定義する際にどのように考えたかを説明します。
		</div><div
          class="para">
			Falcot Corp では、バックアップには 2 つの目標があります。具体的に言えば、誤って削除したファイルを回復することと、ハードドライブに障害が起きた際にコンピュータ (サーバおよびデスクトップ) を素早く復元することです。
		</div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="id-1.12.13.11"></a>9.10.1. <code
                    class="command">rsync</code> を使ったバックアップ</h3></div></div></div><div
            class="para">
				テープへのバックアップは遅くて費用がかかりすぎるとみなされ、データは専用サーバのハードドライブにバックアップされることになりました。専用サーバはソフトウェア RAID (<a
              class="xref"
              href="advanced-administration.html#sect.raid-soft">第 12.1.1 節「ソフトウェア RAID」</a>を参照してください) を使ってデータをハードウェア障害から守っています。デスクトップコンピュータは個別にバックアップされませんが、ユーザは部署のファイルサーバの個人アカウントはバックアップされると知らされています。毎日異なるサーバにバックアップを行う目的で、<code
              class="command">rsync</code> コマンド (同名のパッケージに含まれます) が使われています。
			</div><a
            id="id-1.12.13.11.3"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>BACK TO BASICS</em></span> ハードリンク、ファイルの別名</strong></p></div></div></div><a
              id="id-1.12.13.11.4.2"
              class="indexterm"></a><a
              id="id-1.12.13.11.4.3"
              class="indexterm"></a><div
              class="para">
				ハードリンクはシンボリックリンクと異なり、リンクされたファイルと区別できません。本質的に、ハードリンクの作成は既存のファイルに別名を与えることと同義です。そのため、ハードリンクの削除はそのファイルに関連する名前を削除するに過ぎません。他の名前がまだそのファイルに関連付けられている場合、データの実体はファイルシステムから削除されません。コピーと異なり、ハードリンクはハードドライブ上に追加的な領域を必要としない点について注意することは興味深いです。
			</div><div
              class="para">
				ハードリンクは <code
                class="command">ln <em
                  class="replaceable">target</em> <em
                  class="replaceable">link</em></code> コマンドで作成されます。ここで <em
                class="replaceable">link</em> ファイルは <em
                class="replaceable">target</em> ファイルの新しい名前です。ハードリンクは <em
                class="replaceable">target</em> と <em
                class="replaceable">link</em> が同じファイルシステム上にある場合に限り作成できます。対してシンボリックリンクはこの制限を受けません。
			</div></div><div
            class="para">
				利用できるハードドライブの空き領域によっては、完全な日次バックアップができない場合があります。このため、まず <code
              class="command">rsync</code> コマンドは今回のバックアップの内容を前回のバックアップの内容へのハードリンクの形で複製します。このおかげで、ハードドライブ領域を無駄に消費することがなくなります。そして <code
              class="command">rsync</code> プロセスは前回のバックアップ以降に変更されたファイルだけを置き換えていきます。このメカニズムにより、多くのバックアップを少ない領域に保存することが可能です。すべてのバックアップは即座に利用できる上に即座にアクセスできるので (たとえば、ネットワーク共有されたディレクトリの中に置かれるので)、ある日付同士の違いを素早く比較できます。
			</div><a
            id="id-1.12.13.11.6"
            class="indexterm"></a><a
            id="id-1.12.13.11.7"
            class="indexterm"></a><a
            id="id-1.12.13.11.8"
            class="indexterm"></a><div
            class="para">
				<code
              class="command">dirvish</code> プログラムを使えば、このバックアップメカニズムを簡単に実現できます。<code
              class="command">dirvish</code> プログラムはバックアップストレージ領域 (dirvish 用語で「bank」) を使い、「bank」の中に一連のバックアップファイルのタイムスタンプを付けたコピー (dirvish の文書ではこれらを「vault」と呼びます) を置きます。
			</div><div
            class="para">
				主要な設定は <code
              class="filename">/etc/dirvish/master.conf</code> ファイルに書かれています。<code
              class="filename">/etc/dirvish/master.conf</code> ファイルでは、バックアップストレージ領域の場所、管理する「vault」のリスト、バックアップの保存期限のデフォルト値を定義します。残りの設定、すなわち <em
              class="replaceable">vault</em> でバックアップするファイルセットに固有の設定は <code
              class="filename"><em
                class="replaceable">bank</em>/<em
                class="replaceable">vault</em>/dirvish/default.conf</code> ファイルに書かれています。
			</div><div
            class="example"><a
              id="example.dirvish-master"></a><p
              class="title"><strong>例 9.3 <code
                  class="filename">/etc/dirvish/master.conf</code> ファイル</strong></p><div
              class="example-contents"><pre
                class="programlisting">bank:
    /backup
exclude:
    lost+found/
    core
    *~
Runall:
    root    22:00
expire-default: +15 days
expire-rule:
#   分  時    日  月        曜日 保存期限
    *   *     *   *         1    +3 months
    *   *     1-7 *         1    +1 year
    *   *     1-7 1,4,7,10  1</pre></div></div><div
            class="para">
				<code
              class="literal">bank</code> 設定はバックアップが保存されるディレクトリを表します。<code
              class="literal">exclude</code> 設定を使うと、バックアップからファイル (またはファイルタイプ) を除外することが可能です。<code
              class="literal">Runall</code> はタイムスタンプを付けてバックアップするファイルセットのリストです。これにより、万が一割り当てられた時間に正確にバックアップが実行されない場合でも、バックアップコピーに正確な時刻を割り当てることが可能です。ここで指定する時刻は実際の実行時刻の直前の時刻でなければいけません (<code
              class="filename">/etc/cron.d/dirvish</code> によれば、Debian では実際の実行時間はデフォルトで午後 10 時 4 分です)。最後に <code
              class="literal">expire-default</code> と <code
              class="literal">expire-rule</code> 設定でバックアップ保存期限ポリシーを定義します。上の例は、各四半期の最初の日曜日に作成されたバックアップを永久に保存し、それに当てはまらない各月の最初の日曜日に作成されたバックアップを 1 年経過後に削除し、それに当てはまらない日曜日に作成されたバックアップを 3 カ月経過後に削除します。その他の日次バックアップは 15 日間保存されます。ルールが適用される順番が問題です。Dirvish は最後にマッチしたルールを使い、<code
              class="literal">expire-rule</code> にマッチするものがなければ <code
              class="literal">expire-default</code> を使います。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>IN PRACTICE</em></span> 削除スケジュール</strong></p></div></div></div><div
              class="para">
				削除を担当している <code
                class="command">dirvish-expire</code> は削除ルールを使いません。削除ルールが適用されるのは新しいバックアップコピーの作成時であり、バックアップコピーを削除する日付が削除ルールによって定義されます。<code
                class="command">dirvish-expire</code> は保存されたコピーを単純に調べて、期限の過ぎているコピーを削除します。
			</div></div><div
            class="example"><a
              id="example.dirvish-vault"></a><p
              class="title"><strong>例 9.4 <code
                  class="filename">/backup/root/dirvish/default.conf</code> ファイル</strong></p><div
              class="example-contents"><pre
                class="programlisting">client: rivendell.falcot.com
tree: /
xdev: 1
index: gzip
image-default: %Y%m%d
exclude:
    /var/cache/apt/archives/*.deb
    /var/cache/man/**
    /tmp/**
    /var/tmp/**
    *.bak</pre></div></div><div
            class="para">
				上の例では、バックアップするファイルセットを指定しています。具体的に言えば、バックアップ対象は <span
              class="emphasis"><em>rivendell.falcot.com</em></span> マシン (ローカルデータをバックアップするには、単純に <code
              class="command">hostname</code> の出力するローカルマシンの名前を指定します) にあるルートツリーの内容 (<code
              class="literal">tree: /</code>) から <code
              class="literal">exclude</code> で指定したものを除外したファイルです。さらに、バックアップ対象は <code
              class="literal">tree</code> と同一のファイルシステムの内容 (<code
              class="literal">xdev: 1</code>) に制限されます。他のマウントポイントのファイルはバックアップされません。保存されたファイルのインデックス (<code
              class="literal">index: gzip</code>) が生成され、イメージには現在の日付に関連する名前 (<code
              class="literal">image-default: %Y%m%d</code>) が付けられます。
			</div><div
            class="para">
				多くのオプションがあり、すべては <span
              class="citerefentry"><span
                class="refentrytitle">dirvish.conf</span>(5)</span> マニュアルページに書かれています。一度これらの設定ファイルを作ったら、<code
              class="command">dirvish --vault <em
                class="replaceable">vault</em> --init</code> コマンドを使って、各ファイルセットを初期化します。ここまでが済むと、毎日の <code
              class="command">dirvish-runall</code> 実行時に期限切れになったバックアップコピーが削除され、その直後に自動的に新しいバックアップコピーが作成されます。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>IN PRACTICE</em></span> SSH を使ったリモートバックアップ</strong></p></div></div></div><div
              class="para">
				dirvish はリモートマシンにデータをバックアップする場合、<code
                class="command">ssh</code> を使ってリモートマシンに接続し、<code
                class="command">rsync</code> をサーバとして開始します。この場合、root ユーザとして自動的にリモートマシンに接続できなければいけません。これを実現するには、SSH 認証鍵を使ってください (<a
                class="xref"
                href="sect.remote-login.html#sect.ssh-key-based-auth">第 9.2.1.1 節「鍵認証方式」</a>を参照してください)。
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="id-1.12.13.12"></a>9.10.2. バックアップなしのマシンの復元</h3></div></div></div><div
            class="para">
				バックアップされていないデスクトップコンピュータに対しては <span
              class="emphasis"><em>Simple-CDD</em></span> でカスタマイズされた DVD-ROM からシステムを再インストールするのが簡単でしょう (<a
              class="xref"
              href="sect.automated-installation.html#sect.simple-cdd">第 12.3.3 節「Simple-CDD、一体型の解決策」</a>を参照してください)。インストールを最初からやり直すので、初回インストール後に行われたすべての設定は失われます。これは問題ではありません。なぜなら、アカウントに関して言えばシステムはすべて中央 LDAP ディレクトリの情報を参照しており、多くのデスクトップアプリケーションに関して言えば dconf のおかげで事前設定されているからです (詳しい情報は<a
              class="xref"
              href="sect.graphical-desktops.html#sect.gnome-desktop">第 13.3.1 節「GNOME」</a>を参照してください)。
			</div><div
            class="para">
				Falcot Corp の管理者は自分たちのバックアップポリシーの限界を理解しています。テープを耐火金庫に入れるかのようにバックアップサーバを保護することができないため、管理者はバックアップサーバを他のサーバと別の部屋に設置しました。そうすればサーバルームの火事などの災害が起きてもその他のサーバと一緒にバックアップも破壊されることを避けられるからです。さらに、管理者は 1 週間に 1 回 DVD-ROM に増分バックアップ (最後のバックアップ以降に修正されたファイルだけのバックアップ) をとるようにしています。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>GOING FURTHER</em></span> SQL と LDAP サービスのバックアップ</strong></p></div></div></div><div
              class="para">
				多くのサービス (SQL や LDAP データベースなど) は単純にファイルをコピーするだけではバックアップできません (それらのサービスをバックアップの作成中に適切に中断しない限りバックアップできません。サービスの中断は通常問題です。なぜなら、サービスが常に利用できることを意図されているからです)。そのような場合、安全にバックアップできる「データダンプ」を作るために「エクスポート」メカニズムを使うことが必要です。データダンプは通常サイズのとても大きいファイルですが、データダンプのサイズは圧縮によってかなり小さくなります。要求されるストレージ領域を減らすために、完全なテキストファイルを保存するのを 1 週間に 1 回、<code
                class="command">diff</code> を保存するのを毎日に制限しています。差分は <code
                class="command">diff <em
                  class="replaceable">file_from_yesterday</em> <em
                  class="replaceable">file_from_today</em></code> で生成されます。バイナリダンプから増分差分を作成するには <code
                class="command">xdelta</code> プログラムを使ってください。
			</div><a
              id="id-1.12.13.12.4.3"
              class="indexterm"></a><a
              id="id-1.12.13.12.4.4"
              class="indexterm"></a><a
              id="id-1.12.13.12.4.5"
              class="indexterm"></a></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CULTURE</em></span> <span
                        class="emphasis"><em>TAR</em></span>、テープバックアップ用の標準規格</strong></p></div></div></div><a
              id="id-1.12.13.12.5.2"
              class="indexterm"></a><a
              id="id-1.12.13.12.5.3"
              class="indexterm"></a><a
              id="id-1.12.13.12.5.4"
              class="indexterm"></a><div
              class="para">
				歴史的に言って、Unix で最も簡単にバックアップを作成する手段は <span
                class="emphasis"><em>TAR</em></span> アーカイブをテープに保存する方法でした。<code
                class="command">tar</code> コマンドは「Tape ARchive」から命名されています。
			</div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.quotas.html"><strong>戻る</strong>9.9. クォータ</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上に戻る</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>ホーム</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.hotplug.html"><strong>次へ</strong>9.11. ホットプラグ機能、hotplug</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/sect.backup.html">ar-MA</a></li><li><a
              href="../da-DK/sect.backup.html">da-DK</a></li><li><a
              href="../de-DE/sect.backup.html">de-DE</a></li><li><a
              href="../el-GR/sect.backup.html">el-GR</a></li><li><a
              href="../en-US/sect.backup.html">en-US</a></li><li><a
              href="../es-ES/sect.backup.html">es-ES</a></li><li><a
              href="../fa-IR/sect.backup.html">fa-IR</a></li><li><a
              href="../fr-FR/sect.backup.html">fr-FR</a></li><li><a
              href="../hr-HR/sect.backup.html">hr-HR</a></li><li><a
              href="../id-ID/sect.backup.html">id-ID</a></li><li><a
              href="../it-IT/sect.backup.html">it-IT</a></li><li><a
              href="../ja-JP/sect.backup.html">ja-JP</a></li><li><a
              href="../ko-KR/sect.backup.html">ko-KR</a></li><li><a
              href="../nb-NO/sect.backup.html">nb-NO</a></li><li><a
              href="../pl-PL/sect.backup.html">pl-PL</a></li><li><a
              href="../pt-BR/sect.backup.html">pt-BR</a></li><li><a
              href="../ro-RO/sect.backup.html">ro-RO</a></li><li><a
              href="../ru-RU/sect.backup.html">ru-RU</a></li><li><a
              href="../tr-TR/sect.backup.html">tr-TR</a></li><li><a
              href="../zh-CN/sect.backup.html">zh-CN</a></li><li><a
              href="../zh-TW/sect.backup.html">zh-TW</a></li></ul></div></body></html>
