<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">第11章 ネットワークサービス: Postfix、Apache、NFS、Samba、Squid、LDAP</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.1" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-ja-JP-1.0-1" /><meta
        name="keywords"
        content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP" /><link
        rel="home"
        href="index.html"
        title="Debian 管理者ハンドブック" /><link
        rel="up"
        href="index.html"
        title="Debian 管理者ハンドブック" /><link
        rel="prev"
        href="sect.network-diagnosis-tools.html"
        title="10.8. ネットワーク診断ツール" /><link
        rel="next"
        href="sect.http-web-server.html"
        title="11.2. ウェブサーバ (HTTP)" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/ja-JP/network-services.html" /></head><body
      class="draft "><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="http://debian-handbook.info"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>戻る</strong></a></li><li
          class="home">Debian 管理者ハンドブック</li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>次へ</strong></a></li></ul><div
        xml:lang="ja-JP"
        class="chapter"
        lang="ja-JP"><div
          class="titlepage"><div><div><h1
                class="title"><a
                  id="network-services"></a>第11章 ネットワークサービス: Postfix、Apache、NFS、Samba、Squid、LDAP</h1></div></div></div><div
          class="toc"><dl
            class="toc"><dt><span
                class="section"><a
                  href="network-services.html#sect.smtp-mail-server">11.1. メールサーバ</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="network-services.html#idm140393311787376">11.1.1. Postfix のインストール</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140393326152320">11.1.2. 仮想ドメインの設定</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140393307676656">11.1.3. 受信と送信の制限</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140393307573280">11.1.4. <span
                        class="foreignphrase"><em
                          class="foreignphrase">greylisting</em></span> の設定</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140393307549536">11.1.5. 受信アドレスに基づくフィルタのカスタマイズ</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#sect.postfix-antivirus">11.1.6. アンチウイルスの統合</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140393307510400">11.1.7. SMTP 認証</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-web-server.html">11.2. ウェブサーバ (HTTP)</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140393325624272">11.2.1. Apache のインストール</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140393325586272">11.2.2. 仮想ホストの設定</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140393325561568">11.2.3. よく使われる指示文</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140393325476144">11.2.4. ログ解析ソフトウェア</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ftp-file-server.html">11.3. FTP ファイルサーバ</a></span></dt><dt><span
                class="section"><a
                  href="sect.nfs-file-server.html">11.4. NFS ファイルサーバ</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140393325413888">11.4.1. 安全な NFS</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140393306467584">11.4.2. NFS サーバ</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140393306445088">11.4.3. NFS クライアント</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.windows-file-server-with-samba.html">11.5. Samba を使った Windows 共有のセットアップ</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm140393306425232">11.5.1. Samba サーバ</a></span></dt><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm140393306373792">11.5.2. Samba クライアント</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-ftp-proxy.html">11.6. HTTP/FTP プロキシ</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140393306332832">11.6.1. インストール</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140393306327264">11.6.2. キャッシュの設定</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140393306323552">11.6.3. フィルタの設定</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ldap-directory.html">11.7. LDAP ディレクトリ</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140393306300016">11.7.1. インストール</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140393306279392">11.7.2. ディレクトリの書き込み</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140393306249216">11.7.3. LDAP を用いたアカウントの管理</a></span></dt></dl></dd></dl></div><div
          class="highlights"><div
            class="para">
		ネットワークサービスはユーザが毎日の仕事で直接使用するプログラムです。ネットワークサービスは情報システムの氷山の一角で、この章ではネットワークサービスに注目します; 水面下に隠された部分は、既に説明したインフラに依存しています。
	</div></div><div
          class="section"><div
            class="titlepage"><div><div><h2
                  class="title"><a
                    id="sect.smtp-mail-server"></a>11.1. メールサーバ</h2></div></div></div><div
            class="para">
			Falcot Corp の管理者は、信頼性と設定の容易さから、電子メールサーバに Postfix を選びました。実際、Postfix の設計により、それぞれのタスクは必要な最低限のパーミッションを持つ単独のプロセスとして実装される事が、強制されます。この制限によりセキュリティ問題を大きく軽減させる事が可能です。
		</div><a
            id="idm140393311263024"
            class="indexterm"></a><a
            id="idm140393313353120"
            class="indexterm"></a><a
            id="idm140393313408352"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>ALTERNATIVE</em></span> Exim4 サーバ</strong></p></div></div></div><a
              id="idm140393310972384"
              class="indexterm"></a><div
              class="para">
			Debian はデフォルト電子メールサーバとして Exim4 を使います (そのため Exim4 は最初にインストールされるパッケージに含まれます)。Exim4 の設定は別のパッケージ <span
                class="pkg pkg">exim4-config</span> で提供され、Debconf を使った一連の質問に答えることで自動的にカスタマイズされます。この質問は <span
                class="pkg pkg">postfix</span> パッケージの行う質問とよく似ています。
		</div><div
              class="para">
			設定は単独ファイル (<code
                class="filename">/etc/exim4/exim4.conf.template</code>) を使うか、<code
                class="filename">/etc/exim4/conf.d/</code> の下に保存される数多くの設定の断片を通じて行います。どちらの場合も、<code
                class="command">update-exim4.conf</code> が設定ファイルを使って <code
                class="filename">/var/lib/exim4/config.autogenerated</code> を生成します。実際 Exim4 が使うファイルが <code
                class="filename">/var/lib/exim4/config.autogenerated</code> です。このメカニズムのお陰で、Exim の debconf 設定を通じて得られた値 - <code
                class="filename">/etc/exim4/update-exim4.conf.conf</code> に保存されている値 - は管理者や他のパッケージがデフォルトの Exim 設定を変更した場合でも Exim の設定ファイルに反映されます。
		</div><div
              class="para">
			Exim4 設定ファイルの構文は特殊で、構文の学習曲線も特殊です; しかしながら、その特殊性を理解すれば、Exim4 は数十ページにおよぶ文書からも明らかな通りとても完全で強力な電子メールサーバです。<div
                class="url">→ <a
                  href="http://www.exim.org/docs.html">http://www.exim.org/docs.html</a></div>
		</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140393311787376"></a>11.1.1. Postfix のインストール</h3></div></div></div><div
              class="para">
				<span
                class="pkg pkg">postfix</span> パッケージには主要な SMTP デーモンが含まれます。別のパッケージ (例えば <span
                class="pkg pkg">postfix-ldap</span> と <span
                class="pkg pkg">postfix-pgsql</span> など) は追加機能を Postfix に追加します。これらのパッケージはマッピングデータベースへのアクセスを可能にします。これらのパッケージは、それが必要と判っている場合を除いて、インストールするべきではありません。
			</div><div
              class="sidebar"><a
                id="sidebar.smtp"></a><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>BACK TO BASICS</em></span> SMTP</strong></p></div></div></div><a
                id="idm140393316161616"
                class="indexterm"></a><a
                id="idm140393316160656"
                class="indexterm"></a><a
                id="idm140393316159728"
                class="indexterm"></a><div
                class="para">
				メールサーバは SMTP (<span
                  class="emphasis"><em>Simple Mail Transfer Protocol</em></span>) を使ってメールを交換したり配送したりします。
			</div></div><div
              class="para">
				Debconf はパッケージのインストール中に幾つかの質問を行います。これに答えることで、<code
                class="filename">/etc/postfix/main.cf</code> 設定ファイルの最初のバージョンが作成されます。
			</div><div
              class="para">
				最初の質問はセットアップのタイプに関するものです。インターネットに接続されたサーバに関連するのは提案された選択肢の内の 2 種類だけです。「Internet site」と「Internet with smarthost」です。「Internet site」は、入って来る電子メールを受け取り、外に出る電子メールを直接受信者に送信するサーバに適します。つまり Falcot Corp の場合に上手く適合します。「Internet with smarthost」は、外に出る電子メールを直接受信者のサーバに送信するのではなく、中間 SMTP サーバ -「smarthost」- を介して送信するサーバに適します。この選択肢は主に動的 IP アドレスを持つマシンに便利です。なぜなら、多くの電子メールサーバは動的 IP アドレスを持つホストから配送されたメッセージを拒否するからです。この場合、スマートホストに通常 ISP の SMTP サーバを設定します。この SMTP サーバはは常に ISP の顧客からの電子メールを受け入れ、それを適切に転送するように設定されています。この (スマートホストを使う) 選択肢はさらに、永久にインターネットに接続され続けないサーバにも適しています。なぜなら、後から再試行する必要のある未配送メッセージのキューを管理しなくても良くなるからです。
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>VOCABULARY</em></span> ISP</strong></p></div></div></div><a
                id="idm140393311664960"
                class="indexterm"></a><div
                class="para">
				ISP とは「Internet Service Provider」の頭字語です。ISP は通常営利企業で、インターネット接続と関連する基本的サービス (電子メール、ニュースなど) を提供します。
			</div><div
                class="para">
			</div></div><div
              class="para">
				2 番目の質問はマシンのフルネームに関するもので、これはローカルユーザの電子メールアドレスを生成するために使われます; マシンのフルネームとはアットマーク (「@」) のすぐ後ろに付けられるものです。Falcot の場合、この質問には <code
                class="literal">mail.falcot.com</code> と答えるべきです。デフォルトで聞かれる質問は以上ですが、Falcot にとってこの状態の Postfix はまだ十分に設定されていません。このため、管理者は <code
                class="command">dpkg-reconfigure postfix</code> を実行してさらに多くのパラメータをカスタマイズします。
			</div><div
              class="para">
				追加で行われる質問の 1 つに、このマシンに関連するすべてのドメイン名に関するものがあります。デフォルトで挙げられるドメイン名のリストには、マシンのフルネームと幾つかの <code
                class="literal">localhost</code> の同義語が含まれていますが、主要なドメイン名である <code
                class="literal">falcot.com</code> を手作業で追加する必要があります。より一般的に言えば、この質問の回答には、通常 MX サーバを担当するマシンに割り当てたすべてのドメイン名を含めるべきです; 言い換えれば、DNS から電子メールを受け入れると回答されるすべてのドメイン名を含めるべきです。この情報の最後に主要な Postfix 設定ファイル - <code
                class="filename">/etc/postfix/main.cf</code> - の <code
                class="literal">mydestination</code> 変数を設定します。
			</div><a
              id="idm140393325923952"
              class="indexterm"></a><a
              id="idm140393325922512"
              class="indexterm"></a><div
              class="figure"><a
                id="idm140393325921072"></a><div
                class="figure-contents"><div
                  class="mediaobject"><img
                    src="images/mail-server.png"
                    alt="メール送信中の DNS MX レコードの役割" /></div></div><p
                class="title"><strong>図11.1 メール送信中の DNS <span
                    class="emphasis"><em>MX</em></span> レコードの役割</strong></p></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> MX レコードの問い合わせ</strong></p></div></div></div><div
                class="para">
				宛先アドレスの DNS 応答に MX レコードが含まれない場合、電子メールサーバはの宛先アドレスの A レコード (IPv6 の場合 AAAA レコード) に送信する事を試みます。
			</div></div><div
              class="para">
				インストール中に、このサーバが電子メールの送信要求を受け入れるネットワークを尋ねられる場合があります。デフォルトの設定で、Postfix はマシン自身からの電子メールの送信要求だけを受け入れます; 通常はローカルネットワークからの送信要求も受け入れるように設定します。Falcot Corp 管理者はデフォルトの回答に <code
                class="literal">192.168.0.0/16</code> を追加しました。この質問が尋ねられなければ、以下の例に示す通り、設定ファイル中の関連する変数 <code
                class="literal">mynetworks</code> にローカルネットワークを追加します。
			</div><div
              class="para">
				ローカル電子メールを <code
                class="command">procmail</code> を使って配送する事も可能です。<code
                class="command">procmail</code> を使うことで、ユーザは <code
                class="filename">~/.procmailrc</code> ファイルに書かれたルールに従って入って来る電子メールを仕分けする事が可能になります。
			</div><a
              id="idm140393325911792"
              class="indexterm"></a><a
              id="idm140393326163200"
              class="indexterm"></a><a
              id="idm140393326161760"
              class="indexterm"></a><div
              class="para">
				最初のステップの後、以下の設定ファイルが得られます; 次の節では、幾つかの追加的な機能を追加するための足掛かりとしてこれを使います。
			</div><div
              class="example"><a
                id="idm140393326160160"></a><p
                class="title"><strong>例11.1 最初の <code
                    class="filename">/etc/postfix/main.cf</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SECURITY</em></span> <span
                          class="emphasis"><em>Snake oil</em></span> SSL 証明書</strong></p></div></div></div><div
                class="para">
				<span
                  class="emphasis"><em>snake oil</em></span> 証明書、昔に悪徳医者によって販売された<span
                  class="emphasis"><em>いんちき</em></span>「薬」のようなもの、には全く価値がありません。なぜなら、すべての Debian システムで同じ「秘密」部分を使って同じようなものが生成されるからです。<span
                  class="emphasis"><em>snake oil</em></span> 証明書はテスト目的でのみ使われ、通常のサービスでは真の証明書を使うべきです; 証明書の作成手順は<a
                  class="xref"
                  href="sect.virtual-private-network.html#sect.easy-rsa">「公開鍵基盤: <span
                    class="emphasis"><em>easy-rsa</em></span>」</a>で説明されています。
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140393326152320"></a>11.1.2. 仮想ドメインの設定</h3></div></div></div><a
              id="idm140393326151552"
              class="indexterm"></a><a
              id="idm140393326150112"
              class="indexterm"></a><div
              class="para">
				メールサーバは主要ドメインに加えて他のドメイン宛の電子メールを受け取る事が可能です。これらは仮想ドメインとして知られています。これを使う場合のほとんどは、電子メールが永久的にローカルユーザに配送されない場合です。Postfix は仮想ドメインを取り扱う 2 種類の興味深い機能を提供します。
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CAUTION</em></span> 仮想ドメインとカノニカルドメイン</strong></p></div></div></div><div
                class="para">
				いかなる仮想ドメインも <code
                  class="literal">mydestination</code> 変数の中で参照していはいけません; <code
                  class="literal">mydestination</code> 変数では、マシンとローカルユーザに直接的に関連付けられた「カノニカル」ドメインの名前だけが含まれます。
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140393323698256"></a>11.1.2.1. 仮想エイリアスドメイン</h4></div></div></div><a
                id="idm140393323697488"
                class="indexterm"></a><a
                id="idm140393323696080"
                class="indexterm"></a><div
                class="para">
					仮想エイリアスドメインには、エイリアスだけが含まれます。例えば、電子メールを他のアドレスに転送するだけのアドレスがこれに当たります。
				</div><div
                class="para">
					ドメインを有効化するには、<code
                  class="literal">virtual_alias_domains</code> 変数にその名前を追加し、<code
                  class="literal">virtual_alias_maps</code> 変数でアドレスマッピングファイルを参照します。
				</div><div
                class="example"><a
                  id="idm140393323692656"></a><p
                  class="title"><strong>例11.2 <code
                      class="filename">/etc/postfix/main.cf</code> ファイルに追加する指示文</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual</pre></div></div><div
                class="para">
					<code
                  class="filename">/etc/postfix/virtual</code> ファイルは、かなり直接的な構文で、対応付けを記述します: 各行には空白で分割された 2 つのフィールドが含まれます; 最初のフィールドは別名、2 番目のフィールドはリダイレクトする電子メールアドレスのリストです。<code
                  class="literal">@domain.com</code> 特殊構文を使うことで、そのドメインに含まれるすべての残りの別名をカバーする事も可能です。
				</div><div
                class="example"><a
                  id="idm140393323689104"></a><p
                  class="title"><strong>例11.3 <code
                      class="filename">/etc/postfix/virtual</code> ファイルの例</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# The alias below is generic and covers all addresses within 
# the falcotsbrand.com domain not otherwise covered by this file.
# These addresses forward email to the same user name in the
# falcot.com domain.
@falcotsbrand.com           @falcot.com</pre></div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140393323686848"></a>11.1.2.2. 仮想メールボックスドメイン</h4></div></div></div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>CAUTION</em></span> 統合された仮想ドメイン?</strong></p></div></div></div><div
                  class="para">
					Postfix は <code
                    class="literal">virtual_alias_domains</code> と <code
                    class="literal">virtual_mailbox_domains</code> で同じドメインを使う事を許しません。しかしながら、<code
                    class="literal">virtual_mailbox_domains</code> の各ドメインは明らかに <code
                    class="literal">virtual_alias_domains</code> に含まれます。そのお陰で、仮想ドメインの中でエイリアスとメールボックスを混在させる事が可能になります。
				</div></div><a
                id="idm140393307693248"
                class="indexterm"></a><a
                id="idm140393307692320"
                class="indexterm"></a><div
                class="para">
					仮想メールボックスドメイン宛のメッセージはローカルシステムユーザに割り当てられていないメールボックスに保存されます。
				</div><div
                class="para">
					仮想メールボックスドメインを有効化するには、そのドメインを <code
                  class="literal">virtual_mailbox_domains</code> 変数の中に含め、<code
                  class="literal">virtual_mailbox_maps</code> で指定したメールボックスマッピングファイルで参照します。<code
                  class="literal">virtual_mailbox_base</code> パラメータには、メールボックスが保存されるディレクトリが含まれます。
				</div><div
                class="para">
					<code
                  class="literal">virtual_uid_maps</code> (および <code
                  class="literal">virtual_gid_maps</code>) パラメータは電子メールアドレスとそれに対応するメールボックスを「所有する」システムユーザ (およびグループ) の対応関係を含むファイルを参照します。すべてのメールボックスを同じ所有者とグループによって所有されるようにするには <code
                  class="literal">static:5000</code> 構文はを使って固定された UID/GID (ここでは 5000)を割り当てるようにします。
				</div><div
                class="example"><a
                  id="idm140393307686000"></a><p
                  class="title"><strong>例11.4 <code
                      class="filename">/etc/postfix/main.cf</code> ファイルに追加する指示文</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts</pre></div></div><div
                class="para">
					繰り返しになりますが、<code
                  class="filename">/etc/postfix/vmailbox</code> ファイルの構文はかなり直接的です: 空白で分けられた 2 種類のフィールドです。最初のフィールドは仮想ドメインの 1 つに属する電子メールアドレスで、2 番目のフィールドは関連するメールボックスの場所です (<span
                  class="emphasis"><em>virtual_mailbox_base</em></span> 以下のディレクトリパス)。メールボックスの名前がスラッシュ (<code
                  class="literal">/</code>) で終わっていた場合、電子メールは <span
                  class="emphasis"><em>maildir</em></span> フォーマットで保存されます; そうでなければ伝統的な <span
                  class="emphasis"><em>mbox</em></span> フォーマットで保存されます。<span
                  class="emphasis"><em>maildir</em></span> フォーマットはメールボックスを保存するためにディレクトリ全体を使い、それぞれのメッセージは 1 つのファイルとして保存されます。これに対して、<span
                  class="emphasis"><em>mbox</em></span> フォーマットでは、メールボックス全体が 1 つのファイルに保存されます。「<code
                  class="literal">From </code>」(<code
                  class="literal">From</code> の後に 1 つの空白) で始まる行が新しいメッセージの始まる目印です。
				</div><div
                class="example"><a
                  id="idm140393307678992"></a><p
                  class="title"><strong>例11.5 <code
                      class="filename">/etc/postfix/vmailbox</code> ファイル</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
# Jean's email is stored as maildir, with
# one file per email in a dedicated directory
jean@falcot.org falcot.org/jean/
# Sophie's email is stored in a traditional "mbox" file,
# with all mails concatenated into one single file
sophie@falcot.org falcot.org/sophie</pre></div></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140393307676656"></a>11.1.3. 受信と送信の制限</h3></div></div></div><div
              class="para">
				迷惑メール (<span
                class="emphasis"><em>スパム</em></span>) の数が増加したことにより、サーバが受け入れる電子メールの判断基準をますます厳しくする事が要求されるようになっています。この節では Postfix に含まれる幾つかの戦略を紹介します。
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CULTURE</em></span> スパム問題</strong></p></div></div></div><a
                id="idm140393307673568"
                class="indexterm"></a><div
                class="para">
				「スパム」は一般的な用語で、電子メールボックスを溢れさせるすべての迷惑メール (UCE としても知られる) を指す場合に使われます; スパムを送信する悪人はスパマーとして知られています。スパマーは自分のやっている迷惑行為にほとんど関心がありません。なぜなら、電子メールを送信する費用はとても小さく、受信者の内とても少ない割合がスパム行為の提供物により惹きつけられ、そのコストより多くのお金を生むからです。スパム行為はほとんど自動化されています。公開している電子メールアドレス (例えば、ウェブフォーラム、メーリングリストのアーカイブ、ブログ、など) はスパマーのロボットによって発見され、迷惑メッセージを絶えず送りつけられます。
			</div><div
                class="para">
				すべてのシステム管理者はスパムフィルタを使ってこの迷惑行為に立ち向かう事を試みます。しかし、もちろんスパマーはスパムフィルタを対処するように調整を続けます。一部のスパマーは様々な犯罪組織によりワームに感染させられたマシンのネットワークを借りるかもしれません。最近の統計によればインターネット上を流れるすべての電子メールの 95% 超がスパムであると推定されています!
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140393307670048"></a>11.1.3.1. IP に基づくアクセス制限</h4></div></div></div><div
                class="para">
					<code
                  class="literal">smtpd_client_restrictions</code> 指示文を使うことで、電子メールサーバと通信する事を許すマシンを制御する事が可能です。
				</div><div
                class="example"><a
                  id="idm140393307668240"></a><p
                  class="title"><strong>例11.6 クライアントアドレスに基づく制限</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org</pre></div></div><div
                class="para">
					上に挙げた例のように、変数に復数のルールのリストを設定する場合、これらのルールは最初から最後まで順番に評価されます。それぞれのルールはメッセージを受け入れ、拒否し、次のルールに決定を任せる事が可能です。その結果、順番が重要になります。単純に 2 つのルールを入れ替えることで、挙動が全く違うものになる場合があります。
				</div><div
                class="para">
					最初のルールとして使われている <code
                  class="literal">permit_mynetworks</code> 指示文により、ローカルネットワーク (<span
                  class="emphasis"><em>mynetworks</em></span> 設定変数によって定義された) 内のマシンからのすべての電子メールを受け入れるようになります。
				</div><div
                class="para">
					2 番目の指示文により、完全に適切な DNS 設定の無いマシンからの電子メールを通常拒否するようになります。ここで適切な設定とは、IP アドレスが名前に解決でき、その名前が IP アドレスに解決できる事を意味しています。この基準は厳しすぎる場合が多いでしょう。なぜなら、多くの電子メールサーバは IP アドレスに対応する逆引き DNS を持っていないからです。このため、Falcot 管理者は <code
                  class="literal">warn_if_reject</code> 修飾子を <code
                  class="literal">reject_unknown_client</code> 指示文の前に起きました。<code
                  class="literal">warn_if_reject</code> 修飾子を付けることで、拒否するのではなく警告をログに記録するようになります。管理者は、このルールが実際強制された場合に拒否されるかもしれないメッセージの数に目を光らせ、後から十分な情報に基づいてこのルールを強制するか否かを決断する事が可能です。
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>TIP</em></span> <span
                            class="emphasis"><em>access</em></span> テーブル</strong></p></div></div></div><div
                  class="para">
					管理者は送信者、IP アドレス、許可および拒否ホスト名を組み合わせたテーブルを作成し、制限基準としてこれを使う事が可能です。これらのテーブルは <code
                    class="filename">/usr/share/doc/postfix-doc/examples/access.gz</code> ファイルを展開したコピーを使って作成する事も可能です。このひな形には、説明がコメントとして書かれており、それぞれのテーブルがその構文を説明しています。
				</div><div
                  class="para">
					<code
                    class="filename">/etc/postfix/access_clientip</code> テーブルは IP アドレスとネットワークをリストしています; <code
                    class="filename">/etc/postfix/access_helo</code> はドメイン名をリストしています; <code
                    class="filename">/etc/postfix/access_sender</code> は送信者の電子メールアドレスを含みます。これらのファイルを変更した場合、その後に必ず <code
                    class="command">postmap /etc/postfix/<em
                      class="replaceable">file</em></code> コマンドを使ってファイルをハッシュテーブル (高速アクセスに最適化されたフォーマット) に変換する必要があります。
				</div></div><div
                class="para">
					3 番目の指示文を使うことで、管理者は <code
                  class="filename">/etc/postfix/access_clientip</code> ファイルに保存された電子メールサーバのブラックリストとホワイトリストを設定する事が可能になります。ホワイトリストに含まれるサーバは信頼され、このサーバから来る電子メールは以降のフィルタリングルールを適用されません。
				</div><div
                class="para">
					最後の 2 つのルールにより、ブラックリストに含まれるサーバからのメッセージを拒否するようになります。RBL は <span
                  class="emphasis"><em>Remote Black List</em></span> の頭字語です; ブラックリストは復数存在しますが、どれも、スパマーが電子メールを中継するために使う下手に設定されたサーバ、ワームやウィルスに感染したマシンのような本来の意図と異なりメール中継させられているサーバ、がリストされています。
				</div><a
                id="idm140393307652864"
                class="indexterm"></a><a
                id="idm140393307651904"
                class="indexterm"></a><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>TIP</em></span> ホワイトリストと RBL</strong></p></div></div></div><div
                  class="para">
					ブラックリストには、過去に異常が発生した正当なサーバも含まれます。この場合、そのようなサーバからのすべての電子メールは拒否されます。これを受け入れるには <code
                    class="filename">/etc/postfix/access_clientip</code> によって定義されたホワイトリストの中にそのサーバをリストするしかありません。
				</div><div
                  class="para">
					このため、よく考えた上で、通常電子メールを受け取るような信頼できるサーバはすべてホワイトリストの中に含める事を推奨します。
				</div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140393307647616"></a>11.1.3.2. <code
                        class="literal">EHLO</code> または <code
                        class="literal">HELO</code> コマンドの妥当性確認</h4></div></div></div><div
                class="para">
					SMTP でメールを送信するには、サーバに <code
                  class="literal">HELO</code> (または <code
                  class="literal">EHLO</code>) の後に送信元の名前をつけたコマンドを送ります。送信元の名前の妥当性を確認することは興味深いです。
				</div><a
                id="idm140393307644512"
                class="indexterm"></a><a
                id="idm140393307643392"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140393307642272"></a><p
                  class="title"><strong>例11.7 <code
                      class="literal">EHLO</code> の引数に与えられる名前の制限</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname</pre></div></div><div
                class="para">
					最初の <code
                  class="literal">permit_mynetworks</code> 指示文を使うことで、ローカルネットワーク上のすべてのマシンならば、HELO コマンドの引数にどのような名前を使っても良いことになります。これは重要です。なぜなら、一部の電子メールプログラムは SMTP プロトコルのこの部分を十分適切に尊重せず、HELO の引数に無意味な名前を使います。
				</div><div
                class="para">
					<code
                  class="literal">reject_invalid_hostname</code> ルールを使うことで、<code
                  class="literal">EHLO</code> で申告されたホスト名が構文的に不正な電子メールを拒否するようになります。<code
                  class="literal">reject_non_fqdn_hostname</code> ルールを使うことで、申告されたホスト名が完全修飾ドメイン名 (ホスト名まで含むドメイン名) でないメッセージを拒否するようになります。<code
                  class="literal">reject_unknown_hostname</code> ルールを使うことで、申告された名前が DNS に存在しないメッセージを拒否するようになります。最後のルールを適用すると、数多くの電子メールが拒否されることになるため、管理者は <code
                  class="literal">warn_if_reject</code> 修飾子を付けて警告するだけにしています。管理者は <code
                  class="literal">reject_unknown_hostname</code> ルールの結果を調査した後に、最後の段階で <code
                  class="literal">warn_if_reject</code> 修飾子を削除するか判断します。
				</div><div
                class="para">
					最初のルールに <code
                  class="literal">permit_mynetworks</code> を使うと、面白い副作用があります: それ以降のルールがローカルネットワークの外のホストにのみ適用されるようになります。これを使うことで、自分を <code
                  class="literal">falcot.com</code> の一部と申告するすべてのホストをブラックリスト化できます。これを行うには、例えば <code
                  class="literal">falcot.com REJECT You're not in our network!</code> 行を <code
                  class="filename">/etc/postfix/access_helo</code> ファイルに追加します。
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140393307632080"></a>11.1.3.3. 申告された送信者に基づく受け入れおよび拒否</h4></div></div></div><div
                class="para">
					各メッセージには送信者があり、これは SMTP プロトコルの <code
                  class="literal">MAIL FROM</code> コマンドで申告されます; 繰り返しになりますが、様々な異なる方法でこの情報の有効性を判断します。
				</div><a
                id="idm140393307630256"
                class="indexterm"></a><a
                id="idm140393307629136"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140393307627728"></a><p
                  class="title"><strong>例11.8 送信者確認</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender</pre></div></div><div
                class="para">
					<code
                  class="filename">/etc/postfix/access_sender</code> テーブルを使うことで、一部の送信者を特別扱いする事が可能です。このテーブルは一部の送信者をホワイトリストやブラックリストに入れる事を意味します。
				</div><div
                class="para">
					<code
                  class="literal">reject_unknown_sender_domain</code> ルールを使うことで、送信者アドレスに適切なドメインが含まれる事を強制する事が可能です。なぜなら、適切なアドレスならば必ず適切なドメインを含むからです。<code
                  class="literal">reject_unlisted_sender</code> ルールを使うことで、アドレスが存在しないローカル送信者を拒否します; <code
                  class="literal">reject_unlisted_sender</code> ルールを使うことで、<code
                  class="literal">falcot.com</code> ドメイン内の不正なアドレスから電子メールが送信されること避ける事が可能で、<code
                  class="literal">joe.bloggs@falcot.com</code> というアドレスが本当に存在するならば、そのアドレスから放出されるメッセージは受け入れられるようになります。
				</div><div
                class="para">
					最後に、<code
                  class="literal">reject_non_fqdn_sender</code> ルールを使うことで、完全修飾ドメイン名を持たないアドレスから送信されたと称する電子メールを拒否します。具体的には、<code
                  class="literal">user@machine</code> からの電子メールを拒否します: このアドレスは必ず <code
                  class="literal">user@machine.example.com</code> または <code
                  class="literal">user@example.com</code> の形で申告されなければいけません。
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140393307619136"></a>11.1.3.4. 受信アドレスに基づく受け入れまたは拒否</h4></div></div></div><div
                class="para">
					各電子メールには少なくとも 1 つの受信アドレスが必要です。SMTP プロトコルではこれを <code
                  class="literal">RCPT TO</code> コマンドで申告します。送信アドレスに対して行った確認よりも関係性は低いとはいえ、受信アドレスの正当性を確認することは当然です。
				</div><a
                id="idm140393307617120"
                class="indexterm"></a><a
                id="idm140393307616160"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140393307614752"></a><p
                  class="title"><strong>例11.9 受信アドレスの確認</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient</pre></div></div><div
                class="para">
					<code
                  class="literal">reject_unauth_destination</code> は基本的なルールで、受け入れ要求のあったメッセージが自分達宛である事を確認します; このサーバに無いアドレス宛のメッセージを拒否するようになります。このルールが無い場合、サーバはスパマーが迷惑メールの送信に使う第三者中継サーバになります; このため <code
                  class="literal">reject_unauth_destination</code> ルールは必須で、リストの最初に近い位置に置くのが最良です。そうすれば、メッセージの宛先をチェックする前に、他のルールがそのメッセージの受け入れを許可する事を避けられます。
				</div><div
                class="para">
					<code
                  class="literal">reject_unlisted_recipient</code> ルールを使うことで、存在しないローカルユーザ宛のメッセージを拒否するようになります。これは道理にかなったルールです。最後に、<code
                  class="literal">reject_non_fqdn_recipient</code> ルールを使うことで、完全修飾ドメイン名でないアドレスを拒否されるようになります; <code
                  class="literal">reject_non_fqdn_recipient</code> ルールを使った場合、<code
                  class="literal">jean</code> や <code
                  class="literal">jean@machine</code> 宛の電子メールは送信できず、その代わりに <code
                  class="literal">jean@machine.falcot.com</code> や <code
                  class="literal">jean@falcot.com</code> などの完全なアドレスを使う事が要求されます。
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140393307607152"></a>11.1.3.5. <code
                        class="literal">DATA</code> コマンドに関連付けられた制限</h4></div></div></div><div
                class="para">
					SMTP の <code
                  class="literal">DATA</code> コマンドはメッセージ内容の前に送信されます。次に来るものはさておき、厳密な意味では <code
                  class="literal">DATA</code> コマンドはいかなる情報も提供しません。とは言っても、確認することは可能です。
				</div><a
                id="idm140393307604400"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140393307603280"></a><p
                  class="title"><strong>例11.10 <code
                      class="literal">DATA</code> の確認</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_data_restrictions = reject_unauth_pipelining</pre></div></div><div
                class="para">
					<code
                  class="literal">reject_unauth_pipelining</code> 指示文を使うことで、1 つ前に送信されたコマンドに応答する前に、送信者が次のコマンドを送ったメッセージを拒否するようになります。この防御は、スパマーロボットの使う一般的な最適化に対向するものです。なぜなら、スパマーはサーバからの応答の結果を気にせず、可能な限り短い時間て可能な限り大量の電子メールを送信することだけに注目しているからです。
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140393307599968"></a>11.1.3.6. 制限の適用</h4></div></div></div><div
                class="para">
					上のコマンドを使うことで、SMTP 交換の様々な段階で情報が検査されるにも関わらず、Postfix が実際の拒否を送信するのは、<code
                  class="literal">RCPT TO</code> コマンドに対する応答の段階です。
				</div><div
                class="para">
					これは、不正な <code
                  class="literal">EHLO</code> コマンドが原因でメッセージを拒否する場合でも、Postfix はメッセージの送信者と受信者を知った後に、拒否応答を送信する前事を意味しています。こうすることで、すぐにトランザクションを拒否する場合よりも、より明確なログを残す事が可能です。加えて、多くの SMTP クライアントはトランザクションの最初の方の SMTP コマンドの失敗を予期していませんから、<code
                  class="literal">RCPT TO</code> の後に拒否応答を返したとしても問題になることは少ないです。
				</div><div
                class="para">
					こうすることによる利点の最後は、SMTP 交換の様々なステージの間にやり取りした情報を貯める事が可能であるという点が挙げられます; これにより、パーミッションきめ細かく調整する事が可能です。例えば、ローカル送信者と申告した非ローカル接続を拒否するなどです。
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140393307595216"></a>11.1.3.7. メッセージ内容に基づくフィルタリング</h4></div></div></div><div
                class="para">
					メッセージ内容を確認する事により、妥当性確認と制限システムが完成します。Postfix は電子メール本文や電子メールヘッダの内容に対して確認を適用し、その妥当性を識別する事が可能です。
				</div><div
                class="example"><a
                  id="idm140393307593712"></a><p
                  class="title"><strong>例11.11 内容に基づくフィルタの有効化</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks</pre></div></div><a
                id="idm140393307592336"
                class="indexterm"></a><div
                class="para">
					どちらのファイルにも、正規表現 (<span
                  class="emphasis"><em>regexps</em></span> または <span
                  class="emphasis"><em>regexes</em></span> としても知られる) のリストおよび、電子メールヘッダ (または本文) がその正規表現にマッチする場合に実行する動作の対応リストが含まれます。
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>QUICK LOOK</em></span> 正規表現テーブル</strong></p></div></div></div><div
                  class="para">
					<code
                    class="filename">/usr/share/doc/postfix-doc/examples/header_checks.gz</code> ファイルには多くの説明的なコメントが含まれます。またこのファイルを <code
                    class="filename">/etc/postfix/header_checks</code> と <code
                    class="filename">/etc/postfix/body_checks</code> ファイルの足掛かりとして使う事も可能です。
				</div></div><div
                class="example"><a
                  id="idm140393307586320"></a><p
                  class="title"><strong>例11.12 <code
                      class="filename">/etc/postfix/header_checks</code> ファイルの例</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification</pre></div></div><div
                class="sidebar"><a
                  id="sidebar.regexp"></a><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>BACK TO BASICS</em></span> 正規表現</strong></p></div></div></div><div
                  class="para">
					<span
                    class="emphasis"><em>正規表現</em></span> (<span
                    class="emphasis"><em>regexp</em></span> または <span
                    class="emphasis"><em>regex</em></span> のように略される) とは内容の説明や文字列の構造を表現する一般的な記法です。特別な文字を使って、選択肢 (例えば、<code
                    class="literal">foo|bar</code> は「foo」または「bar」にマッチします)、許容する文字 (例えば、<code
                    class="literal">[0-9]</code> は任意の数字を意味し、<code
                    class="literal">.</code> - ドット - は任意の文字を意味します)、数量 (<code
                    class="literal">s?</code> は <code
                    class="literal">s</code> または空文字列にマッチします、言い換えれば <code
                    class="literal">s</code> が 0 または 1 回出現したらマッチします; <code
                    class="literal">s+</code> は 1 つかそれ以上の連続する <code
                    class="literal">s</code> 文字列にマッチします; など)、を表現します。丸括弧を使うことで検索結果のグループ化が可能です。
				</div><div
                  class="para">
					正規表現の正確な構文は正規表現を取り扱うツールに依存しますが、基本的な機能は似ています。<div
                    class="url">→ <a
                      href="http://en.wikipedia.org/wiki/Regular_expression">http://en.wikipedia.org/wiki/Regular_expression</a></div>
				</div></div><div
                class="para">
					最初の正規表現は電子メールソフトウェアに関するヘッダを確認します; <code
                  class="literal">GOTO Sarbacane</code> (大量の電子メールを送信するソフトウェア) が見つかったら、メッセージを拒否します。2 番目の正規表現はメッセージの件名を操作します; メッセージの件名にウィルス通知が含まれる場合、そのメッセージを拒否しない代わりにすぐに捨てます。
				</div><div
                class="para">
					これらのフィルタを使うことは諸刃の剣です。なぜなら、一般的過ぎるルールを設定すれば、結果的に適切なメールを失うことになるからです。そのような場合、メッセージが失われるだけでなく、送信者は望まない (そして煩い) エラーメッセージを受け取ることになるでしょう。
				</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140393307573280"></a>11.1.4. <span
                      class="foreignphrase"><em
                        class="foreignphrase">greylisting</em></span> の設定</h3></div></div></div><a
              id="idm140393307572160"
              class="indexterm"></a><div
              class="para">
				「Greylisting」はフィルタリング技術です。この技術を使うことで、最初にメッセージを一時的なエラーコードと共に拒否し、少しの遅延の後に何回か試行すれば許可するというような挙動が可能です。このフィルタリングは特にワームとウィルスに侵された数多くのマシンが送信するスパムに対して効果的です。なぜなら、ワームやウィルスは完全な SMTP エージェントとして振る舞うことはほとんど無い (エラーコードを確認して失敗したメッセージを後から再試行することはほとんど無い) ですし、特に収集されたアドレスのほとんどは実際のところ無効という事を考慮すると、再試行は時間の無駄にしかならないからです。
			</div><div
              class="para">
				Postfix それ自身は greylisting 機能を提供しませんが、あるメッセージを受け入れるか拒否するかの決定を外部プログラムに委任する機能を提供します。<span
                class="pkg pkg">postgrey</span> パッケージには greylisting 機能を提供するプログラムが含まれ、アクセスポリシー委任サービスへのインターフェースとして設計されています。
			</div><div
              class="para">
				<span
                class="pkg pkg">postgrey</span> がインストールされると、postgrey はデーモンとして実行され、ポート 10023 番をリッスンします。この後 Postfix を設定します。<code
                class="literal">check_policy_service</code> パラメータを追加的制限として追加することで、postgrey を使うようになります:
			</div><pre
              class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023</pre><div
              class="para">
				Postfix はルールセットの中にあるこのルールに到達したら、<code
                class="command">postgrey</code> デーモンに接続し、対応するメッセージに関する情報をデーモンに送信します。Postgrey は IP アドレス/送信者/受信者の三つ揃いを考慮し、同じ三つ揃いが最近データベースに登録されたか否かをデータベースで確認します。最近登録されていた場合、Postgrey はメッセージを受け入れるべきであると応答します; 最近登録されていなかった場合、Postgrey はメッセージを一時的に拒否するべきであると応答し、三つ揃いをデータベースに登録します。
			</div><div
              class="para">
				greylisting の主な不都合は、正当なメッセージの配送が遅れる点です。これは常に受け入れられる欠点とは限りません。また、送信するメールのほとんどが正当な場合、greylisting はサーバの負荷を増加させます。
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>IN PRACTICE</em></span> greylisting の欠点</strong></p></div></div></div><div
                class="para">
				理論上、greylisting による遅延は、ある送信者からある受信者に送信される最初のメールだけを対象にし、典型的な遅延時間はほぼ数分程度です。しかしながら、実際は少し違います。一部の大きな ISP は SMTP サーバの集団を使います。このようなサーバの 1 つから送信要求されたメッセージは 1 回目の送信要求を拒否されますが、次に再度送信要求を出すサーバは 1 回目のサーバと違う可能性があります。これが起きた場合、2 回目のサーバは greylisting のお陰で一時的なエラーメッセージを応答します; 次の送信要求が、既に greylisting データベースに登録されているサーバに対して行われるまでには数時間かかる可能性があります。なぜなら、通常 SMTP サーバは再試行が失敗した場合に遅延時間を増やすからです。
			</div><div
                class="para">
				その結果、同じ送信者からであっても、送信要求を行う IP アドレスは毎回変わるかもしれません。更に踏み込むと: 送信者アドレスも変わる可能性があります。例えば、多くのメーリングリストサーバは送信者アドレス内の追加的な情報を符号化することで、エラーメッセージ (<span
                  class="emphasis"><em>bounces</em></span> として知られる) を取り扱う事が可能です。メーリングリスト宛に送信される新しいメッセージは greylisting を通過する事が必要かもしれません。これは新しいメッセージが送信者のサーバに (一時的に) 保存される事を意味します。とても巨大な (数万人が登録する) メーリングリストの場合、これは問題になる事があります。
			</div><div
                class="para">
				これらの欠点を軽減するために、Postgrey はそのようなサイトとメッセージのホワイトリストを管理します。そのような送信者から送信されたメッセージは greylisting を通過することなしにすぐに許可されます。簡単にこのリストをその場の要求に適用可能です。なぜなら、ホワイトリストは <code
                  class="filename">/etc/postgrey/whitelist_clients</code> ファイルに保存されているからです。
			</div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>GOING FURTHER</em></span> <span
                          class="pkg pkg">milter-greylist</span> を使った選択的 greylisting</strong></p></div></div></div><div
                class="para">
				このような greylisting の欠点を低減するには、既にスパムの発生源と考えられている (DNS ブラックリストに載せられている) サブネットのクライアントだけを対象に greylisting を使います。<span
                  class="pkg pkg">postgrey</span> ではこの機能を使う事ができませんが、<span
                  class="pkg pkg">milter-greylist</span> でこの機能を使います。
			</div><div
                class="para">
				この場合、DNS ブラックリストに載っていたからと言って必ず拒否されるわけではないので、より広範囲に及ぶブラックリストを使う事が妥当です。そのようなブラックリストには、ISP クライアントからのすべての動的 IP アドレスも含まれます (<code
                  class="literal">pbl.spamhaus.org</code> や <code
                  class="literal">dul.dnsbl.sorbs.net</code> などの)。
			</div><div
                class="para">
				milter-greylist は Sendmail の milter インターフェースを使うため、postfix 側からは「<code
                  class="literal">smtpd_milters = unix:/var/milter-greylist/milter-greylist.sock</code>」と設定する以上の事ができません。<span
                  class="citerefentry"><span
                    class="refentrytitle">greylist.conf</span>(5)</span> マニュアルページには、<code
                  class="filename">/etc/milter-greylist/greylist.conf</code> と milter-greylist を設定する様々な方法が書かれています。
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140393307549536"></a>11.1.5. 受信アドレスに基づくフィルタのカスタマイズ</h3></div></div></div><div
              class="para">
				上の 2 つの節で、様々な制限方法を見直しました。これらの制限方法はスパムの受信量を減らすためのものですが、欠点もあります。このため、受信者毎にフィルタのセットをカスタマイズする事が普通のやり方になりつつあります。Falcot Corp では、greylisting は多くのユーザにとって興味深いものでしたが、電子メールを素早く受け取りたい一部のユーザ (例えば技術サポートサービスなどの) にとっては仕事の妨げになります。同様に、商業サービスにとっては、ブラックリストに載っているかもしれない一部のアジアプロバイダから送信された電子メールを受信できない点は問題となります; 商業サービスにとっては、これらの送信者と連絡が取れるようにフィルタリングしないほうが都合が良いです。
			</div><div
              class="para">
				Postfix は「制限クラス」の概念を使ってフィルタをカスタマイズします。制限クラスは <code
                class="literal">smtpd_restriction_classes</code> パラメータの中で宣言され、<code
                class="literal">smtpd_recipient_restrictions</code> と同じやり方で使用されます。<code
                class="literal">check_recipient_access</code> 指示文は与えられた受信者と制限の適切なセットを対応付けるテーブルを定義します。
			</div><div
              class="example"><a
                id="idm140393307545328"></a><p
                class="title"><strong>例11.13 <code
                    class="filename">main.cf</code> 内の制限クラスの定義</strong></p><div
                class="example-contents"><pre
                  class="programlisting">smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access</pre></div></div><div
              class="example"><a
                id="idm140393307543216"></a><p
                class="title"><strong>例11.14 <code
                    class="filename">/etc/postfix/recipient_access</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting</pre></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="sect.postfix-antivirus"></a>11.1.6. アンチウイルスの統合</h3></div></div></div><a
              id="idm140393307539952"
              class="indexterm"></a><div
              class="para">
				数多くのウィルスが電子メールの添付ファイルとして配布されているため、会社のネットワークの入口にアンチウイルスをセットアップする事が重要です。なぜなら、啓蒙活動にも関わらず、一部のユーザは明らかに疑わしいメッセージの添付ファイルを開けるからです。
			</div><div
              class="para">
				Falcot 管理者はフリーのアンチウイルスとして <code
                class="command">clamav</code> を選びました。主要なパッケージは <span
                class="pkg pkg">clamav</span> ですが、<span
                class="pkg pkg">arj</span>、<span
                class="pkg pkg">unzoo</span>、<span
                class="pkg pkg">unrar</span>、<span
                class="pkg pkg">lha</span> などの幾つかの追加的パッケージもインストールしました。なぜなら、これらの追加的パッケージは、アンチウイルスがそれらのフォーマットで圧縮された添付ファイルを解析する際に必要だからです。
			</div><a
              id="idm140393307533568"
              class="indexterm"></a><a
              id="idm140393307532448"
              class="indexterm"></a><div
              class="para">
				<code
                class="command">clamav-milter</code> はアンチウイルスと電子メールサーバの間を接続する作業を担当します。<span
                class="emphasis"><em>milter</em></span> (<span
                class="emphasis"><em>mail filter</em></span> の略) とは、電子メールサーバに対するインターフェースとして特別に設計されたフィルタプログラムです。milter は標準的なアプリケーションプログラミングインターフェース (API) を使います。API を使うことで、電子メールサーバ外のフィルタの性能が向上します。Milter は 最初 <span
                class="emphasis"><em>Sendmail</em></span> に導入されましたが、<span
                class="emphasis"><em>Postfix</em></span> がすぐに後に続きました。
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>QUICK LOOK</em></span> Spamassassin 用の milter</strong></p></div></div></div><a
                id="idm140393307527088"
                class="indexterm"></a><div
                class="para">
				<span
                  class="pkg pkg">spamass-milter</span> パッケージは <span
                  class="emphasis"><em>SpamAssassin</em></span>、有名な迷惑メール検知ソフトウェア、に基づく milter を提供します。これは、(ヘッダを追加することで) スパムと思われるメッセージを注意するために使う事が可能です。さらにスパム度のスコアが与えられたしきい値を超えたらメッセージを拒否する事も可能です。
			</div></div><div
              class="para">
				<span
                class="pkg pkg">clamav-milter</span> パッケージをインストールしたら、milter をデフォルトのポートではない適当な TCP ポートで実行するように再設定するべきです。これを行うには、<code
                class="command">dpkg-reconfigure clamav-milter</code> を実行します。そして「Communication interface with Sendmail」が表示されたら「<code
                class="literal">inet:10002@127.0.0.1</code>」と答えます。
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NOTE</em></span> 真の TCP ポート vs 名前付きソケット</strong></p></div></div></div><div
                class="para">
				名前付きソケットではなく実在する TCP ポートを使う理由は、postfix デーモンは chroot された状態で実行され、名前付きソケットの存在するディレクトリにアクセスできないからです。名前付きソケットを使い、これを chroot 中 (<code
                  class="filename">/var/spool/postfix/</code>) に入れておく事も可能です。
			</div></div><div
              class="para">
				ClamAV の標準的な設定はほとんどの状況に適合しますが、<code
                class="command">dpkg-reconfigure clamav-base</code> を使えば幾つかの重要なパラメータをカスタマイズする事も可能です。
			</div><div
              class="para">
				最後の段階で、最近設定したフィルタを使うように Postfix を設定します。これは簡単です。<code
                class="filename">/etc/postfix/main.cf</code> に以下の指示文を追加します:
			</div><pre
              class="programlisting">
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002</pre><div
              class="para">
				アンチウイルスによって問題が起こる場合、この行をコメントアウトして、<code
                class="command">/etc/init.d/postfix reload</code> を実行します。これでこの変更が反映されます。
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>IN PRACTICE</em></span> アンチウイルスのテスト</strong></p></div></div></div><div
                class="para">
				アンチウイルスをセットアップしたら、正常な挙動をテストするべきです。最も簡単にテストすには、<code
                  class="filename">eicar.com</code> (または <code
                  class="filename">eicar.com.zip</code>) を添付したテストメールを送信します。このファイルはオンラインからダウンロード可能です: <div
                  class="url">→ <a
                    href="http://www.eicar.org/anti_virus_test_file.htm">http://www.eicar.org/anti_virus_test_file.htm</a></div>
			</div><div
                class="para">
				このファイルは、本物のウィルスではなくテストファイルです。市場に出ているすべてのアンチウイルスソフトウェアはこのファイルをウィルスと判定しますから、これを使うことでインストールの正しさを確認できます。
			</div></div><div
              class="para">
				これで Postfix の介して送信されるすべてのメッセージはアンチウイルスフィルタを通過するようになります。
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140393307510400"></a>11.1.7. SMTP 認証</h3></div></div></div><div
              class="para">
				電子メールを送信するには、SMTP サーバにアクセスする必要があります; つまり、電子メールを送信するには上で設定した SMTP サーバが必要です。ローミングユーザの場合、SMTP クライアントの設定を定期的に変更する必要があるかもしれません。なぜなら、Falcot の SMTP サーバは明らかに会社に所属しない IP アドレスから受け取ったメッセージを拒否するからです。2 つの解決策が存在します: ローミングユーザが自分のコンピュータに SMTP サーバをインストールするか、雇用者としての認証を済ませた後に会社のサーバを使うかのどちらか一方です。自分の SMTP サーバをインストールするという解決策は推奨されません。なぜなら、コンピュータは永久的に接続されているわけではないからです。さらに、問題の起きた際にメッセージを再送信する事ができないからです。我々は認証を行うという解決策に注目します。
			</div><div
              class="para">
				Postfix の SMTP 認証は SASL (<span
                class="emphasis"><em>Simple Authentication and Security Layer</em></span>) を使っています。SASL を使うには、<span
                class="pkg pkg">libsasl2-modules</span> と <span
                class="pkg pkg">sasl2-bin</span> パッケージをインストールする事と、SASL データベースに SMTP サーバの認証に必要なパスワードをユーザごとに登録する事、が必要です。これを行うには、<code
                class="command">saslpasswd2</code> コマンドを使います。このコマンドは幾つかのパラメータを取ります。<code
                class="literal">-u</code> オプションは認証するドメインを定義します。これは Postfix 設定の <code
                class="literal">smtpd_sasl_local_domain</code> パラメータと一致しなければいけません。<code
                class="literal">-c</code> オプションはユーザを作成します。<code
                class="literal">-f</code> は SASL データベースをデフォルト(<code
                class="filename">/etc/sasldb2</code>)とは異なる場所に保存する事が必要な場合、データベースファイルの位置を指定します。
			</div><pre
              class="screen scale">
<code
                class="computeroutput"># </code><strong
                class="userinput"><code>saslpasswd2 -u `postconf -h myhostname` -f /var/spool/postfix/etc/sasldb2 -c jean</code></strong>
<code
                class="computeroutput">[... type jean's password twice ...]</code></pre><div
              class="para">
				SASL データベースは Postfix ディレクトリの中に作成されなければいけない点に注意してください。整合性を確保するために、<code
                class="command">ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</code> コマンドを使って <code
                class="filename">/etc/sasldb2</code> を Postfix の使うデータベースを指すシンボリックリンクにします。
			</div><div
              class="para">
				この後に Postfix が SASL を使うように設定します。<code
                class="literal">postfix</code> ユーザを <code
                class="literal">sasl</code> グループに追加して、SASL アカウントデータベースにアクセスできるようにします。Postfix で SASL を有効化するには、いくつかの新しいパラメータが必要です。また、SASL 認証されたクライアントが自由に電子メールを送信する事を許可するには、<code
                class="literal">smtpd_recipient_restrictions</code> パラメータを設定します。
			</div><div
              class="example"><a
                id="idm140393307497248"></a><p
                class="title"><strong>例11.15 <code
                    class="filename">/etc/postfix/main.cf</code> の中で SASL を有効化</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> 認証済み SMTP クライアント</strong></p></div></div></div><div
                class="para">
				ほとんどの電子メールクライアントは、メッセージを送信する前に SMTP サーバに対して認証依頼する機能を持っており、適切なパラメータを設定するだけで簡単に SASL 認証機能を使う事が可能です。クライアントが SASL 認証機能を持たない場合、ローカル Postfix サーバを使い、リモート Postfix サーバに電子メールを中継するようにローカルサーバを設定する事が次善策です。この場合、ローカル Postfix が SASL を使って認証するクライアントになります。以下は必要なパラメータです:
			</div><pre
                class="programlisting">
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]</pre><div
                class="para">
				<code
                  class="filename">/etc/postfix/sasl_passwd</code> ファイルには、<code
                  class="literal">mail.falcot.com</code> サーバに認証を依頼する際に使うユーザ名とパスワードを含めます。以下は例です:
			</div><pre
                class="programlisting">
[mail.falcot.com]   joe:LyinIsji</pre><div
                class="para">
				すべての Postfix のマッピングファイルについて言える事ですが、<code
                  class="command">postmap</code> コマンドを使ってこのファイルを <code
                  class="filename">/etc/postfix/sasl_passwd.db</code> に変換しなければいけません。
			</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>戻る</strong>10.8. ネットワーク診断ツール</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上に戻る</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>ホーム</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>次へ</strong>11.2. ウェブサーバ (HTTP)</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/network-services.html">ar-MA</a></li><li><a
              href="../da-DK/network-services.html">da-DK</a></li><li><a
              href="../de-DE/network-services.html">de-DE</a></li><li><a
              href="../el-GR/network-services.html">el-GR</a></li><li><a
              href="../en-US/network-services.html">en-US</a></li><li><a
              href="../es-ES/network-services.html">es-ES</a></li><li><a
              href="../fa-IR/network-services.html">fa-IR</a></li><li><a
              href="../fr-FR/network-services.html">fr-FR</a></li><li><a
              href="../hr-HR/network-services.html">hr-HR</a></li><li><a
              href="../id-ID/network-services.html">id-ID</a></li><li><a
              href="../it-IT/network-services.html">it-IT</a></li><li><a
              href="../ja-JP/network-services.html">ja-JP</a></li><li><a
              href="../pl-PL/network-services.html">pl-PL</a></li><li><a
              href="../pt-BR/network-services.html">pt-BR</a></li><li><a
              href="../ro-RO/network-services.html">ro-RO</a></li><li><a
              href="../ru-RU/network-services.html">ru-RU</a></li><li><a
              href="../tr-TR/network-services.html">tr-TR</a></li><li><a
              href="../zh-CN/network-services.html">zh-CN</a></li></ul></div></body></html>
