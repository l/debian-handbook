<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">15.3. Creating a Package Repository for APT</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.1" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-zh-CN-1.0-1" /><meta
        name="keywords"
        content="Backport, Rebuild, Source package, Archive, Meta-package, Debian Developer, Maintainer" /><link
        rel="home"
        href="index.html"
        title="Debian 管理员手册" /><link
        rel="up"
        href="debian-packaging.html"
        title="第 15 章 Creating a Debian Package" /><link
        rel="prev"
        href="sect.building-first-package.html"
        title="15.2. Building your First Package" /><link
        rel="next"
        href="sect.becoming-package-maintainer.html"
        title="15.4. Becoming a Package Maintainer" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/zh-CN/sect.setup-apt-package-repository.html" /></head><body
      class="draft "><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="http://debian-handbook.info"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.building-first-package.html"><strong>上一页</strong></a></li><li
          class="home">Debian 管理员手册</li><li
          class="next"><a
            accesskey="n"
            href="sect.becoming-package-maintainer.html"><strong>下一页</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  id="sect.setup-apt-package-repository"></a>15.3. Creating a Package Repository for APT</h2></div></div></div><a
          id="idm140476746102048"
          class="indexterm"></a><a
          id="idm140476746101088"
          class="indexterm"></a><div
          class="para">
			Falcot Corp gradually started maintaining a number of Debian packages either locally modified from existing packages or created from scratch to distribute internal data and programs.
		</div><div
          class="para">
			To make deployment easier, they want to integrate these packages in a package archive that can be directly used by APT. For obvious maintenance reasons, they wish to separate internal packages from locally-rebuilt packages. The goal is for the matching entries in a <code
            class="filename">/etc/apt/sources.list</code> file to be as follows:
		</div><pre
          class="programlisting">
deb http://packages.falcot.com/ updates/
deb http://packages.falcot.com/ internal/
</pre><a
          id="idm140476746096880"
          class="indexterm"></a><div
          class="para">
			The administrators therefore configure a virtual host on their internal HTTP server, with <code
            class="filename">/srv/vhosts/packages/</code> as the root of the associated web space. The management of the archive itself is delegated to the <code
            class="command">mini-dinstall</code> command (in the similarly-named package). This tool keeps an eye on an <code
            class="filename">incoming/</code> directory (in our case, <code
            class="filename">/srv/vhosts/packages/mini-dinstall/incoming/</code>) and waits for new packages there; when a package is uploaded, it is installed into a Debian archive at <code
            class="filename">/srv/vhosts/packages/</code>. The <code
            class="command">mini-dinstall</code> command reads the <code
            class="filename">*.changes</code> file created when the Debian package is generated. These files contain a list of all other files associated with the version of the package (<code
            class="filename">*.deb</code>, <code
            class="filename">*.dsc</code>, <code
            class="filename">*.diff.gz</code>/<code
            class="filename">*.debian.tar.gz</code>, <code
            class="filename">*.orig.tar.gz</code>, or their equivalents with other compression tools), and these allow <code
            class="command">mini-dinstall</code> to know which files to install. <code
            class="filename">*.changes</code> files also contain the name of the target distribution (often <code
            class="literal">unstable</code>) mentioned in the latest <code
            class="filename">debian/changelog</code> entry, and <code
            class="command">mini-dinstall</code> uses this information to decide where the package should be installed. This is why administrators must always change this field before building a package, and set it to <code
            class="literal">internal</code> or <code
            class="literal">updates</code>, depending on the target location. <code
            class="command">mini-dinstall</code> then generates the files required by APT, such as <code
            class="filename">Packages.gz</code>.
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>ALTERNATIVE</em></span> <code
                      class="command">apt-ftparchive</code></strong></p></div></div></div><a
            id="idm140476746083568"
            class="indexterm"></a><div
            class="para">
			If <code
              class="command">mini-dinstall</code> seems too complex for your Debian archive needs, you can also use the <code
              class="command">apt-ftparchive</code> command. This tool scans the contents of a directory and displays (on its standard output) a matching <code
              class="filename">Packages</code> file. In the Falcot Corp case, administrators could upload the packages directly into <code
              class="filename">/srv/vhosts/packages/updates/</code> or <code
              class="filename">/srv/vhosts/packages/internal/</code>, then run the following commands to create the <code
              class="filename">Packages.gz</code> files:
		</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>cd /srv/vhosts/packages</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>apt-ftparchive packages updates &gt;updates/Packages</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>gzip updates/Packages</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>apt-ftparchive packages internal &gt;internal/Packages</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>gzip internal/Packages</code></strong></pre><div
            class="para">
			The <code
              class="command">apt-ftparchive sources</code> command allows creating <code
              class="filename">Sources.gz</code> files in a similar fashion.
		</div></div><div
          class="para">
			Configuring <code
            class="command">mini-dinstall</code> requires setting up a <code
            class="filename">~/.mini-dinstall.conf</code> file; in the Falcot Corp case, the contents are as follows:
		</div><pre
          class="programlisting">
[DEFAULT]
archive_style = flat
archivedir = /srv/vhosts/packages

verify_sigs = 0
mail_to = admin@falcot.com

generate_release = 1
release_origin = Falcot Corp
release_codename = stable

[updates]
release_label = Recompiled Debian Packages

[internal]
release_label = Internal Packages
</pre><div
          class="para">
			One decision worth noting is the generation of <code
            class="filename">Release</code> files for each archive. This can help manage package installation priorities using the <code
            class="filename">/etc/apt/preferences</code> configuration file (see <a
            class="xref"
            href="sect.apt-get.html#sect.apt.priorities">第 6.2.5 节 “Managing Package Priorities”</a> for details).
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>SECURITY</em></span> <code
                      class="command">mini-dinstall</code> and permissions</strong></p></div></div></div><div
            class="para">
			Since <code
              class="command">mini-dinstall</code> has been designed to run as a regular user, there's no need to run it as root. The easiest way is to configure everything within the user account belonging to the administrator in charge of creating the Debian packages. Since only this administrator has the required permissions to put files in the <code
              class="filename">incoming/</code> directory, we can deduce that the administrator authenticated the origin of each package prior to deployment and <code
              class="command">mini-dinstall</code> does not need to do it again. This explains the <code
              class="literal">verify_sigs = 0</code> parameter (which means that signatures need not be verified). However, if the contents of packages are sensitive, we can reverse the setting and elect to authenticate with a keyring containing the public keys of persons allowed to create packages (configured with the <code
              class="literal">extra_keyrings</code> parameter); <code
              class="command">mini-dinstall</code> will then check the origin of each incoming package by analyzing the signature integrated to the <code
              class="filename">*.changes</code> file.
		</div></div><div
          class="para">
			Invoking <code
            class="command">mini-dinstall</code> actually starts a daemon in the background. As long as this daemon runs, it will check for new packages in the <code
            class="filename">incoming/</code> directory every half-hour; when a new package arrives, it will be moved to the archive and the appropriate <code
            class="filename">Packages.gz</code> and <code
            class="filename">Sources.gz</code> files will be regenerated. If running a daemon is a problem, <code
            class="command">mini-dinstall</code> can also be manually invoked in batch mode (with the <code
            class="literal">-b</code> option) every time a package is uploaded into the <code
            class="filename">incoming/</code> directory. Other possibilities provided by <code
            class="command">mini-dinstall</code> are documented in its <span
            class="citerefentry"><span
              class="refentrytitle">mini-dinstall</span>(1)</span> manual page.
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>EXTRA</em></span> Generating a signed archive</strong></p></div></div></div><div
            class="para">
			The APT suite checks a chain of cryptographic signatures on the packages it handles before installing them (and has done so since <span
              class="distribution distribution">Etch</span>), in order to ensure their authenticity (see <a
              class="xref"
              href="sect.package-authentication.html">第 6.5 节 “Checking Package Authenticity”</a>). Private APT archives can then be a problem, since the machines using them will keep displaying warnings about unsigned packages. A diligent administrator will therefore integrate private archives with the secure APT mechanism.
		</div><div
            class="para">
			To help with this process, <code
              class="command">mini-dinstall</code> includes a <code
              class="literal">release_signscript</code> configuration option that allows specifying a script to use for generating the signature. A good starting point is the <code
              class="filename">sign-release.sh</code> script provided by the <span
              class="pkg pkg">mini-dinstall</span> package in <code
              class="filename">/usr/share/doc/mini-dinstall/examples/</code>; local changes may be relevant.
		</div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.building-first-package.html"><strong>上一页</strong>15.2. Building your First Package</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上一级</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>起始页</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.becoming-package-maintainer.html"><strong>下一页</strong>15.4. Becoming a Package Maintainer</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/sect.setup-apt-package-repository.html">ar-MA</a></li><li><a
              href="../da-DK/sect.setup-apt-package-repository.html">da-DK</a></li><li><a
              href="../de-DE/sect.setup-apt-package-repository.html">de-DE</a></li><li><a
              href="../el-GR/sect.setup-apt-package-repository.html">el-GR</a></li><li><a
              href="../en-US/sect.setup-apt-package-repository.html">en-US</a></li><li><a
              href="../es-ES/sect.setup-apt-package-repository.html">es-ES</a></li><li><a
              href="../fa-IR/sect.setup-apt-package-repository.html">fa-IR</a></li><li><a
              href="../fr-FR/sect.setup-apt-package-repository.html">fr-FR</a></li><li><a
              href="../hr-HR/sect.setup-apt-package-repository.html">hr-HR</a></li><li><a
              href="../id-ID/sect.setup-apt-package-repository.html">id-ID</a></li><li><a
              href="../it-IT/sect.setup-apt-package-repository.html">it-IT</a></li><li><a
              href="../ja-JP/sect.setup-apt-package-repository.html">ja-JP</a></li><li><a
              href="../pl-PL/sect.setup-apt-package-repository.html">pl-PL</a></li><li><a
              href="../pt-BR/sect.setup-apt-package-repository.html">pt-BR</a></li><li><a
              href="../ro-RO/sect.setup-apt-package-repository.html">ro-RO</a></li><li><a
              href="../ru-RU/sect.setup-apt-package-repository.html">ru-RU</a></li><li><a
              href="../tr-TR/sect.setup-apt-package-repository.html">tr-TR</a></li><li><a
              href="../zh-CN/sect.setup-apt-package-repository.html">zh-CN</a></li></ul></div></body></html>
