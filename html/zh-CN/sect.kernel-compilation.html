<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">8.10. Compiling a Kernel</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.1" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-zh-CN-1.0-1" /><meta
        name="keywords"
        content="Configuration, Localization, Locales, Network, Name resolution, Users, Groups, Accounts, Command-line interpreter, Shell, Printing, Bootloader, Kernel compiling" /><link
        rel="home"
        href="index.html"
        title="Debian 管理员手册" /><link
        rel="up"
        href="basic-configuration.html"
        title="第 8 章 Basic Configuration: Network, Accounts, Printing..." /><link
        rel="prev"
        href="sect.config-misc.html"
        title="8.9. Other Configurations: Time Synchronization, Logs, Sharing Access…" /><link
        rel="next"
        href="sect.kernel-installation.html"
        title="8.11. Installing a Kernel" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/zh-CN/sect.kernel-compilation.html" /></head><body
      class="draft "><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="http://debian-handbook.info"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.config-misc.html"><strong>上一页</strong></a></li><li
          class="home">Debian 管理员手册</li><li
          class="next"><a
            accesskey="n"
            href="sect.kernel-installation.html"><strong>下一页</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  id="sect.kernel-compilation"></a>8.10. Compiling a Kernel</h2></div></div></div><a
          id="idm140476753297344"
          class="indexterm"></a><a
          id="idm140476753295904"
          class="indexterm"></a><div
          class="para">
			The kernels provided by Debian include the largest possible number of features, as well as the maximum of drivers, in order to cover the broadest spectrum of existing hardware configurations. This is why some users prefer to recompile the kernel in order to only include what they specifically need. There are two reasons for this choice. First, it may be to optimize memory consumption, since the kernel code, even if it is never used, occupies memory for nothing (and never “goes down” on the swap space, since it is actual RAM that it uses), which can decrease overall system performance. A locally compiled kernel can also limit the risk of security problems since only a fraction of the kernel code is compiled and run.
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>NOTE</em></span> Security updates</strong></p></div></div></div><div
            class="para">
			If you choose to compile your own kernel, you must accept the consequences: Debian cannot ensure security updates for your custom kernel. By keeping the kernel provided by Debian, you benefit from updates prepared by the Debian Project's security team.
		</div></div><div
          class="para">
			Recompilation of the kernel is also necessary if you want to use certain features that are only available as patches (and not included in the standard kernel version).
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>GOING FURTHER</em></span> The Debian Kernel Handbook</strong></p></div></div></div><a
            id="idm140476753289536"
            class="indexterm"></a><div
            class="para">
			The Debian kernel teams maintains the “Debian Kernel Handbook” (also available in the <span
              class="pkg pkg">debian-kernel-handbook</span> package) with comprehensive documentation about most kernel related tasks and about how official Debian kernel packages are handled. This is the first place you should look into if you need more information than what is provided in this section. <div
              class="url">→ <a
                href="http://kernel-handbook.alioth.debian.org">http://kernel-handbook.alioth.debian.org</a></div>
		</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.kernel-compilation-prerequisites"></a>8.10.1. Introduction and Prerequisites</h3></div></div></div><div
            class="para">
				Unsurprisingly Debian manages the kernel in the form of a package, which is not how kernels have traditionally been compiled and installed. Since the kernel remains under the control of the packaging system, it can then be removed cleanly, or deployed on several machines. Furthermore, the scripts associated with these packages automate the interaction with the bootloader and the initrd generator.
			</div><div
            class="para">
				The upstream Linux sources contain everything needed to build a Debian package of the kernel. But you still need to install <span
              class="pkg pkg">build-essential</span> to ensure that you have the tools required to build a Debian package. Furthermore, the configuration step for the kernel requires the <span
              class="pkg pkg">libncurses5-dev</span> package. Finally, the <span
              class="pkg pkg">fakeroot</span> package will enable creation of the Debian package without using administrator's rights.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CULTURE</em></span> The good old days of <span
                        class="pkg pkg">kernel-package</span></strong></p></div></div></div><a
              id="idm140476753278688"
              class="indexterm"></a><div
              class="para">
				Before the Linux build system gained the ability to build proper Debian packages, the recommended way to build such packages was to use <code
                class="command">make-kpkg</code> from the <span
                class="pkg pkg">kernel-package</span> package.
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.kernel-sources"></a>8.10.2. Getting the Sources</h3></div></div></div><a
            id="idm140476753273904"
            class="indexterm"></a><a
            id="idm140476753272944"
            class="indexterm"></a><a
            id="idm140476753271504"
            class="indexterm"></a><div
            class="para">
				Like anything that can be useful on a Debian system, the Linux kernel sources are available in a package. To retrieve them, just install the <span
              class="pkg pkg">linux-source-<em
                class="replaceable">version</em></span> package. The <code
              class="command">apt-cache search ^linux-source</code> command lists the various kernel versions packaged by Debian. The latest version is available in the <span
              class="distribution distribution">Unstable</span> distribution: you can retrieve them without much risk (especially if your APT is configured according to the instructions of <a
              class="xref"
              href="sect.apt-get.html#sect.apt-mix-distros">第 6.2.6 节 “Working with Several Distributions”</a>). Note that the source code contained in these packages does not correspond precisely with that published by Linus Torvalds and the kernel developers; like all distributions, Debian applies a number of patches, which might (or might not) find their way into the upstream version of Linux. These modifications include backports of fixes/features/drivers from newer kernel versions, new features not yet (entirely) merged in the upstream Linux tree, and sometimes even Debian specific changes.
			</div><div
            class="para">
				The remainder of this section focuses on the 3.16 version of the Linux kernel, but the examples can, of course, be adapted to the particular version of the kernel that you want.
			</div><div
            class="para">
				We assume the <span
              class="pkg pkg">linux-source-3.16</span> package has been installed. It contains <code
              class="filename">/usr/src/linux-source-3.16.tar.xz</code>, a compressed archive of the kernel sources. You must extract these files in a new directory (not directly under <code
              class="filename">/usr/src/</code>, since there is no need for special permissions to compile a Linux kernel): <code
              class="filename">~/kernel/</code> is appropriate.
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>mkdir ~/kernel; cd ~/kernel</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>tar -xaf /usr/src/linux-source-3.16.tar.xz</code></strong></pre><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CULTURE</em></span> Location of kernel sources</strong></p></div></div></div><div
              class="para">
				Traditionally, Linux kernel sources would be placed in <code
                class="filename">/usr/src/linux/</code> thus requiring root permissions for compilation. However, working with administrator rights should be avoided when not needed. There is a <code
                class="literal">src</code> group that allows members to work in this directory, but working in <code
                class="filename">/usr/src/</code> should be avoided nevertheless. By keeping the kernel sources in a personal directory, you get security on all counts: no files in <code
                class="filename">/usr/</code> unknown to the packaging system, and no risk of misleading programs that read <code
                class="filename">/usr/src/linux</code> when trying to gather information on the used kernel.
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.config-noyau"></a>8.10.3. Configuring the Kernel</h3></div></div></div><a
            id="idm140476753254800"
            class="indexterm"></a><a
            id="idm140476753253360"
            class="indexterm"></a><a
            id="idm140476753251920"
            class="indexterm"></a><div
            class="para">
				The next step consists of configuring the kernel according to your needs. The exact procedure depends on the goals.
			</div><div
            class="para">
				When recompiling a more recent version of the kernel (possibly with an additional patch), the configuration will most likely be kept as close as possible to that proposed by Debian. In this case, and rather than reconfiguring everything from scratch, it is sufficient to copy the <code
              class="filename">/boot/config-<em
                class="replaceable">version</em></code> file (the version is that of the kernel currently used, which can be found with the <code
              class="command">uname -r</code> command) into a <code
              class="filename">.config</code> file in the directory containing the kernel sources.
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>cp /boot/config-3.16.0-4-amd64 ~/kernel/linux-source-3.16/.config</code></strong></pre><div
            class="para">
				Unless you need to change the configuration, you can stop here and skip to the next section. If you need to change it, on the other hand, or if you decide to reconfigure everything from scratch, you must take the time to configure your kernel. There are various dedicated interfaces in the kernel source directory that can be used by calling the <code
              class="command">make <em
                class="replaceable">target</em></code> command, where <em
              class="replaceable">target</em> is one of the values described below.
			</div><div
            class="para">
				<code
              class="command">make menuconfig</code> compiles and executes a text-mode interface (this is where the <span
              class="pkg pkg">libncurses5-dev</span> package is required) which allows navigating the options available in a hierarchical structure. Pressing the <span
              class="keycap"><strong>Space</strong></span> key changes the value of the selected option, and <span
              class="keycap"><strong>Enter</strong></span> validates the button selected at the bottom of the screen; <span
              class="guibutton"><strong>Select</strong></span> returns to the selected sub-menu; <span
              class="guibutton"><strong>Exit</strong></span> closes the current screen and moves back up in the hierarchy; <span
              class="guibutton"><strong>Help</strong></span> will display more detailed information on the role of the selected option. The arrow keys allow moving within the list of options and buttons. To exit the configuration program, choose <span
              class="guibutton"><strong>Exit</strong></span> from the main menu. The program then offers to save the changes you've made; accept if you are satisfied with your choices.
			</div><div
            class="para">
				Other interfaces have similar features, but they work within more modern graphical interfaces; such as <code
              class="command">make xconfig</code> which uses a Qt graphical interface, and <code
              class="command">make gconfig</code> which uses GTK+. The former requires <span
              class="pkg pkg">libqt4-dev</span>, while the latter depends on <span
              class="pkg pkg">libglade2-dev</span> and <span
              class="pkg pkg">libgtk2.0-dev</span>.
			</div><div
            class="para">
				When using one of those configuration interfaces, it's always a good idea to start from a reasonable default configuration. The kernel provides such configurations in <code
              class="filename">arch/<em
                class="replaceable">arch</em>/configs/*_defconfig</code> and you can put your selected configuration in place with a command like <code
              class="command">make x86_64_defconfig</code> (in the case of a 64-bit PC) or <code
              class="command">make i386_defconfig</code> (in the case of a 32-bit PC).
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>TIP</em></span> Dealing with outdated <code
                        class="filename">.config</code> files</strong></p></div></div></div><div
              class="para">
				When you provide a <code
                class="filename">.config</code> file that has been generated with another (usually older) kernel version, you will have to update it. You can do so with <code
                class="command">make oldconfig</code>, it will interactively ask you the questions corresponding to the new configuration options. If you want to use the default answer to all those questions you can use <code
                class="command">make olddefconfig</code>. With <code
                class="command">make oldnoconfig</code>, it will assume a negative answer to all questions.
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.kernel-build"></a>8.10.4. Compiling and Building the Package</h3></div></div></div><a
            id="idm140476753227376"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>NOTE</em></span> Clean up before rebuilding</strong></p></div></div></div><div
              class="para">
				If you have already compiled once in the directory and wish to rebuild everything from scratch (for example because you substantially changed the kernel configuration), you will have to run <code
                class="command">make clean</code> to remove the compiled files. <code
                class="command">make distclean</code> removes even more generated files, including your <code
                class="filename">.config</code> file too, so make sure to backup it first.
			</div></div><div
            class="para">
				Once the kernel configuration is ready, a simple <code
              class="command">make deb-pkg</code> will generate up to 5 Debian packages: <span
              class="pkg pkg">linux-image-<em
                class="replaceable">version</em></span> that contains the kernel image and the associated modules, <span
              class="pkg pkg">linux-headers-<em
                class="replaceable">version</em></span> which contains the header files required to build external modules, <span
              class="pkg pkg">linux-image-<em
                class="replaceable">version</em>-dbg</span> which contains the debugging symbols for the kernel image and its modules, and <span
              class="pkg pkg">linux-libc-dev</span> which contains headers relevant to some user space libraries like GNU glibc.
			</div><div
            class="para">
				The <em
              class="replaceable">version</em> is defined by the concatenation of the upstream version (as defined by the variables <code
              class="literal">VERSION</code>, <code
              class="literal">PATCHLEVEL</code>, <code
              class="literal">SUBLEVEL</code> and <code
              class="literal">EXTRAVERSION</code> in the <code
              class="filename">Makefile</code>), of the <code
              class="literal">LOCALVERSION</code> configuration parameter, and of the <code
              class="literal">LOCALVERSION</code> environment variable. The package version reuses the same version string with an appended revision that is regularly incremented (and stored in <code
              class="filename">.version</code>), except if you override it with the <code
              class="literal">KDEB_PKGVERSION</code> environment variable.
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>make deb-pkg LOCALVERSION=-falcot KDEB_PKGVERSION=1</code></strong>
[...]
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>ls ../*.deb</code></strong>
<code
              class="computeroutput">../linux-headers-3.16.7-ckt4-falcot_1_amd64.deb
../linux-image-3.16.7-ckt4-falcot_1_amd64.deb
../linux-image-3.16.7-ckt4-falcot-dbg_1_amd64.deb
../linux-libc-dev_1_amd64.deb
</code></pre></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.modules-build"></a>8.10.5. Compiling External Modules</h3></div></div></div><a
            id="idm140476753208720"
            class="indexterm"></a><a
            id="idm140476753207280"
            class="indexterm"></a><a
            id="idm140476753205840"
            class="indexterm"></a><div
            class="para">
				Some modules are maintained outside of the official Linux kernel. To use them, they must be compiled alongside the matching kernel. A number of common third party modules are provided by Debian in dedicated packages, such as <span
              class="pkg pkg">xtables-addons-source</span> (extra modules for iptables) or <span
              class="pkg pkg">oss4-source</span> (Open Sound System, some alternative audio drivers).
			</div><div
            class="para">
				These external packages are many and varied and we won't list them all here; the <code
              class="command">apt-cache search source$</code> command can narrow down the search field. However, a complete list isn't particularly useful since there is no particular reason for compiling external modules except when you know you need it. In such cases, the device's documentation will typically detail the specific module(s) it needs to function under Linux.
			</div><div
            class="para">
				For example, let's look at the <span
              class="pkg pkg">xtables-addons-source</span> package: after installation, a <code
              class="filename">.tar.bz2</code> of the module's sources is stored in <code
              class="filename">/usr/src/</code>. While we could manually extract the tarball and build the module, in practice we prefer to automate all this using DKMS. Most modules offer the required DKMS integration in a package ending with a <code
              class="literal">-dkms</code> suffix. In our case, installing <span
              class="pkg pkg">xtables-addons-dkms</span> is all that is needed to compile the kernel module for the current kernel provided that we have the <span
              class="pkg pkg">linux-headers-*</span> package matching the installed kernel. For instance, if you use <span
              class="pkg pkg">linux-image-amd64</span>, you would also install <span
              class="pkg pkg">linux-headers-amd64</span>.
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>sudo apt-get install xtables-addons-common-dkms</code></strong>
<code
              class="computeroutput">
[...]
Setting up xtables-addons-dkms (2.6-1) ...
Loading new xtables-addons-2.6 DKMS files...
First Installation: checking all kernels...
Building only for 3.16.0-4-amd64
Building initial module for 3.16.0-4-amd64
Done.

xt_ACCOUNT:
Running module version sanity check.
 - Original module
   - No original module exists within this kernel
 - Installation
   - Installing to /lib/modules/3.16.0-4-amd64/updates/dkms/
[...]
DKMS: install completed.
$ </code><strong
              class="userinput"><code>sudo dkms status</code></strong>
<code
              class="computeroutput">xtables-addons, 2.6, 3.16.0-4-amd64, x86_64: installed
$ </code><strong
              class="userinput"><code>sudo modinfo xt_ACCOUNT</code></strong>
<code
              class="computeroutput">filename:       /lib/modules/3.16.0-4-amd64/updates/dkms/xt_ACCOUNT.ko
license:        GPL
alias:          ipt_ACCOUNT
author:         Intra2net AG &lt;opensource@intra2net.com&gt;
description:    Xtables: per-IP accounting for large prefixes
[...]
</code></pre><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>ALTERNATIVE</em></span> module-assistant</strong></p></div></div></div><a
              id="idm140476753190272"
              class="indexterm"></a><div
              class="para">
				Before DKMS, <span
                class="pkg pkg">module-assistant</span> was the simplest solution to build and deploy kernel modules. It can still be used, in particular for packages lacking DKMS integration: with a simple command like <code
                class="command">module-assistant auto-install xtables-addons</code> (or <code
                class="command">m-a a-i xtables-addons</code> for short), the modules are compiled for the current kernel, put in a new Debian package, and that package gets installed on the fly.
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="sect.kernel-patch"></a>8.10.6. Applying a Kernel Patch</h3></div></div></div><a
            id="idm140476753184896"
            class="indexterm"></a><a
            id="idm140476753183456"
            class="indexterm"></a><div
            class="para">
				Some features are not included in the standard kernel due to a lack of maturity or to some disagreement with the kernel maintainers. Such features may be distributed as patches that anyone is then free to apply to the kernel sources.
			</div><div
            class="para">
				Debian distributes some of these patches in <span
              class="pkg pkg">linux-patch-*</span> or <span
              class="pkg pkg">kernel-patch-*</span> packages (for instance, <span
              class="pkg pkg">linux-patch-grsecurity2</span>, which tightens some of the kernel's security policies). These packages install files in the <code
              class="filename">/usr/src/kernel-patches/</code> directory.
			</div><div
            class="para">
				To apply one or more of these installed patches, use the <code
              class="command">patch</code> command in the sources directory then start compilation of the kernel as described above.
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>cd ~/kernel/linux-source-3.16</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>make clean</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>zcat /usr/src/kernel-patches/diffs/grsecurity2/grsecurity-3.0-3.17.1-201410250027.patch.gz | patch -p1</code></strong></pre><div
            class="para">
				Note that a given patch may not necessarily work with every version of the kernel; it is possible for <code
              class="command">patch</code> to fail when applying them to kernel sources. An error message will be displayed and give some details about the failure; in this case, refer to the documentation available in the Debian package of the patch (in the <code
              class="filename">/usr/share/doc/linux-patch-*/</code> directory). In most cases, the maintainer indicates for which kernel versions their patch is intended.
			</div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.config-misc.html"><strong>上一页</strong>8.9. Other Configurations: Time Synchronization, ...</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上一级</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>起始页</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.kernel-installation.html"><strong>下一页</strong>8.11. Installing a Kernel</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/sect.kernel-compilation.html">ar-MA</a></li><li><a
              href="../da-DK/sect.kernel-compilation.html">da-DK</a></li><li><a
              href="../de-DE/sect.kernel-compilation.html">de-DE</a></li><li><a
              href="../el-GR/sect.kernel-compilation.html">el-GR</a></li><li><a
              href="../en-US/sect.kernel-compilation.html">en-US</a></li><li><a
              href="../es-ES/sect.kernel-compilation.html">es-ES</a></li><li><a
              href="../fa-IR/sect.kernel-compilation.html">fa-IR</a></li><li><a
              href="../fr-FR/sect.kernel-compilation.html">fr-FR</a></li><li><a
              href="../hr-HR/sect.kernel-compilation.html">hr-HR</a></li><li><a
              href="../id-ID/sect.kernel-compilation.html">id-ID</a></li><li><a
              href="../it-IT/sect.kernel-compilation.html">it-IT</a></li><li><a
              href="../ja-JP/sect.kernel-compilation.html">ja-JP</a></li><li><a
              href="../pl-PL/sect.kernel-compilation.html">pl-PL</a></li><li><a
              href="../pt-BR/sect.kernel-compilation.html">pt-BR</a></li><li><a
              href="../ro-RO/sect.kernel-compilation.html">ro-RO</a></li><li><a
              href="../ru-RU/sect.kernel-compilation.html">ru-RU</a></li><li><a
              href="../tr-TR/sect.kernel-compilation.html">tr-TR</a></li><li><a
              href="../zh-CN/sect.kernel-compilation.html">zh-CN</a></li></ul></div></body></html>
