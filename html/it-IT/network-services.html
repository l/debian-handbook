<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">Capitolo 11. Servizi di rete: Postfix, Apache, NFS, Samba, Squid, LDAP</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.1" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-it-IT-1.0-1" /><meta
        name="keywords"
        content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP" /><link
        rel="home"
        href="index.html"
        title="Il manuale dell'amministratore Debian" /><link
        rel="up"
        href="index.html"
        title="Il manuale dell'amministratore Debian" /><link
        rel="prev"
        href="sect.network-diagnosis-tools.html"
        title="10.8. Strumenti di diagnosi di rete" /><link
        rel="next"
        href="sect.http-web-server.html"
        title="11.2. Server web (HTTP)" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/it-IT/network-services.html" /></head><body
      class="draft "><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="http://debian-handbook.info"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>Indietro</strong></a></li><li
          class="home">Il manuale dell'amministratore Debian</li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>Avanti</strong></a></li></ul><div
        xml:lang="it-IT"
        class="chapter"
        lang="it-IT"><div
          class="titlepage"><div><div><h1
                class="title"><a
                  id="network-services"></a>Capitolo 11. Servizi di rete: Postfix, Apache, NFS, Samba, Squid, LDAP</h1></div></div></div><div
          class="toc"><dl
            class="toc"><dt><span
                class="section"><a
                  href="network-services.html#sect.smtp-mail-server">11.1. Mail Server</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="network-services.html#idm140618329027936">11.1.1. Installare Postfix</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140618335470880">11.1.2. Configurare i domini virtuali</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140618337068864">11.1.3. Restrizioni per ricezione ed invio</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140618336115120">11.1.4. Impostare il <span
                        class="foreignphrase"><em
                          class="foreignphrase">greylisting</em></span></a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140618336092704">11.1.5. Personalizzare i filtri in base al destinatario</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#sect.postfix-antivirus">11.1.6. Integrare un antivirus</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140618336054528">11.1.7. SMTP autenticato</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-web-server.html">11.2. Server web (HTTP)</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140618336018192">11.2.1. Installare Apache</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140618335923296">11.2.2. Configurare gli host virtuali</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140618335899808">11.2.3. Direttive comuni</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140618335818048">11.2.4. Analizzatori di log</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ftp-file-server.html">11.3. Server di file FTP</a></span></dt><dt><span
                class="section"><a
                  href="sect.nfs-file-server.html">11.4. Server di file NFS</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140618335758080">11.4.1. Mettere in sicurezza NFS</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140618335722640">11.4.2. Server NFS</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140618314587392">11.4.3. Client NFS</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.windows-file-server-with-samba.html">11.5. Configurare condivisioni Windows con Samba</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm140618314568320">11.5.1. Server Samba</a></span></dt><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm140618314518096">11.5.2. Client Samba</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-ftp-proxy.html">11.6. Proxy HTTP/FTP</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140618314478416">11.6.1. Installazione</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140618314473104">11.6.2. Configurare una cache</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140618314469328">11.6.3. Configurare un filtro</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ldap-directory.html">11.7. Directory LDAP</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140618314446800">11.7.1. Installazione</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140618314427504">11.7.2. Riempire la directory</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140618314398336">11.7.3. Gestire gli account con LDAP</a></span></dt></dl></dd></dl></div><div
          class="highlights"><div
            class="para">
		I servizi di rete sono i programmi con cui gli utenti interagiscono direttamente durante le loro attività quotidiane e sono la punta dell'iceberg del sistema informativo. In questo capitolo ci concentreremo su di loro: le componenti invisibili a cui si affidano sono l'infrastruttura che abbiamo descritto precedentemente.
	</div></div><div
          class="section"><div
            class="titlepage"><div><div><h2
                  class="title"><a
                    id="sect.smtp-mail-server"></a>11.1. Mail Server</h2></div></div></div><div
            class="para">
			Gli amministratori della Falcot Corporation hanno scelto Postfix come loro server di posta elettronica per via della sua affidabilità e per la semplicità di configurazione. Allo stesso modo il suo design assicura che ogni operazione sia eseguita in un processo con l'insieme minimo di permessi richiesti, cosa che garantisce una misura ottimale contro i problemi di sicurezza.
		</div><a
            id="idm140618324842912"
            class="indexterm"></a><a
            id="idm140618319102240"
            class="indexterm"></a><a
            id="idm140618320003632"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>ALTERNATIVA</em></span> Il server Exim4</strong></p></div></div></div><a
              id="idm140618330473728"
              class="indexterm"></a><div
              class="para">
			Debian utilizza Exim4 come server di posta predefinito (per questo l'installazione iniziale include Exim4). La configurazione è fornita da un pacchetto separato, <span
                class="pkg pkg">exim4-config</span>, e viene automaticamente personalizzata in base alle risposte fornite ad un insieme di quesiti posti da Debconf in modo molto simile a come avviene con le domande poste dal pacchetto <span
                class="pkg pkg">postfix</span>.
		</div><div
              class="para">
			The configuration can be either in one single file (<code
                class="filename">/etc/exim4/exim4.conf.template</code>) or split across a number of configuration snippets stored under <code
                class="filename">/etc/exim4/conf.d/</code>. In both cases, the files are used by <code
                class="command">update-exim4.conf</code> as templates to generate <code
                class="filename">/var/lib/exim4/config.autogenerated</code>. The latter is the file used by Exim4. Thanks to this mechanism, values obtained through Exim's debconf configuration — which are stored in <code
                class="filename">/etc/exim4/update-exim4.conf.conf</code> — can be injected in Exim's configuration file, even when the administrator or another package has altered the default Exim configuration.
		</div><div
              class="para">
			La sintassi dei file di configurazione di Exim4 ha le sue peculiarità e la sua curva di apprendimento. Una volta comprese queste peculiarità Exim4 è un server di posta veramente completo e potente come testimoniano le decine di pagine di documentazione. <div
                class="url">→ <a
                  href="http://www.exim.org/docs.html">http://www.exim.org/docs.html</a></div>
		</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140618329027936"></a>11.1.1. Installare Postfix</h3></div></div></div><div
              class="para">
				The <span
                class="pkg pkg">postfix</span> package includes the main SMTP daemon. Other packages (such as <span
                class="pkg pkg">postfix-ldap</span> and <span
                class="pkg pkg">postfix-pgsql</span>) add extra functionality to Postfix, including access to mapping databases. You should only install them if you know that you need them.
			</div><div
              class="sidebar"><a
                id="sidebar.smtp"></a><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>FONDAMENTALI</em></span> SMTP</strong></p></div></div></div><a
                id="idm140618315009216"
                class="indexterm"></a><a
                id="idm140618315008256"
                class="indexterm"></a><a
                id="idm140618315007328"
                class="indexterm"></a><div
                class="para">
				SMTP (<span
                  class="emphasis"><em>Simple Mail Transfer Protocol</em></span>) è il protocollo utilizzato dai server di posta per scambiare ed instradare le email.
			</div></div><div
              class="para">
				Saranno posti diversi quesiti Defconf durante l'installazione del pacchetto. Le risposte consentono di generare una prima versione del file di configurazione <code
                class="filename">/etc/postfix/main.cf</code>.
			</div><div
              class="para">
				La prima domanda riguarda la tipologia di configurazione. Solo due delle risposte proposte sono rilevanti nel caso in cui il server sia connesso ad Internet: «Sito internet» e «Sito internet con smarthost». La prima opzione è appropriata per un server che riceve la posta in arrivo ed invia le email in uscita direttamente ai rispettivi destinatari: pertanto si adatta bene al caso della Falcot Corporation. La seconda opzione è appropriata per un server che riceve le email in arrivo normalmente ma che invia le email in uscita attraverso un server SMTP intermedio, lo «smarthost», anziché consegnarle direttamente al server del destinatario. Questo è particolarmente utile per chi ha con un indirizzo IP dinamico poiché molti server di posta rifiutano i messaggi che arrivano direttamente da questo tipo di indirizzo. In questo caso lo smarthost sarà generalmente il server SMTP dell'ISP che a sua volta è configurato per accettare ed inoltrare in modo appropriato le email provenienti dai clienti. Questo tipo di configurazione (con smarthost) è rilevante anche per i server che non sono costantemente connessi ad internet poiché evita di dover gestire una coda di messaggi non consegnabili da dover riprovare a inviare in seguito.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>VOCABOLARIO</em></span> ISP</strong></p></div></div></div><a
                id="idm140618320102528"
                class="indexterm"></a><div
                class="para">
				ISP è l'acronimo per «Internet Service Provider». Rappresenta un'entità, spesso un'azienda, che fornisce connessioni ad Internet ed i servizi base correlati (email, news e così via).
			</div><div
                class="para">
			</div></div><div
              class="para">
				La seconda domanda riguarda il nome completo della macchina, utilizzato per generare gli indirizzi email a partire dal nome utente locale. Il nome completo della macchina appare dopo la chiocciola («@»). Nel caso della Falcot, la risposta dovrebbe essere <code
                class="literal">mail.falcot.com</code>. Questa è l'unica domanda posta in via predefinita tuttavia la configurazione a cui porta non è sufficientemente completa per le necessità della Falcot: per questo motivo gli amministratori eseguono <code
                class="command">dpkg-reconfigure postfix</code> per poter personalizzare altri parametri.
			</div><div
              class="para">
				One of the extra questions asks for all the domain names related to this machine. The default list includes its full name as well as a few synonyms for <code
                class="literal">localhost</code>, but the main <code
                class="literal">falcot.com</code> domain needs to be added by hand. More generally, this question should usually be answered with all the domain names for which this machine should serve as an MX server; in other words, all the domain names for which the DNS says that this machine will accept email. This information ends up in the <code
                class="literal">mydestination</code> variable of the main Postfix configuration file — <code
                class="filename">/etc/postfix/main.cf</code>.
			</div><a
              id="idm140618337234112"
              class="indexterm"></a><a
              id="idm140618337232672"
              class="indexterm"></a><div
              class="figure"><a
                id="idm140618337231232"></a><div
                class="figure-contents"><div
                  class="mediaobject"><img
                    src="images/mail-server.png"
                    alt="Ruolo del record MX nel DNS durante l'invio di un'email" /></div></div><p
                class="title"><strong>Figura 11.1. Ruolo del record <span
                    class="emphasis"><em>MX</em></span> nel DNS durante l'invio di un'email</strong></p></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> Interrogare i record MX</strong></p></div></div></div><div
                class="para">
				Quando il DNS non ha un record MX per un dominio, il server di posta tenterà di inviare i messaggi allo stesso host utilizzando il record A corrispondente (o AAAA in IPv6).
			</div></div><div
              class="para">
				In alcuni casi l'installazione può anche chiedere quali reti devono essere autorizzate ad inviare email attraverso la macchina. Nella sua configurazione predefinita Postfix accetta unicamente email provenienti dalla macchina che lo ospita; la rete locale viene generalmente aggiunta. Gli amministratori della Falcot Corporation hanno aggiunto <code
                class="literal">192.168.0.0/16</code> alla risposta predefinita. Se la domanda non è posta, la relativa variabile nel file di configurazione è <code
                class="literal">mynetworks</code> come si vede nell'esempio qui sotto.
			</div><div
              class="para">
				Le email locali possono anche essere consegnate con <code
                class="command">procmail</code>. Questo strumento consente agli utenti di elaborare le loro email in arrivo attraverso le regole conservare nel file <code
                class="filename">~/.procmailrc</code>.
			</div><a
              id="idm140618337222464"
              class="indexterm"></a><a
              id="idm140618337221344"
              class="indexterm"></a><a
              id="idm140618337219904"
              class="indexterm"></a><div
              class="para">
				Dopo questa prima fase gli amministratori dispongono del file di configurazione seguente; sarà utilizzato come punto di partenza per aggiungere alcune funzionalità addizionali nelle prossime sezioni.
			</div><div
              class="example"><a
                id="idm140618335477696"></a><p
                class="title"><strong>Esempio 11.1. File <code
                    class="filename">/etc/postfix/main.cf</code> iniziale</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SICUREZZA</em></span> Certificati SSL <span
                          class="emphasis"><em>Snake oil</em></span></strong></p></div></div></div><div
                class="para">
				I certificati <span
                  class="emphasis"><em>snake oil</em></span>, come le omonime «medicine» vendute da antichi ciarlatani, non hanno alcun valore poiché sono generati in modo similare in tutti i sistemi Debian con la stessa componente «privata». Possono essere impiegati unicamente per i test ed i servizi normali devono utilizzare unicamente certificati reali che possono essere generati con la procedura descritta in <a
                  class="xref"
                  href="sect.virtual-private-network.html#sect.easy-rsa">Sezione 10.2.1.1, «Infrastruttura a chiave pubblica: <span
                    class="emphasis"><em>easy-rsa</em></span>»</a>.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140618335470880"></a>11.1.2. Configurare i domini virtuali</h3></div></div></div><a
              id="idm140618335470112"
              class="indexterm"></a><a
              id="idm140618335468672"
              class="indexterm"></a><div
              class="para">
				Il server di posta può ricevere anche email indirizzate ad altri domini oltre a quello principale: questi domini sono indicati come «domini virtuali». In molti casi, dove questo avviene, le email non sono destinate ad utenti locali. Postfix fornisce due funzionalità interessanti per gestire i domini virtuali.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>ATTENZIONE</em></span> Domini virtuali e domini canonici</strong></p></div></div></div><div
                class="para">
				Nessuno dei domini virtuali dev'essere riportato nella variabile <code
                  class="literal">mydestination</code>. Questa variabile contiene unicamente i nomi dei domini «canonici» direttamente associati alla macchina ed ai suoi utenti locali.
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140618335464544"></a>11.1.2.1. Domini virtuali alias</h4></div></div></div><a
                id="idm140618335463744"
                class="indexterm"></a><a
                id="idm140618337099168"
                class="indexterm"></a><div
                class="para">
					Un dominio virtuale alias contiene solo indirizzi alias, cioè indirizzi che si occupano di inoltrare le email ad altri indirizzi.
				</div><div
                class="para">
					Questo tipo di dominio sarà abilitato aggiungendo il suo nome alla variabile <code
                  class="literal">virtual_alias_domains</code> ed indicando un file di mappatura indirizzi nella variabile <code
                  class="literal">virtual_alias_maps</code>.
				</div><div
                class="example"><a
                  id="idm140618337095664"></a><p
                  class="title"><strong>Esempio 11.2. Direttive da aggiungere nel file <code
                      class="filename">/etc/postfix/main.cf</code>.</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual
</pre></div></div><div
                class="para">
					The <code
                  class="filename">/etc/postfix/virtual</code> file describes a mapping with a rather straightforward syntax: each line contains two fields separated by whitespace; the first field is the alias name, the second field is a list of email addresses where it redirects. The special <code
                  class="literal">@domain.com</code> syntax covers all remaining aliases in a domain.
				</div><div
                class="example"><a
                  id="idm140618337092176"></a><p
                  class="title"><strong>Esempio 11.3. File <code
                      class="filename">/etc/postfix/virtual</code> di esempio</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# The alias below is generic and covers all addresses within 
# the falcotsbrand.com domain not otherwise covered by this file.
# These addresses forward email to the same user name in the
# falcot.com domain.
@falcotsbrand.com           @falcot.com
</pre></div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140618337089760"></a>11.1.2.2. Caselle di posta su domini virtuali</h4></div></div></div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>ATTENZIONE</em></span> Domini virtuali combinati?</strong></p></div></div></div><div
                  class="para">
					Postfix non consente di utilizzare contemporaneamente lo stesso dominio in <code
                    class="literal">virtual_alias_domains</code> e <code
                    class="literal">virtual_mailbox_domains</code>. Comunque ogni dominio di <code
                    class="literal">virtual_mailbox_domains</code> viene implicitamente incluso in <code
                    class="literal">virtual_alias_domains</code>, cosa che permette di mescolare caselle ed alias all'interno di un dominio virtuale.
				</div></div><a
                id="idm140618337085472"
                class="indexterm"></a><a
                id="idm140618337084544"
                class="indexterm"></a><div
                class="para">
					I messaggi indirizzati ad una casella su di un dominio virtuale sono conservati in caselle di posta non assegnate ad un utente locale del sistema.
				</div><div
                class="para">
					Abilitare una casella di posta in un dominio virtuale richiede di inserire il dominio nella variabile <code
                  class="literal">virtual_mailbox_domains</code> fornendo un file di mappatura caselle in <code
                  class="literal">virtual_mailbox_maps</code>. Il parametro <code
                  class="literal">virtual_mailbox_base</code> contiene la directory dove le caselle di posta saranno conservate.
				</div><div
                class="para">
					The <code
                  class="literal">virtual_uid_maps</code> parameter (respectively <code
                  class="literal">virtual_gid_maps</code>) references the file containing the mapping between the email address and the system user (respectively group) that “owns” the corresponding mailbox. To get all mailboxes owned by the same owner/group, the <code
                  class="literal">static:5000</code> syntax assigns a fixed UID/GID (of value 5000 here).
				</div><div
                class="example"><a
                  id="idm140618337078400"></a><p
                  class="title"><strong>Esempio 11.4. Direttive da aggiungere nel file <code
                      class="filename">/etc/postfix/main.cf</code>.</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts
</pre></div></div><div
                class="para">
					Ancora una volta, la sintassi del file <code
                  class="filename">/etc/postfix/vmailbox</code> è piuttosto lineare: due campi separati da uno spazio. Il primo campo è un indirizzo email all'interno di uno dei domini virtuali e il secondo campo è la posizione della casella di posta associata (relativamente alla directory specificata in <span
                  class="emphasis"><em>virtual_mailbox_base</em></span>). Se il nome della casella di posta termina con una barra (<code
                  class="literal">/</code>) le email saranno conservate nel formato <span
                  class="emphasis"><em>maildir</em></span>, diversamente sarà utilizzato il formato tradizionale <span
                  class="emphasis"><em>mbox</em></span>. Il formato di <span
                  class="emphasis"><em>maildir</em></span> utilizza l'intera directory per conservare una casella di posta: ogni messaggio sarà conservato in un file separato. Diversamente, nel formato <span
                  class="emphasis"><em>mbox</em></span>, l'intera casella di posta elettronica è conservata in un file ed ogni riga che comincia con «<code
                  class="literal">From </code>» (<code
                  class="literal">From</code> seguito da uno spazio) segnala l'inizio di un nuovo messaggio.
				</div><div
                class="example"><a
                  id="idm140618337071200"></a><p
                  class="title"><strong>Esempio 11.5. Il file <code
                      class="filename">/etc/postfix/vmailbox</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
# Jean's email is stored as maildir, with
# one file per email in a dedicated directory
jean@falcot.org falcot.org/jean/
# Sophie's email is stored in a traditional "mbox" file,
# with all mails concatenated into one single file
sophie@falcot.org falcot.org/sophie
</pre></div></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140618337068864"></a>11.1.3. Restrizioni per ricezione ed invio</h3></div></div></div><div
              class="para">
				Il crescente numero di email massive non richieste (<span
                class="emphasis"><em>spam</em></span>) richiede di essere sempre più rigorosi quando si stabilisce quali email devono essere accettate da un server. Questa sezione presenta alcune tra le strategie incluse in Postfix.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CULTURA</em></span> Il problema dello spam</strong></p></div></div></div><a
                id="idm140618337065792"
                class="indexterm"></a><div
                class="para">
				«Spam» è un termine generico utilizzato per indicare tutte le email commerciali non richieste che inondano le nostre caselle di posta elettronica. Gli individui senza scrupoli che le inviano sono definiti «spammer». Costoro si preoccupano poco del disturbo che causano perché inviare email costa poco e basta che una piccola percentuale di destinatari sia attratta dalle loro offerte perché l'operazione di spam produca più denaro di quanto sia costata. Il processo è quasi completamente automatizzato e qualsiasi indirizzo email reso pubblico (per esempio in un forum, negli archivi di una mail list, in un blog, ecc.) sarà individuato dai robot degli spammer e sottoposto ad un flusso senza fine di messaggi non richiesti.
			</div><div
                class="para">
				Tutti gli amministratori di sistema tentano di affrontare questo disturbo con i filtri anti-spam, ma naturalmente gli spammer continuano a lavorare per aggirare questi filtri. Alcuni di loro prendono persino in affitto da varie organizzazioni criminali reti di macchine compromesse da worm. Recenti statistiche stimano che fino al 95% delle email in circolazione su Internet sono spam!
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140618337062608"></a>11.1.3.1. Restrizioni d'accesso basate su IP</h4></div></div></div><div
                class="para">
					La direttiva <code
                  class="literal">smtpd_client_restrictions</code> controlla quali macchine sono autorizzate a comunicare con il server di posta.
				</div><div
                class="example"><a
                  id="idm140618337060944"></a><p
                  class="title"><strong>Esempio 11.6. Restrizioni basate sull'indirizzo del client</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org
</pre></div></div><div
                class="para">
					Quando una variabile contiene una lista di regole, come nell'esempio qui sopra, queste regole sono valutate in ordine, dalla prima all'ultima. Ogni regola può accettare il messaggio, rifiutarlo o lasciare la decisione ad una regola seguente. Come conseguenza l'ordine è importante ed invertire due regole può causare un comportamento ampiamente differente.
				</div><div
                class="para">
					La direttiva <code
                  class="literal">permit_mynetworks</code> usata come prima regola accetta tutte le email provenienti da una macchina nella rete locale (così come definita nella variabile di configurazione <span
                  class="emphasis"><em>mynetworks</em></span>).
				</div><div
                class="para">
					La seconda direttiva rifiuta normalmente le email provenienti da macchine che non dispongono di una configurazione DNS completamente valida. Una configurazione è valida quando l'indirizzo IP può essere risolto con un nome e questo nome a sua volta può essere risolto all'indirizzo IP. Questa restrizione è spesso troppo rigorosa poiché molti server di posta non dispongono di un DNS inverso per il loro indirizzo IP. questo spiega perché gli amministratori della Falcot hanno inserito il modificatore <code
                  class="literal">warn_if_reject</code> prima della direttiva <code
                  class="literal">reject_unknown_client</code>: questo modificatore trasforma il rifiuto in un semplice avviso registrato nei log. Gli amministratori possono poi controllare il numero di messaggi che sarebbero rifiutati se la regola fosse applicata e prendere successivamente una decisione informata riguardo l'opportunità di abilitare questa restrizione.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>SUGGERIMENTO</em></span> Tabelle di <span
                            class="emphasis"><em>accesso</em></span></strong></p></div></div></div><div
                  class="para">
					I criteri di restrizione includono tabelle modificabili dall'amministratore che elencano combinazioni di mittenti, indirizzi IP e nomi host autorizzati oppure vietati. Queste tabelle possono essere create da una copia decompressa del file <code
                    class="filename">/usr/share/doc/postfix-doc/examples/access.gz</code>. Questo modello è documentato dai propri commenti, ovvero ogni tabella descrive la propria sintassi.
				</div><div
                  class="para">
					La tabella <code
                    class="filename">/etc/postfix/access_clientip</code> elenca gli indirizzi IP e le reti; <code
                    class="filename">/etc/postfix/access_helo</code> elenca i nomi di dominio; <code
                    class="filename">/etc/postfix/access_sender</code> contiene gli indirizzi email dei mittenti. Tutti questi file necessitano di essere trasformati in tabelle-hash (un formato ottimizzato per l'accesso veloce) dopo ogni modifica con il comando <code
                    class="command">postmap /etc/postfix/<em
                      class="replaceable">file</em></code>
				</div></div><div
                class="para">
					La terza direttiva consente all'amministratore di preparare una blacklist ed una whitelist di server di posta conservate nel file <code
                  class="filename">/etc/postfix/access_clientip</code>. I server nella whitelist sono considerati affidabili e le email che provengono da loro non passano attraverso le successive regole di filtraggio.
				</div><div
                class="para">
					Le ultime due regole rifiutano ogni messaggio che proviene da un server elencato in una delle blacklist indicate. RBL è un acronimo per <span
                  class="emphasis"><em>Remote Black List</em></span>: ci sono diverse liste di questo tipo e tutte elencano i server mal configurati che gli spammer utilizzano per inoltrare le loro email, così come le macchine infette da virus o worm che inoltrano email in modo assolutamente non previsto.
				</div><a
                id="idm140618337046592"
                class="indexterm"></a><a
                id="idm140618337045632"
                class="indexterm"></a><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>SUGGERIMENTO</em></span> Whitelist e liste RBL</strong></p></div></div></div><div
                  class="para">
					Le blacklist includono alle volte server legittimi che sono stati vittime di problemi. In queste situazioni tutte le email che provengono da questi server saranno respinte a meno che il server non sia incluso in una whitelist definita da <code
                    class="filename">/etc/postfix/access_clientip</code>.
				</div><div
                  class="para">
					La prudenza raccomanda di includere nella whitelist tutti i server da cui si ricevono generalmente molte email e che sono considerati affidabili.
				</div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140618337041456"></a>11.1.3.2. Controllare la validità dei comandi <code
                        class="literal">EHLO</code> o <code
                        class="literal">HELO</code></h4></div></div></div><div
                class="para">
					Ogni scambio SMTP inizia con un comando <code
                  class="literal">HELO</code> (o <code
                  class="literal">EHLO</code>) seguito dal nome del server di posta mittente; controllare la validità di questo nome può risultare utile.
				</div><a
                id="idm140618337038384"
                class="indexterm"></a><a
                id="idm140618337037264"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140618337036144"></a><p
                  class="title"><strong>Esempio 11.7. Restrizioni sul nome annunciato in <code
                      class="literal">EHLO</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname
</pre></div></div><div
                class="para">
					La prima direttiva <code
                  class="literal">permit_mynetworks</code> consente a tutte le macchine nella rete locale di presentarsi liberamente. Questo è importante poiché molti programmi di posta non rispettano in modo adeguato questa parte del protocollo SMTP e possono presentarsi con nomi senza senso.
				</div><div
                class="para">
					La regola <code
                  class="literal">reject_invalid_hostname</code> rifiuta le email quando la presentazione <code
                  class="literal">EHLO</code> annuncia un nome host sintatticamente scorretto. La regola <code
                  class="literal">reject_non_fqdn_hostname</code> rifiuta i messaggi quando il nome host presentato non è un nome di dominio completamente qualificato (ovvero include un nome di dominio oltre al nome host). La regola <code
                  class="literal">reject_unknown_hostname</code> rifiuta i messaggi se il nome presentato non esiste nel DNS. Poiché quest'ultima regola sfortunatamente porta a troppi rifiuti gli amministratori hanno modificato i suoi effetti ad un semplice avviso con il modificatore <code
                  class="literal">warn_if_reject</code> come visto inizialmente; possono anche decidere di rimuovere questo modificatore in una fase successiva dopo aver monitorato gli effetti di questa regola.
				</div><div
                class="para">
					Utilizzare <code
                  class="literal">permit_mynetworks</code> come prima regola ha un interessante effetto collaterale: le regole seguenti si applicano unicamente agli host fuori dalla rete locale. Questo consente di inserire in blacklist tutti gli host che si presentano come parte di <code
                  class="literal">falcot.com</code>, per esempio aggiungendo la riga <code
                  class="literal">falcot.com REJECT Non sei nella nostra rete!</code> al file <code
                  class="filename">/etc/postfix/access_helo</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140618336170128"></a>11.1.3.3. Accettare o rifiutare in base al mittente annunciato</h4></div></div></div><div
                class="para">
					Ogni messaggio ha un mittente annunciato dal comando <code
                  class="literal">MAIL FROM</code> del protocollo SMTP. Ancora una volta questa informazione può essere verificata in diversi modi.
				</div><a
                id="idm140618336168384"
                class="indexterm"></a><a
                id="idm140618336167264"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140618336165824"></a><p
                  class="title"><strong>Esempio 11.8. Controlli sul mittente</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender
</pre></div></div><div
                class="para">
					La tabella <code
                  class="filename">/etc/postfix/access_sender</code> mappa alcuni trattamenti speciali riservati ad alcuni mittenti. Generalmente questo significa elencare alcuni mittenti in una whitelist oppure in una blacklist.
				</div><div
                class="para">
					La regola <code
                  class="literal">reject_unknown_sender_domain</code> richiede un dominio valido per il mittente poiché è necessario per un indirizzo valido. La regola <code
                  class="literal">reject_unlisted_sender</code> rifiuta i mittenti locali se l'indirizzo non esiste: questo impedisce alle email di essere inviate da un indirizzo non valido nel dominio <code
                  class="literal">falcot.com</code> ed i messaggi originati da <code
                  class="literal">joe.bloggs@falcot.com</code> sono accettati esclusivamente se questo indirizzo esiste realmente.
				</div><div
                class="para">
					Per concludere, la regola <code
                  class="literal">reject_non_fqdn_sender</code> rifiuta le email che si presume provengano da un indirizzo senza un nome di dominio pienamente qualificato. In pratica questo significa rifiutare email provenienti da <code
                  class="literal">utente@macchina</code>: l'indirizzo dev'essere annunciato come <code
                  class="literal">utente@macchina.example.com</code> o <code
                  class="literal">utente@example.com</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140618336158128"></a>11.1.3.4. Accettare o rifiutare in base al destinatario</h4></div></div></div><div
                class="para">
					Ogni email ha almeno un destinatario, annunciato con il comando <code
                  class="literal">RCPT TO</code> del protocollo SMTP. Anche questi indirizzi concorrono alla validazione del messaggio, tuttavia sono meno rilevanti rispetto ai controlli effettuati sull'indirizzo del mittente.
				</div><a
                id="idm140618336156192"
                class="indexterm"></a><a
                id="idm140618336155232"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140618336153824"></a><p
                  class="title"><strong>Esempio 11.9. Controlli sul destinatario</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient
</pre></div></div><div
                class="para">
					<code
                  class="literal">reject_unauth_destination</code> is the basic rule that requires outside messages to be addressed to us; messages sent to an address not served by this server are rejected. Without this rule, a server becomes an open relay that allows spammers to send unsolicited emails; this rule is therefore mandatory, and it will be best included near the beginning of the list, so that no other rules may authorize the message before its destination has been checked.
				</div><div
                class="para">
					La regola <code
                  class="literal">reject_unlisted_recipient</code> rifiuta ragionevolmente i messaggi inviati a utenti locali che non esistono. Infine <code
                  class="literal">reject_non_fqdn_recipient</code> rifiuta gli indirizzi non completamente qualificati: questo rende impossibile l'invio di email a <code
                  class="literal">jean</code> o <code
                  class="literal">jean@macchina</code> e richiede invece l'uso dell'indirizzo completo come <code
                  class="literal">jean@macchina.falcot.com</code> o <code
                  class="literal">jean@falcot.com</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140618336147616"></a>11.1.3.5. Restrizioni associate con il comando <code
                        class="literal">DATA</code></h4></div></div></div><div
                class="para">
					Il comando <code
                  class="literal">DATA</code> di SMTP è emesso prima dei contenuti del messaggio. Non fornisce alcuna informazione di per sé, a parte l'annunciare quello che viene immediatamente dopo. Tuttavia può a sua volta essere soggetto a controlli.
				</div><a
                id="idm140618336145360"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140618336144240"></a><p
                  class="title"><strong>Esempio 11.10. Controlli su <code
                      class="literal">DATA</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_data_restrictions = reject_unauth_pipelining
</pre></div></div><div
                class="para">
					La direttiva <code
                  class="literal">reject_unauth_pipelining</code> fa sì che il messaggio sia rifiutato se il mittente invia un comando prima che sia inviata una risposta al comando inviato in precedenza. Questo protegge da una ottimizzazione comunemente utilizzata dagli spammer automatizzati poiché a loro non importa un fico secco delle risposte e si concentrano unicamente nell'invio del maggior numero di email nel minor tempo possibile.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140618336141056"></a>11.1.3.6. Applicare restrizioni</h4></div></div></div><div
                class="para">
					Nonostante i comandi precedenti verificano informazioni a diversi livelli dello scambio SMTP, Postfix invia l'effettivo rifiuto unicamente a seguito del comando <code
                  class="literal">RCPT TO</code>.
				</div><div
                class="para">
					Questo significa che anche se il messaggio viene rifiutato a causa di un comando <code
                  class="literal">EHLO</code> non valido, Postfix conosce il mittente ed il destinatario quando annuncia il rifiuto e pertanto potrà poi inserire nel log un messaggio più esplicito di quanto avesse potuto fare nel caso la transazione si fosse interrotta all'inizio. Inoltre un certo numero di client SMTP non si attende problemi durante i primi comandi SMTP e questi client saranno meno disturbati da questo rifiuto posticipato.
				</div><div
                class="para">
					A final advantage to this choice is that the rules can accumulate information during the various stages of the SMTP exchange; this allows defining more fine-grained permissions, such as rejecting a non-local connection if it announces itself with a local sender.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140618336136944"></a>11.1.3.7. Filtrare in base al contenuto del messaggio</h4></div></div></div><div
                class="para">
					The validation and restriction system would not be complete without a way to apply checks to the message contents. Postfix differentiates the checks applying to the email headers from those applying to the email body.
				</div><div
                class="example"><a
                  id="idm140618336135488"></a><p
                  class="title"><strong>Esempio 11.11. Abilitare filtri basati sul contenuto</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks
</pre></div></div><a
                id="idm140618336134112"
                class="indexterm"></a><div
                class="para">
					Entrambi i file contengono una lista di espressioni regolari (spesso chiamate <span
                  class="emphasis"><em>regexp</em></span> o <span
                  class="emphasis"><em>regex</em></span>) e relative azioni da intraprendere quando l'intestazione (o il corpo) delle email corrisponde con l'espressione.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>APPROFONDIMENTO</em></span> Tabelle regexp</strong></p></div></div></div><div
                  class="para">
					Il file <code
                    class="filename">/usr/share/doc/postfix-doc/examples/header_checks.gz</code> contiene molti commenti esplicativi che possono essere utilizzati come punto di partenza per creare i file <code
                    class="filename">/etc/postfix/header_checks</code> ed <code
                    class="filename">/etc/postfix/body_checks</code>.
				</div></div><div
                class="example"><a
                  id="idm140618336127968"></a><p
                  class="title"><strong>Esempio 11.12. File d'esempio <code
                      class="filename">/etc/postfix/header_checks</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification
</pre></div></div><div
                class="sidebar"><a
                  id="sidebar.regexp"></a><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>FONDAMENTALI</em></span> Espressioni regolari</strong></p></div></div></div><div
                  class="para">
					Il termine <span
                    class="emphasis"><em>espressione regolare</em></span> (spesso abbreviato in lingua inglese con <span
                    class="emphasis"><em>regexp</em></span> o <span
                    class="emphasis"><em>regex</em></span>) fa riferimento ad una notazione generica per esprimere la descrizione dei contenuti oppure la struttura di una stringa di caratteri. Certi caratteri speciali permettono di definire: alternative (per esempio <code
                    class="literal">pippo|pluto</code> corrisponde sia con «pippo» che con «pluto»); insiemi di caratteri (per esempio <code
                    class="literal">[0-9]</code> significa qualsiasi numero e <code
                    class="literal">.</code> — un punto — significa qualsiasi carattere); quantità (<code
                    class="literal">s?</code> è compatibile con <code
                    class="literal">s</code> o con una stringa vuota ovvero con zero o una occorrenza di <code
                    class="literal">s</code>, <code
                    class="literal">s+</code> è compatibile con una o più occorrenze consecutive del carattere <code
                    class="literal">s</code>, e così via). Le parentesi permettono di raggruppare i risultati della ricerca.
				</div><div
                  class="para">
					La precisa sintassi di queste espressioni varia tra i vari strumenti che le utilizzano ma le funzionalità base sono similari. <div
                    class="url">→ <a
                      href="http://it.wikipedia.org/wiki/Espressione_regolare">http://it.wikipedia.org/wiki/Espressione_regolare</a></div>
				</div></div><div
                class="para">
					La prima controlla l'intestazione che fa riferimento al software email; se viene individuato <code
                  class="literal">GOTO Sarbacane</code> (un software per l'invio massivo di email) il messaggio viene rifiutato. La seconda espressione controlla l'oggetto del messaggio: se indica la notifica di un virus possiamo decidere di non respingere il messaggio ma di limitarci a scartarlo immediatamente.
				</div><div
                class="para">
					Utilizzare questi filtri è un'arma a doppio taglio poiché è facile produrre regole troppo generiche e perdere di conseguenza email legittime. In questi casi i messaggi vanno perduti ed inoltre i rispettivi mittenti ricevono messaggi d'errore non desiderati (e fastidiosi).
				</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140618336115120"></a>11.1.4. Impostare il <span
                      class="foreignphrase"><em
                        class="foreignphrase">greylisting</em></span></h3></div></div></div><a
              id="idm140618336114000"
              class="indexterm"></a><div
              class="para">
				“Greylisting” is a filtering technique according to which a message is initially rejected with a temporary error code, and only accepted on a further try after some delay. This filtering is particularly efficient against spam sent by the many machines infected by worms and viruses, since this software rarely acts as a full SMTP agent (by checking the error code and retrying failed messages later), especially since many of the harvested addresses are really invalid and retrying would only mean losing time.
			</div><div
              class="para">
				Postfix non fornisce il greylisting nativamente ma esiste una funzionalità che permette di delegare la decisione riguardo il rifiuto o l'accettazione di un messaggio ad un programma esterno. Il pacchetto <span
                class="pkg pkg">postgrey</span> contiene proprio un programma di questo tipo, progettato per interfacciarsi con questo servizio per la delega delle politiche di accesso.
			</div><div
              class="para">
				Once <span
                class="pkg pkg">postgrey</span> is installed, it runs as a daemon and listens on port 10023. Postfix can then be configured to use it, by adding the <code
                class="literal">check_policy_service</code> parameter as an extra restriction:
			</div><pre
              class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023
</pre><div
              class="para">
				Ogni volta che Postfix raggiunge questa regola si connette al demone <code
                class="command">postgrey</code> e gli invia informazioni a proposito del messaggio in questione. Postgrey prende quindi in considerazione i tre parametri IP/mittente/destinatario e controlla il suo database per verificare se sono già apparsi recentemente. Se è così Postgrey risponde autorizzando il messaggio, altrimenti risponde indicando che il messaggio dev'essere temporaneamente respinto ed i tre parametri vengono inseriti nel database.
			</div><div
              class="para">
				Il principale svantaggio del greylisting è dato dal ritardo causato ai messaggi legittimi, cosa che non è sempre accettabile. Inoltre incrementa il carico sui server che inviano molte email legittime
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>IN PRATICA</em></span> Aspetti negativi del greylisting</strong></p></div></div></div><div
                class="para">
				Teoricamente il greylisting dovrebbe unicamente ritardare la ricezione della prima email da un dato mittente ad un dato destinatario e tipicamente questo ritardo si misura nell'ordine dei minuti. La realtà, purtroppo, può essere leggermente diversa. Alcuni grandi provider utilizzano cluster di server SMTP e quando un messaggio viene inizialmente rifiutato il server che riprova la trasmissione potrebbe non essere lo stesso. Quando ciò accade il secondo server ottiene un ulteriore messaggio d'errore temporaneo dovuto al greylisting e così via: in questi casi possono passare anche diverse ore prima che la trasmissione sia rieseguita da un server già coinvolto poiché normalmente i server SMTP incrementano gli intervalli tra un tentativo e l'altro dopo ogni fallimento.
			</div><div
                class="para">
				Di conseguenza l'indirizzo IP di provenienza può variare nel tempo anche per un singolo mittente. Inoltre anche l'indirizzo email del mittente può cambiare. Per esempio molti server di mailing-list possono includere informazioni extra nell'indirizzo email del mittente per essere in grado di gestire i messaggi d'errore (spesso indicati anche con il termine <span
                  class="emphasis"><em>bounce</em></span>). Ad ogni nuovo messaggio inviato ad una mailing-list potrebbe essere richiesto di attraversare il greylisting cosa che richiede di essere conservato (temporaneamente) nel server del mittente. Questo può diventare presto un problema per le mailing-list molto frequentate (con decine di migliaia di iscritti).
			</div><div
                class="para">
				Per mitigare questi effetti negativi Postgrey gestisce una whitelist di siti ed i messaggi da loro originati vengono immediatamente accettati senza passare attraverso il greylisting. Questa lista può essere facilmente adattata in base alle necessità locali visto che è conservata nel file <code
                  class="filename">/etc/postgrey/whitelist_clients</code>.
			</div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>GOING FURTHER</em></span> Selective greylisting with <span
                          class="pkg pkg">milter-greylist</span></strong></p></div></div></div><div
                class="para">
				The drawbacks of greylisting can be mitigated by only using greylisting on the subset of clients that are already considered as probable sources of spam (because they are listed in a DNS black-list). This is not possible with <span
                  class="pkg pkg">postgrey</span> but <span
                  class="pkg pkg">milter-greylist</span> can be used in such a way.
			</div><div
                class="para">
				In that scenario, since DNS black-lists never triggers a definitive rejection, it becomes reasonable to use aggressive black-lists, including those listing all dynamic IP addresses from ISP clients (such as <code
                  class="literal">pbl.spamhaus.org</code> or <code
                  class="literal">dul.dnsbl.sorbs.net</code>).
			</div><div
                class="para">
				Since milter-greylist uses Sendmail's milter interface, the postfix side of its configuration is limited to “<code
                  class="literal">smtpd_milters = unix:/var/milter-greylist/milter-greylist.sock</code>”. The <span
                  class="citerefentry"><span
                    class="refentrytitle">greylist.conf</span>(5)</span> manual page documents <code
                  class="filename">/etc/milter-greylist/greylist.conf</code> and the numerous ways to configure milter-greylist.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140618336092704"></a>11.1.5. Personalizzare i filtri in base al destinatario</h3></div></div></div><div
              class="para">
				Nelle ultime due sezioni sono state analizzate molte delle possibili restrizioni. Tutte puntano a diminuire la quantità di spam ricevuto ma tutte hanno effetti collaterali. Quindi è sempre più comune personalizzare l'insieme di filtri in base al destinatario. Alla Falcot Corporation il greylisting è utile per la maggior parte degli utenti, ma ostacola l'attività di alcuni utenti che necessitano di una bassa latenza per le proprie email (come il servizio di supporto tecnico). Allo stesso modo il servizio di supporto commerciale incontra a volte delle difficoltà nella ricezione di email da alcuni provider asiatici che sono inseriti nelle blacklist: il servizio di supporto commerciale ha quindi richiesto un indirizzo email non filtrato per poter comunicare.
			</div><div
              class="para">
				Postfix fornisce la personalizzazione sui filtri tramite il concetto di «restrizione di classe». Le classi sono dichiarate nel parametro <code
                class="literal">smtpd_restriction_classes</code> e sono definite come in <code
                class="literal">smtpd_recipient_restrictions</code>. La direttiva <code
                class="literal">check_recipient_access</code> definisce quindi una tabella che associa un destinatario ad un insieme appropriato di restrizioni.
			</div><div
              class="example"><a
                id="idm140618336088768"></a><p
                class="title"><strong>Esempio 11.13. Definire classi di restrizione in <code
                    class="filename">main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access
</pre></div></div><div
              class="example"><a
                id="idm140618336086656"></a><p
                class="title"><strong>Esempio 11.14. Il file <code
                    class="filename">/etc/postfix/recipient_access</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting
</pre></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="sect.postfix-antivirus"></a>11.1.6. Integrare un antivirus</h3></div></div></div><a
              id="idm140618336083360"
              class="indexterm"></a><div
              class="para">
				I molti virus che circolano come allegato email rendono importante impostare un antivirus al punto d'ingresso nella rete aziendale dal momento che, nonostante una costante campagna di sensibilizzazione, molti utenti continuano ad aprire anche i file allegati a messaggi palesemente loschi.
			</div><div
              class="para">
				Gli amministratori della Falcot hanno scelto <code
                class="command">clamav</code> come loro antivirus libero. Il pacchetto principale è <span
                class="pkg pkg">clamav</span> ma hanno installato alcuni altri pacchetti aggiuntivi come <span
                class="pkg pkg">arj</span>, <span
                class="pkg pkg">unzoo</span>, <span
                class="pkg pkg">unrar</span> e <span
                class="pkg pkg">lha</span>, poiché sono richiesti dall'antivirus per analizzare gli allegati archiviati in uno di questi formati.
			</div><a
              id="idm140618336077152"
              class="indexterm"></a><a
              id="idm140618336076032"
              class="indexterm"></a><div
              class="para">
				Il compito di interfacciare l'antivirus ed il server di posta è affidato a <code
                class="command">clamav-milter</code>. Un <span
                class="emphasis"><em>milter</em></span> (abbreviazione dell'inglese <span
                class="emphasis"><em>mail filter</em></span>) è un programma di filtraggio realizzato appositamente per interfacciarsi con i server di posta. Un milter utilizza un'interfaccia di programmazione standard (API) che fornisce prestazioni nettamente migliori rispetto ai filtri esterni ai server di posta. I milter sono stati introdotti inizialmente da <span
                class="emphasis"><em>Sendmail</em></span> e <span
                class="emphasis"><em>Postfix</em></span> ha presto seguito l'esempio.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>APPROFONDIMENTO</em></span> Un milter per Spamassassin</strong></p></div></div></div><a
                id="idm140618336070752"
                class="indexterm"></a><div
                class="para">
				Il pacchetto <span
                  class="pkg pkg">spamass-milter</span> fornisce un milter basato su <span
                  class="emphasis"><em>SpamAssassin</em></span>, il famoso rilevatore di email non richieste. Può essere impiegato per etichettare i messaggi come probabile spam, aggiungendo un header addizionale, o per rifiutare del tutto i messaggi se il loro punteggio di probabile spam, definito «spamminess» in lingua inglese, supera un determinata soglia.
			</div></div><div
              class="para">
				Once the <span
                class="pkg pkg">clamav-milter</span> package is installed, the milter should be reconfigured to run on a TCP port rather than on the default named socket. This can be achieved with <code
                class="command">dpkg-reconfigure clamav-milter</code>. When prompted for the “Communication interface with Sendmail”, answer “<code
                class="literal">inet:10002@127.0.0.1</code>”.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NOTE</em></span> Real TCP port vs named socket</strong></p></div></div></div><div
                class="para">
				The reason why we use a real TCP port rather than the named socket is that the postfix daemons often run chrooted and do not have access to the directory hosting the named socket. You could also decide to keep using a named socket and pick a location within the chroot (<code
                  class="filename">/var/spool/postfix/</code>).
			</div></div><div
              class="para">
				The standard ClamAV configuration fits most situations, but some important parameters can still be customized with <code
                class="command">dpkg-reconfigure clamav-base</code>.
			</div><div
              class="para">
				Come ultimo passo è necessario istruire Postfix affinché utilizzi i filtri appena configurati. Per farlo è sufficiente aggiungere la seguente direttiva a <code
                class="filename">/etc/postfix/main.cf</code>:
			</div><pre
              class="programlisting">
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002
</pre><div
              class="para">
				Se l'antivirus causa problemi questa riga può essere commentata e dev'essere eseguito <code
                class="command">/etc/init.d/postfix reload</code> perché la modifica sia applicata.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>IN PRATICA</em></span> Verificare l'antivirus</strong></p></div></div></div><div
                class="para">
				Impostato l'antivirus, è necessario verificare il suo corretto funzionamento. Il metodo più veloce per farlo è inviare un'email di prova con un allegato contenente il file <code
                  class="filename">eicar.com</code> (o <code
                  class="filename">eicar.com.zip</code>) che può essere scaricato online: <div
                  class="url">→ <a
                    href="http://www.eicar.org/anti_virus_test_file.htm">http://www.eicar.org/anti_virus_test_file.htm</a></div>
			</div><div
                class="para">
				Questo file non è un vero virus ma un file di test che tutti i software antivirus sul mercato riconoscono come un virus per consentire la verifica delle installazioni.
			</div></div><div
              class="para">
				Tutti i messaggi gestiti da Postfix passano ora attraverso il filtro antivirus.
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140618336054528"></a>11.1.7. SMTP autenticato</h3></div></div></div><div
              class="para">
				Being able to send emails requires an SMTP server to be reachable; it also requires said SMTP server to send emails through it. For roaming users, this may need regularly changing the configuration of the SMTP client, since Falcot's SMTP server rejects messages coming from IP addresses apparently not belonging to the company. Two solutions exist: either the roaming user installs an SMTP server on their computer, or they still use the company server with some means of authenticating as an employee. The former solution is not recommended since the computer won't be permanently connected, and it won't be able to retry sending messages in case of problems; we will focus on the latter solution.
			</div><div
              class="para">
				L'autenticazione SMTP con Postfix fa affidamento su SASL (<span
                class="emphasis"><em>Simple Authentication and Security Layer</em></span>). Richiede l'installazione dei pacchetti <span
                class="pkg pkg">libsasl2-modules</span> e <span
                class="pkg pkg">sasl2-bin</span> e la registrazione di una password nel database SASL per ogni utente che necessita di autenticarsi sul server SMTP. Questo è realizzabile per mezzo del comando <code
                class="command">saslpasswd2</code> che accetta diversi parametri. L'opzione <code
                class="literal">-u</code> definisce il dominio di autenticazione e deve corrispondere al parametro <code
                class="literal">smtpd_sasl_local_domain</code> nella configurazione di Postfix. L'opzione <code
                class="literal">-c</code> consente di creare un utente e <code
                class="literal">-f</code> permette di specificare il file da usare se il database SASL necessita di essere conservato in una posizione diversa da quella predefinita (<code
                class="filename">/etc/sasldb2</code>).
			</div><pre
              class="screen scale">
<code
                class="computeroutput"># </code><strong
                class="userinput"><code>saslpasswd2 -u `postconf -h myhostname` -f /var/spool/postfix/etc/sasldb2 -c jean</code></strong>
<code
                class="computeroutput">[... type jean's password twice ...]</code></pre><div
              class="para">
				Notare che il database di SASL viene creato nella directory di Postfix. Per assicurare la coerenza modifichiamo <code
                class="filename">/etc/sasldb2</code> in un collegamento simbolico che punta al database utilizzato da Postfix con il comando <code
                class="command">ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</code>.
			</div><div
              class="para">
				A questo punto è necessario configurare Postfix affinché utilizzi SASL. Prima di tutto l'utente <code
                class="literal">postfix</code> dev'essere aggiunto al gruppo <code
                class="literal">sasl</code> così che possa accedere al database degli account SASL. Alcuni nuovi parametri sono inoltre necessari per abilitare SASL e il parametro <code
                class="literal">smtpd_recipient_restrictions</code> dev'essere configurato per consentire ai client autenticati da SASL di inviare email liberamente.
			</div><div
              class="example"><a
                id="idm140618336042016"></a><p
                class="title"><strong>Esempio 11.15. Abilitare SASL nel file <code
                    class="filename">/etc/postfix/main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> Client SMTP autenticati</strong></p></div></div></div><div
                class="para">
				La maggior parte dei client email sono in grado di autenticarsi presso un server SMTP prima di inviare i messaggi in uscita e per utilizzare questa funzionalità basta semplicemente configurare i parametri appropriati. Se il client in uso non fornisce questa funzionalità è possibile utilizzare un server Postfix locale e configurarlo per inoltrare le email attraverso il server SMTP remoto. In questo caso, il Postfix locale diventerà a sua volta il client che andrà ad autenticarsi con SASL. I parametri richiesti sono i seguenti:
			</div><pre
                class="programlisting">
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]
</pre><div
                class="para">
				The <code
                  class="filename">/etc/postfix/sasl_passwd</code> file needs to contain the username and password to use for authenticating on the <code
                  class="literal">mail.falcot.com</code> server. Here's an example:
			</div><pre
                class="programlisting">
[mail.falcot.com]   joe:LyinIsji
</pre><div
                class="para">
				Così come per tutte le mappe Postfix questo file dev'essere trasformato in <code
                  class="filename">/etc/postfix/sasl_passwd.db</code> con l'impiego del comando <code
                  class="command">postmap</code>.
			</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>Indietro</strong>10.8. Strumenti di diagnosi di rete</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>Risali</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>Partenza</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>Avanti</strong>11.2. Server web (HTTP)</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/network-services.html">ar-MA</a></li><li><a
              href="../da-DK/network-services.html">da-DK</a></li><li><a
              href="../de-DE/network-services.html">de-DE</a></li><li><a
              href="../el-GR/network-services.html">el-GR</a></li><li><a
              href="../en-US/network-services.html">en-US</a></li><li><a
              href="../es-ES/network-services.html">es-ES</a></li><li><a
              href="../fa-IR/network-services.html">fa-IR</a></li><li><a
              href="../fr-FR/network-services.html">fr-FR</a></li><li><a
              href="../hr-HR/network-services.html">hr-HR</a></li><li><a
              href="../id-ID/network-services.html">id-ID</a></li><li><a
              href="../it-IT/network-services.html">it-IT</a></li><li><a
              href="../ja-JP/network-services.html">ja-JP</a></li><li><a
              href="../pl-PL/network-services.html">pl-PL</a></li><li><a
              href="../pt-BR/network-services.html">pt-BR</a></li><li><a
              href="../ro-RO/network-services.html">ro-RO</a></li><li><a
              href="../ru-RU/network-services.html">ru-RU</a></li><li><a
              href="../tr-TR/network-services.html">tr-TR</a></li><li><a
              href="../zh-CN/network-services.html">zh-CN</a></li></ul></div></body></html>
