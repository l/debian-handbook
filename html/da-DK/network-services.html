<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">Kapitel 11. Network Services: Postfix, Apache, NFS, Samba, Squid, LDAP</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.1" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-da-DK-1.0-1" /><meta
        name="keywords"
        content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP" /><link
        rel="home"
        href="index.html"
        title="Debian-administratorens håndbog" /><link
        rel="up"
        href="index.html"
        title="Debian-administratorens håndbog" /><link
        rel="prev"
        href="sect.network-diagnosis-tools.html"
        title="10.8. Network Diagnosis Tools" /><link
        rel="next"
        href="sect.http-web-server.html"
        title="11.2. Web Server (HTTP)" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/da-DK/network-services.html" /></head><body
      class="draft "><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="http://debian-handbook.info"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>forrige</strong></a></li><li
          class="home">Debian-administratorens håndbog</li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>næste</strong></a></li></ul><div
        xml:lang="da-DK"
        class="chapter"
        lang="da-DK"><div
          class="titlepage"><div><div><h1
                class="title"><a
                  id="network-services"></a>Kapitel 11. Network Services: Postfix, Apache, NFS, Samba, Squid, LDAP</h1></div></div></div><div
          class="toc"><dl
            class="toc"><dt><span
                class="section"><a
                  href="network-services.html#sect.smtp-mail-server">11.1. Mail Server</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="network-services.html#idm140275487139616">11.1.1. Installing Postfix</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140275471195808">11.1.2. Configuring Virtual Domains</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140275470280704">11.1.3. Restrictions for Receiving and Sending</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140275470494064">11.1.4. Setting Up <span
                        class="foreignphrase"><em
                          class="foreignphrase">greylisting</em></span></a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140275470472080">11.1.5. Customizing Filters Based On the Recipient</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#sect.postfix-antivirus">11.1.6. Integrating an Antivirus</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm140275470434208">11.1.7. Authenticated SMTP</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-web-server.html">11.2. Web Server (HTTP)</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140275470398720">11.2.1. Installing Apache</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140275471859760">11.2.2. Configuring Virtual Hosts</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140275471835952">11.2.3. Common Directives</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm140275471754608">11.2.4. Log Analyzers</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ftp-file-server.html">11.3. FTP File Server</a></span></dt><dt><span
                class="section"><a
                  href="sect.nfs-file-server.html">11.4. NFS File Server</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140275471694976">11.4.1. Securing NFS</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140275471658992">11.4.2. NFS Server</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm140275466594032">11.4.3. NFS Client</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.windows-file-server-with-samba.html">11.5. Setting Up Windows Shares with Samba</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm140275466574720">11.5.1. Samba Server</a></span></dt><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm140275466525792">11.5.2. Samba Client</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-ftp-proxy.html">11.6. HTTP/FTP Proxy</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140275466486416">11.6.1. Installing</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140275466481152">11.6.2. Configuring a Cache</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm140275466477376">11.6.3. Configuring a Filter</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ldap-directory.html">11.7. LDAP Directory</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140275466455440">11.7.1. Installing</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140275466436384">11.7.2. Filling in the Directory</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm140275466407312">11.7.3. Managing Accounts with LDAP</a></span></dt></dl></dd></dl></div><div
          class="highlights"><div
            class="para">
		Network services are the programs that users interact with directly in their daily work. They're the tip of the information system iceberg, and this chapter focuses on them; the hidden parts they rely on are the infrastructure we already described.
	</div></div><div
          class="section"><div
            class="titlepage"><div><div><h2
                  class="title"><a
                    id="sect.smtp-mail-server"></a>11.1. Mail Server</h2></div></div></div><div
            class="para">
			The Falcot Corp administrators selected Postfix for the electronic mail server, due to its reliability and its ease of configuration. Indeed, its design enforces that each task is implemented in a process with the minimum set of required permissions, which is a great mitigation measure against security problems.
		</div><a
            id="idm140275487866944"
            class="indexterm"></a><a
            id="idm140275485146368"
            class="indexterm"></a><a
            id="idm140275485257616"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>ALTERNATIVE</em></span> The Exim4 server</strong></p></div></div></div><a
              id="idm140275486872832"
              class="indexterm"></a><div
              class="para">
			Debian uses Exim4 as the default email server (which is why the initial installation includes Exim4). The configuration is provided by a separate package, <span
                class="pkg pkg">exim4-config</span>, and automatically customized based on the answers to a set of Debconf questions very similar to the questions asked by the <span
                class="pkg pkg">postfix</span> package.
		</div><div
              class="para">
			The configuration can be either in one single file (<code
                class="filename">/etc/exim4/exim4.conf.template</code>) or split across a number of configuration snippets stored under <code
                class="filename">/etc/exim4/conf.d/</code>. In both cases, the files are used by <code
                class="command">update-exim4.conf</code> as templates to generate <code
                class="filename">/var/lib/exim4/config.autogenerated</code>. The latter is the file used by Exim4. Thanks to this mechanism, values obtained through Exim's debconf configuration — which are stored in <code
                class="filename">/etc/exim4/update-exim4.conf.conf</code> — can be injected in Exim's configuration file, even when the administrator or another package has altered the default Exim configuration.
		</div><div
              class="para">
			The Exim4 configuration file syntax has its peculiarities and its learning curve; however, once these peculiarities are understood, Exim4 is a very complete and powerful email server, as evidenced by the tens of pages of documentation. <div
                class="url">→ <a
                  href="http://www.exim.org/docs.html">http://www.exim.org/docs.html</a></div>
		</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140275487139616"></a>11.1.1. Installing Postfix</h3></div></div></div><div
              class="para">
				The <span
                class="pkg pkg">postfix</span> package includes the main SMTP daemon. Other packages (such as <span
                class="pkg pkg">postfix-ldap</span> and <span
                class="pkg pkg">postfix-pgsql</span>) add extra functionality to Postfix, including access to mapping databases. You should only install them if you know that you need them.
			</div><div
              class="sidebar"><a
                id="sidebar.smtp"></a><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>BACK TO BASICS</em></span> SMTP</strong></p></div></div></div><a
                id="idm140275475643728"
                class="indexterm"></a><a
                id="idm140275475642768"
                class="indexterm"></a><a
                id="idm140275475641840"
                class="indexterm"></a><div
                class="para">
				SMTP (<span
                  class="emphasis"><em>Simple Mail Transfer Protocol</em></span>) is the protocol used by mail servers to exchange and route emails.
			</div></div><div
              class="para">
				Several Debconf questions are asked during the installation of the package. The answers allow generating a first version of the <code
                class="filename">/etc/postfix/main.cf</code> configuration file.
			</div><div
              class="para">
				The first question deals with the type of setup. Only two of the proposed answers are relevant in case of an Internet-connected server, “Internet site” and “Internet with smarthost”. The former is appropriate for a server that receives incoming email and sends outgoing email directly to its recipients, and is therefore well-adapted to the Falcot Corp case. The latter is appropriate for a server receiving incoming email normally, but that sends outgoing email through an intermediate SMTP server — the “smarthost” — rather than directly to the recipient's server. This is mostly useful for individuals with a dynamic IP address, since many email servers reject messages coming straight from such an IP address. In this case, the smarthost will usually be the ISP's SMTP server, which is always configured to accept email coming from the ISP's customers and forward it appropriately. This setup (with a smarthost) is also relevant for servers that are not permanently connected to the internet, since it avoids having to manage a queue of undeliverable messages that need to be retried later.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>VOCABULARY</em></span> ISP</strong></p></div></div></div><a
                id="idm140275485266192"
                class="indexterm"></a><div
                class="para">
				ISP is the acronym for “Internet Service Provider”. It covers an entity, often a commercial company, that provides Internet connections and the associated basic services (email, news and so on).
			</div><div
                class="para">
			</div></div><div
              class="para">
				The second question deals with the full name of the machine, used to generate email addresses from a local user name; the full name of the machine ends up as the part after the at-sign (“@”). In the case of Falcot, the answer should be <code
                class="literal">mail.falcot.com</code>. This is the only question asked by default, but the configuration it leads to is not complete enough for the needs of Falcot, which is why the administrators run <code
                class="command">dpkg-reconfigure postfix</code> so as to be able to customize more parameters.
			</div><div
              class="para">
				One of the extra questions asks for all the domain names related to this machine. The default list includes its full name as well as a few synonyms for <code
                class="literal">localhost</code>, but the main <code
                class="literal">falcot.com</code> domain needs to be added by hand. More generally, this question should usually be answered with all the domain names for which this machine should serve as an MX server; in other words, all the domain names for which the DNS says that this machine will accept email. This information ends up in the <code
                class="literal">mydestination</code> variable of the main Postfix configuration file — <code
                class="filename">/etc/postfix/main.cf</code>.
			</div><a
              id="idm140275467656656"
              class="indexterm"></a><a
              id="idm140275467655216"
              class="indexterm"></a><div
              class="figure"><a
                id="idm140275467653776"></a><div
                class="figure-contents"><div
                  class="mediaobject"><img
                    src="images/mail-server.png"
                    alt="Role of the DNS MX record while sending a mail" /></div></div><p
                class="title"><strong>Figur 11.1. Role of the DNS <span
                    class="emphasis"><em>MX</em></span> record while sending a mail</strong></p></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> Querying the MX records</strong></p></div></div></div><div
                class="para">
				When the DNS does not have an MX record for a domain, the email server will try sending the messages to the host itself, by using the matching A record (or AAAA in IPv6).
			</div></div><div
              class="para">
				In some cases, the installation can also ask what networks should be allowed to send email via the machine. In its default configuration, Postfix only accepts emails coming from the machine itself; the local network will usually be added. The Falcot Corp administrators added <code
                class="literal">192.168.0.0/16</code> to the default answer. If the question is not asked, the relevant variable in the configuration file is <code
                class="literal">mynetworks</code>, as seen in the example below.
			</div><div
              class="para">
				Local email can also be delivered through <code
                class="command">procmail</code>. This tool allows users to sort their incoming email according to rules stored in their <code
                class="filename">~/.procmailrc</code> file.
			</div><a
              id="idm140275467645280"
              class="indexterm"></a><a
              id="idm140275467644160"
              class="indexterm"></a><a
              id="idm140275471204784"
              class="indexterm"></a><div
              class="para">
				After this first step, the administrators got the following configuration file; it will be used as a starting point for adding some extra functionality in the next sections.
			</div><div
              class="example"><a
                id="idm140275471203184"></a><p
                class="title"><strong>Eksempel 11.1. Initial <code
                    class="filename">/etc/postfix/main.cf</code> file</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SECURITY</em></span> <span
                          class="emphasis"><em>Snake oil</em></span> SSL certificates</strong></p></div></div></div><div
                class="para">
				The <span
                  class="emphasis"><em>snake oil</em></span> certificates, like the <span
                  class="emphasis"><em>snake oil</em></span> “medicine” sold by unscrupulous quacks in old times, have absolutely no value, since they are generated similarly on all Debian systems, with the same “private” part. They should only be used for testing purposes, and normal service must use real certificates; these can be generated with the procedure described in <a
                  class="xref"
                  href="sect.virtual-private-network.html#sect.easy-rsa">Afsnit 10.2.1.1, “Public Key Infrastructure: <span
                    class="emphasis"><em>easy-rsa</em></span>”</a>.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140275471195808"></a>11.1.2. Configuring Virtual Domains</h3></div></div></div><a
              id="idm140275471195040"
              class="indexterm"></a><a
              id="idm140275471193600"
              class="indexterm"></a><div
              class="para">
				The mail server can receive emails addressed to other domains besides the main domain; these are then known as virtual domains. In most cases where this happens, the emails are not ultimately destined to local users. Postfix provides two interesting features for handling virtual domains.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CAUTION</em></span> Virtual domains and canonical domains</strong></p></div></div></div><div
                class="para">
				None of the virtual domains must be referenced in the <code
                  class="literal">mydestination</code> variable; this variable only contains the names of the “canonical” domains directly associated to the machine and its local users.
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140275471189488"></a>11.1.2.1. Virtual Alias Domains</h4></div></div></div><a
                id="idm140275471188688"
                class="indexterm"></a><a
                id="idm140275472009824"
                class="indexterm"></a><div
                class="para">
					A virtual alias domain only contains aliases, i.e. addresses that only forward emails to other addresses.
				</div><div
                class="para">
					Such a domain is enabled by adding its name to the <code
                  class="literal">virtual_alias_domains</code> variable, and referencing an address mapping file in the <code
                  class="literal">virtual_alias_maps</code> variable.
				</div><div
                class="example"><a
                  id="idm140275472006272"></a><p
                  class="title"><strong>Eksempel 11.2. Directives to add in the <code
                      class="filename">/etc/postfix/main.cf</code> file</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual
</pre></div></div><div
                class="para">
					The <code
                  class="filename">/etc/postfix/virtual</code> file describes a mapping with a rather straightforward syntax: each line contains two fields separated by whitespace; the first field is the alias name, the second field is a list of email addresses where it redirects. The special <code
                  class="literal">@domain.com</code> syntax covers all remaining aliases in a domain.
				</div><div
                class="example"><a
                  id="idm140275472002784"></a><p
                  class="title"><strong>Eksempel 11.3. Example <code
                      class="filename">/etc/postfix/virtual</code> file</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# The alias below is generic and covers all addresses within 
# the falcotsbrand.com domain not otherwise covered by this file.
# These addresses forward email to the same user name in the
# falcot.com domain.
@falcotsbrand.com           @falcot.com
</pre></div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140275472000368"></a>11.1.2.2. Virtual Mailbox Domains</h4></div></div></div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>CAUTION</em></span> Combined virtual domain?</strong></p></div></div></div><div
                  class="para">
					Postfix does not allow using the same domain in both <code
                    class="literal">virtual_alias_domains</code> and <code
                    class="literal">virtual_mailbox_domains</code>. However, every domain of <code
                    class="literal">virtual_mailbox_domains</code> is implicitly included in <code
                    class="literal">virtual_alias_domains</code>, which makes it possible to mix aliases and mailboxes within a virtual domain.
				</div></div><a
                id="idm140275471995968"
                class="indexterm"></a><a
                id="idm140275471995008"
                class="indexterm"></a><div
                class="para">
					Messages addressed to a virtual mailbox domain are stored in mailboxes not assigned to a local system user.
				</div><div
                class="para">
					Enabling a virtual mailbox domain requires naming this domain in the <code
                  class="literal">virtual_mailbox_domains</code> variable, and referencing a mailbox mapping file in <code
                  class="literal">virtual_mailbox_maps</code>. The <code
                  class="literal">virtual_mailbox_base</code> parameter contains the directory under which the mailboxes will be stored.
				</div><div
                class="para">
					The <code
                  class="literal">virtual_uid_maps</code> parameter (respectively <code
                  class="literal">virtual_gid_maps</code>) references the file containing the mapping between the email address and the system user (respectively group) that “owns” the corresponding mailbox. To get all mailboxes owned by the same owner/group, the <code
                  class="literal">static:5000</code> syntax assigns a fixed UID/GID (of value 5000 here).
				</div><div
                class="example"><a
                  id="idm140275470290176"></a><p
                  class="title"><strong>Eksempel 11.4. Directives to add in the <code
                      class="filename">/etc/postfix/main.cf</code> file</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts
</pre></div></div><div
                class="para">
					Again, the syntax of the <code
                  class="filename">/etc/postfix/vmailbox</code> file is quite straightforward: two fields separated with whitespace. The first field is an email address within one of the virtual domains, and the second field is the location of the associated mailbox (relative to the directory specified in <span
                  class="emphasis"><em>virtual_mailbox_base</em></span>). If the mailbox name ends with a slash (<code
                  class="literal">/</code>), the emails will be stored in the <span
                  class="emphasis"><em>maildir</em></span> format; otherwise, the traditional <span
                  class="emphasis"><em>mbox</em></span> format will be used. The <span
                  class="emphasis"><em>maildir</em></span> format uses a whole directory to store a mailbox, each individual message being stored in a separate file. In the <span
                  class="emphasis"><em>mbox</em></span> format, on the other hand, the whole mailbox is stored in one file, and each line starting with “<code
                  class="literal">From </code>” (<code
                  class="literal">From</code> followed by a space) signals the start of a new message.
				</div><div
                class="example"><a
                  id="idm140275470283200"></a><p
                  class="title"><strong>Eksempel 11.5. The <code
                      class="filename">/etc/postfix/vmailbox</code> file</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
# Jean's email is stored as maildir, with
# one file per email in a dedicated directory
jean@falcot.org falcot.org/jean/
# Sophie's email is stored in a traditional "mbox" file,
# with all mails concatenated into one single file
sophie@falcot.org falcot.org/sophie
</pre></div></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140275470280704"></a>11.1.3. Restrictions for Receiving and Sending</h3></div></div></div><div
              class="para">
				The growing number of unsolicited bulk emails (<span
                class="emphasis"><em>spam</em></span>) requires being increasingly strict when deciding which emails a server should accept. This section presents some of the strategies included in Postfix.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CULTURE</em></span> The spam problem</strong></p></div></div></div><a
                id="idm140275470277744"
                class="indexterm"></a><div
                class="para">
				“Spam” is a generic term used to designate all the unsolicited commercial emails (also known as UCEs) that flood our electronic mailboxes; the unscrupulous individuals sending them are known as spammers. They care little about the nuisance they cause, since sending an email costs very little, and only a very small percentage of recipients need to be attracted by the offers for the spamming operation to make more money than it costs. The process is mostly automated, and any email address made public (for instance, on a web forum, or on the archives of a mailing list, or on a blog, and so on) will be discovered by the spammers' robots, and subjected to a never-ending stream of unsolicited messages.
			</div><div
                class="para">
				All system administrators try to face this nuisance with spam filters, but of course spammers keep adjusting to try to work around these filters. Some even rent networks of machines compromised by a worm from various crime syndicates. Recent statistics estimate that up to 95% of all emails circulating on the Internet are spam!
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140275470274640"></a>11.1.3.1. IP-Based Access Restrictions</h4></div></div></div><div
                class="para">
					The <code
                  class="literal">smtpd_client_restrictions</code> directive controls which machines are allowed to communicate with the email server.
				</div><div
                class="example"><a
                  id="idm140275470272976"></a><p
                  class="title"><strong>Eksempel 11.6. Restrictions Based on Client Address</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org
</pre></div></div><div
                class="para">
					When a variable contains a list of rules, as in the example above, these rules are evaluated in order, from the first to the last. Each rule can accept the message, reject it, or leave the decision to a following rule. As a consequence, order matters, and simply switching two rules can lead to a widely different behavior.
				</div><div
                class="para">
					The <code
                  class="literal">permit_mynetworks</code> directive, used as the first rule, accepts all emails coming from a machine in the local network (as defined by the <span
                  class="emphasis"><em>mynetworks</em></span> configuration variable).
				</div><div
                class="para">
					The second directive would normally reject emails coming from machines without a completely valid DNS configuration. Such a valid configuration means that the IP address can be resolved to a name, and that this name, in turn, resolves to the IP address. This restriction is often too strict, since many email servers do not have a reverse DNS for their IP address. This explains why the Falcot administrators prepended the <code
                  class="literal">warn_if_reject</code> modifier to the <code
                  class="literal">reject_unknown_client</code> directive: this modifier turns the rejection into a simple warning recorded in the logs. The administrators can then keep an eye on the number of messages that would be rejected if the rule were actually enforced, and make an informed decision later if they wish to enable such enforcement.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>TIP</em></span> <span
                            class="emphasis"><em>access</em></span> tables</strong></p></div></div></div><div
                  class="para">
					The restriction criteria include administrator-modifiable tables listing combinations of senders, IP addresses, and allowed or forbidden hostnames. These tables can be created from an uncompressed copy of the <code
                    class="filename">/usr/share/doc/postfix-doc/examples/access.gz</code> file. This model is self-documented in its comments, which means each table describes its own syntax.
				</div><div
                  class="para">
					The <code
                    class="filename">/etc/postfix/access_clientip</code> table lists IP addresses and networks; <code
                    class="filename">/etc/postfix/access_helo</code> lists domain names; <code
                    class="filename">/etc/postfix/access_sender</code> contains sender email addresses. All these files need to be turned into hash-tables (a format optimized for fast access) after each change, with the <code
                    class="command">postmap /etc/postfix/<em
                      class="replaceable">file</em></code> command.
				</div></div><div
                class="para">
					The third directive allows the administrator to set up a black list and a white list of email servers, stored in the <code
                  class="filename">/etc/postfix/access_clientip</code> file. Servers in the white list are considered as trusted, and the emails coming from there therefore do not go through the following filtering rules.
				</div><div
                class="para">
					The last two rules reject any message coming from a server listed in one of the indicated black lists. RBL is an acronym for <span
                  class="emphasis"><em>Remote Black List</em></span>; there are several such lists, but they all list badly configured servers that spammers use to relay their emails, as well as unexpected mail relays such as machines infected with worms or viruses.
				</div><a
                id="idm140275470258768"
                class="indexterm"></a><a
                id="idm140275470257808"
                class="indexterm"></a><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>TIP</em></span> White list and RBLs</strong></p></div></div></div><div
                  class="para">
					Black lists sometimes include a legitimate server that has been suffering an incident. In these situations, all emails coming from one of these servers would be rejected unless the server is listed in a whitelist defined by <code
                    class="filename">/etc/postfix/access_clientip</code>.
				</div><div
                  class="para">
					Prudence therefore recommends including in the white list all the trusted servers from which many emails are usually received.
				</div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140275470253664"></a>11.1.3.2. Checking the Validity of the <code
                        class="literal">EHLO</code> or <code
                        class="literal">HELO</code> Commands</h4></div></div></div><div
                class="para">
					Each SMTP exchange starts with a <code
                  class="literal">HELO</code> (or <code
                  class="literal">EHLO</code>) command, followed by the name of the sending email server; checking the validity of this name can be interesting.
				</div><a
                id="idm140275470250416"
                class="indexterm"></a><a
                id="idm140275470249296"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140275470248176"></a><p
                  class="title"><strong>Eksempel 11.7. Restrictions on the name announced in <code
                      class="literal">EHLO</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname
</pre></div></div><div
                class="para">
					The first <code
                  class="literal">permit_mynetworks</code> directive allows all machines on the local network to introduce themselves freely. This is important, because some email programs do not respect this part of the SMTP protocol adequately enough, and they can introduce themselves with nonsensical names.
				</div><div
                class="para">
					The <code
                  class="literal">reject_invalid_hostname</code> rule rejects emails when the <code
                  class="literal">EHLO</code> announce lists a syntactically incorrect hostname. The <code
                  class="literal">reject_non_fqdn_hostname</code> rule rejects messages when the announced hostname is not a fully-qualified domain name (including a domain name as well as a host name). The <code
                  class="literal">reject_unknown_hostname</code> rule rejects messages if the announced name does not exist in the DNS. Since this last rule unfortunately leads to too many rejections, the administrators turned its effect to a simple warning with the <code
                  class="literal">warn_if_reject</code> modifier as a first step; they may decide to remove this modifier at a later stage, after auditing the results of this rule.
				</div><div
                class="para">
					Using <code
                  class="literal">permit_mynetworks</code> as the first rule has an interesting side effect: the following rules only apply to hosts outside the local network. This allows blacklisting all hosts that announce themselves as part of the <code
                  class="literal">falcot.com</code>, for instance by adding a <code
                  class="literal">falcot.com REJECT You're not in our network!</code> line to the <code
                  class="filename">/etc/postfix/access_helo</code> file.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140275470239120"></a>11.1.3.3. Accepting or Refusing Based on the Announced Sender</h4></div></div></div><div
                class="para">
					Every message has a sender, announced by the <code
                  class="literal">MAIL FROM</code> command of the SMTP protocol; again, this information can be validated in several different ways.
				</div><a
                id="idm140275470237456"
                class="indexterm"></a><a
                id="idm140275470236336"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140275470234896"></a><p
                  class="title"><strong>Eksempel 11.8. Sender checks</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender
</pre></div></div><div
                class="para">
					The <code
                  class="filename">/etc/postfix/access_sender</code> table maps some special treatment to some senders. This usually means listing some senders into a white list or a black list.
				</div><div
                class="para">
					The <code
                  class="literal">reject_unknown_sender_domain</code> rule requires a valid sender domain, since it is needed for a valid address. The <code
                  class="literal">reject_unlisted_sender</code> rule rejects local senders if the address does not exist; this prevents emails from being sent from an invalid address in the <code
                  class="literal">falcot.com</code> domain, and messages emanating from <code
                  class="literal">joe.bloggs@falcot.com</code> are only accepted if such an address really exists.
				</div><div
                class="para">
					Finally, the <code
                  class="literal">reject_non_fqdn_sender</code> rule rejects emails purporting to come from addresses without a fully-qualified domain name. In practice, this means rejecting emails coming from <code
                  class="literal">user@machine</code>: the address must be announced as either <code
                  class="literal">user@machine.example.com</code> or <code
                  class="literal">user@example.com</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140275470536912"></a>11.1.3.4. Accepting or Refusing Based on the Recipient</h4></div></div></div><div
                class="para">
					Each email has at least one recipient, announced with the <code
                  class="literal">RCPT TO</code> command in the SMTP protocol. These addresses also warrant validation, even if that may be less relevant than the checks made on the sender address.
				</div><a
                id="idm140275470534992"
                class="indexterm"></a><a
                id="idm140275470534032"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140275470532624"></a><p
                  class="title"><strong>Eksempel 11.9. Recipient checks</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient
</pre></div></div><div
                class="para">
					<code
                  class="literal">reject_unauth_destination</code> is the basic rule that requires outside messages to be addressed to us; messages sent to an address not served by this server are rejected. Without this rule, a server becomes an open relay that allows spammers to send unsolicited emails; this rule is therefore mandatory, and it will be best included near the beginning of the list, so that no other rules may authorize the message before its destination has been checked.
				</div><div
                class="para">
					The <code
                  class="literal">reject_unlisted_recipient</code> rule rejects messages sent to non-existing local users, which makes sense. Finally, the <code
                  class="literal">reject_non_fqdn_recipient</code> rule rejects non-fully-qualified addresses; this makes it impossible to send an email to <code
                  class="literal">jean</code> or <code
                  class="literal">jean@machine</code>, and requires using the full address instead, such as <code
                  class="literal">jean@machine.falcot.com</code> or <code
                  class="literal">jean@falcot.com</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140275470526352"></a>11.1.3.5. Restrictions Associated with the <code
                        class="literal">DATA</code> Command</h4></div></div></div><div
                class="para">
					The <code
                  class="literal">DATA</code> command of SMTP is emitted before the contents of the message. It doesn't provide any information per se, apart from announcing what comes next. It can still be subjected to checks.
				</div><a
                id="idm140275470523968"
                class="indexterm"></a><div
                class="example"><a
                  id="idm140275470522848"></a><p
                  class="title"><strong>Eksempel 11.10. <code
                      class="literal">DATA</code> checks</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_data_restrictions = reject_unauth_pipelining
</pre></div></div><div
                class="para">
					The <code
                  class="literal">reject_unauth_pipelining</code> directives causes the message to be rejected if the sending party sends a command before the reply to the previous command has been sent. This guards against a common optimization used by spammer robots, since they usually don't care a fig about replies and only focus on sending as many emails as possible in as short a time as possible.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140275470519696"></a>11.1.3.6. Applying Restrictions</h4></div></div></div><div
                class="para">
					Although the above commands validate information at various stages of the SMTP exchange, Postfix only sends the actual rejection as a reply to the <code
                  class="literal">RCPT TO</code> command.
				</div><div
                class="para">
					This means that even if the message is rejected due to an invalid <code
                  class="literal">EHLO</code> command, Postfix knows the sender and the recipient when announcing the rejection. It can then log a more explicit message than it could if the transaction had been interrupted from the start. In addition, a number of SMTP clients do not expect failures on the early SMTP commands, and these clients will be less disturbed by this late rejection.
				</div><div
                class="para">
					A final advantage to this choice is that the rules can accumulate information during the various stages of the SMTP exchange; this allows defining more fine-grained permissions, such as rejecting a non-local connection if it announces itself with a local sender.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm140275470515632"></a>11.1.3.7. Filtering Based on the Message Contents</h4></div></div></div><div
                class="para">
					The validation and restriction system would not be complete without a way to apply checks to the message contents. Postfix differentiates the checks applying to the email headers from those applying to the email body.
				</div><div
                class="example"><a
                  id="idm140275470514176"></a><p
                  class="title"><strong>Eksempel 11.11. Enabling content-based filters</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks
</pre></div></div><a
                id="idm140275470512800"
                class="indexterm"></a><div
                class="para">
					Both files contain a list of regular expressions (commonly known as <span
                  class="emphasis"><em>regexps</em></span> or <span
                  class="emphasis"><em>regexes</em></span>) and associated actions to be triggered when the email headers (or body) match the expression.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>QUICK LOOK</em></span> Regexp tables</strong></p></div></div></div><div
                  class="para">
					The <code
                    class="filename">/usr/share/doc/postfix-doc/examples/header_checks.gz</code> file contains many explanatory comments and can be used as a starting point for creating the <code
                    class="filename">/etc/postfix/header_checks</code> and <code
                    class="filename">/etc/postfix/body_checks</code> files.
				</div></div><div
                class="example"><a
                  id="idm140275470506912"></a><p
                  class="title"><strong>Eksempel 11.12. Example <code
                      class="filename">/etc/postfix/header_checks</code> file</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification
</pre></div></div><div
                class="sidebar"><a
                  id="sidebar.regexp"></a><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>BACK TO BASICS</em></span> Regular expression</strong></p></div></div></div><div
                  class="para">
					The <span
                    class="emphasis"><em>regular expression</em></span> term (shortened to <span
                    class="emphasis"><em>regexp</em></span> or <span
                    class="emphasis"><em>regex</em></span>) references a generic notation for expressing a description of the contents and/or structure of a string of characters. Certain special characters allow defining alternatives (for instance, <code
                    class="literal">foo|bar</code> matches either “foo” or “bar”), sets of allowed characters (for instance, <code
                    class="literal">[0-9]</code> means any digit, and <code
                    class="literal">.</code> — a dot — means any character), quantifications (<code
                    class="literal">s?</code> matches either <code
                    class="literal">s</code> or the empty string, in other words 0 or 1 occurrence of <code
                    class="literal">s</code>; <code
                    class="literal">s+</code> matches one or more consecutive <code
                    class="literal">s</code> characters; and so on). Parentheses allow grouping search results.
				</div><div
                  class="para">
					The precise syntax of these expressions varies across the tools using them, but the basic features are similar. <div
                    class="url">→ <a
                      href="http://en.wikipedia.org/wiki/Regular_expression">http://en.wikipedia.org/wiki/Regular_expression</a></div>
				</div></div><div
                class="para">
					The first one checks the header mentioning the email software; if <code
                  class="literal">GOTO Sarbacane</code> (a bulk email software) is found, the message is rejected. The second expression controls the message subject; if it mentions a virus notification, we can decide not to reject the message but to discard it immediately instead.
				</div><div
                class="para">
					Using these filters is a double-edged sword, because it is easy to make the rules too generic and to lose legitimate emails as a consequence. In these cases, not only the messages will be lost, but their senders will get unwanted (and annoying) error messages.
				</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140275470494064"></a>11.1.4. Setting Up <span
                      class="foreignphrase"><em
                        class="foreignphrase">greylisting</em></span></h3></div></div></div><a
              id="idm140275470492944"
              class="indexterm"></a><div
              class="para">
				“Greylisting” is a filtering technique according to which a message is initially rejected with a temporary error code, and only accepted on a further try after some delay. This filtering is particularly efficient against spam sent by the many machines infected by worms and viruses, since this software rarely acts as a full SMTP agent (by checking the error code and retrying failed messages later), especially since many of the harvested addresses are really invalid and retrying would only mean losing time.
			</div><div
              class="para">
				Postfix doesn't provide greylisting natively, but there is a feature by which the decision to accept or reject a given message can be delegated to an external program. The <span
                class="pkg pkg">postgrey</span> package contains just such a program, designed to interface with this access policy delegation service.
			</div><div
              class="para">
				Once <span
                class="pkg pkg">postgrey</span> is installed, it runs as a daemon and listens on port 10023. Postfix can then be configured to use it, by adding the <code
                class="literal">check_policy_service</code> parameter as an extra restriction:
			</div><pre
              class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023
</pre><div
              class="para">
				Each time Postfix reaches this rule in the ruleset, it will connect to the <code
                class="command">postgrey</code> daemon and send it information concerning the relevant message. On its side, Postgrey considers the IP address/sender/recipient triplet and checks in its database whether that same triplet has been seen recently. If so, Postgrey replies that the message should be accepted; if not, the reply indicates that the message should be temporarily rejected, and the triplet gets recorded in the database.
			</div><div
              class="para">
				The main disadvantage of greylisting is that legitimate messages get delayed, which is not always acceptable. It also increases the burden on servers that send many legitimate emails.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>IN PRACTICE</em></span> Shortcomings of greylisting</strong></p></div></div></div><div
                class="para">
				Theoretically, greylisting should only delay the first mail from a given sender to a given recipient, and the typical delay is in the order of minutes. Reality, however, can differ slightly. Some large ISPs use clusters of SMTP servers, and when a message is initially rejected, the server that retries the transmission may not be the same as the initial one. When that happens, the second server gets a temporary error message due to greylisting too, and so on; it may take several hours until transmission is attempted by a server that has already been involved, since SMTP servers usually increase the delay between retries at each failure.
			</div><div
                class="para">
				As a consequence, the incoming IP address may vary in time even for a single sender. But it goes further: even the sender address can change. For instance, many mailing-list servers encode extra information in the sender address so as to be able to handle error messages (known as <span
                  class="emphasis"><em>bounces</em></span>). Each new message sent to a mailing-list may then need to go through greylisting, which means it has to be stored (temporarily) on the sender's server. For very large mailing-lists (with tens of thousands of subscribers), this can soon become a problem.
			</div><div
                class="para">
				To mitigate these drawbacks, Postgrey manages a whitelist of such sites, and messages emanating from them are immediately accepted without going through greylisting. This list can easily be adapted to local needs, since it's stored in the <code
                  class="filename">/etc/postgrey/whitelist_clients</code> file.
			</div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>GOING FURTHER</em></span> Selective greylisting with <span
                          class="pkg pkg">milter-greylist</span></strong></p></div></div></div><div
                class="para">
				The drawbacks of greylisting can be mitigated by only using greylisting on the subset of clients that are already considered as probable sources of spam (because they are listed in a DNS black-list). This is not possible with <span
                  class="pkg pkg">postgrey</span> but <span
                  class="pkg pkg">milter-greylist</span> can be used in such a way.
			</div><div
                class="para">
				In that scenario, since DNS black-lists never triggers a definitive rejection, it becomes reasonable to use aggressive black-lists, including those listing all dynamic IP addresses from ISP clients (such as <code
                  class="literal">pbl.spamhaus.org</code> or <code
                  class="literal">dul.dnsbl.sorbs.net</code>).
			</div><div
                class="para">
				Since milter-greylist uses Sendmail's milter interface, the postfix side of its configuration is limited to “<code
                  class="literal">smtpd_milters = unix:/var/milter-greylist/milter-greylist.sock</code>”. The <span
                  class="citerefentry"><span
                    class="refentrytitle">greylist.conf</span>(5)</span> manual page documents <code
                  class="filename">/etc/milter-greylist/greylist.conf</code> and the numerous ways to configure milter-greylist.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140275470472080"></a>11.1.5. Customizing Filters Based On the Recipient</h3></div></div></div><div
              class="para">
				The last two sections reviewed many of the possible restrictions. They all have their use in limiting the amount of received spam, but they also all have their drawbacks. It is therefore more and more common to customize the set of filters depending on the recipient. At Falcot Corp, greylisting is interesting for most users, but it hinders the work of some users who need low latency in their emails (such as the technical support service). Similarly, the commercial service sometimes has problems receiving emails from some Asian providers who may be listed in black-lists; this service asked for a non-filtered address so as to be able to correspond.
			</div><div
              class="para">
				Postfix provides such a customization of filters with a “restriction class” concept. The classes are declared in the <code
                class="literal">smtpd_restriction_classes</code> parameter, and defined the same way as <code
                class="literal">smtpd_recipient_restrictions</code>. The <code
                class="literal">check_recipient_access</code> directive then defines a table mapping a given recipient to the appropriate set of restrictions.
			</div><div
              class="example"><a
                id="idm140275470468288"></a><p
                class="title"><strong>Eksempel 11.13. Defining restriction classes in <code
                    class="filename">main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access
</pre></div></div><div
              class="example"><a
                id="idm140275470466176"></a><p
                class="title"><strong>Eksempel 11.14. The <code
                    class="filename">/etc/postfix/recipient_access</code> file</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting
</pre></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="sect.postfix-antivirus"></a>11.1.6. Integrating an Antivirus</h3></div></div></div><a
              id="idm140275470462752"
              class="indexterm"></a><div
              class="para">
				The many viruses circulating as attachments to emails make it important to set up an antivirus at the entry point of the company network, since despite an awareness campaign, some users will still open attachments from obviously shady messages.
			</div><div
              class="para">
				The Falcot administrators selected <code
                class="command">clamav</code> for their free antivirus. The main package is <span
                class="pkg pkg">clamav</span>, but they also installed a few extra packages such as <span
                class="pkg pkg">arj</span>, <span
                class="pkg pkg">unzoo</span>, <span
                class="pkg pkg">unrar</span> and <span
                class="pkg pkg">lha</span>, since they are required for the antivirus to analyze attachments archived in one of these formats.
			</div><a
              id="idm140275470456752"
              class="indexterm"></a><a
              id="idm140275470455632"
              class="indexterm"></a><div
              class="para">
				The task of interfacing between antivirus and the email server goes to <code
                class="command">clamav-milter</code>. A <span
                class="emphasis"><em>milter</em></span> (short for <span
                class="emphasis"><em>mail filter</em></span>) is a filtering program specially designed to interface with email servers. A milter uses a standard application programming interface (API) that provides much better performance than filters external to the email servers. Milters were initially introduced by <span
                class="emphasis"><em>Sendmail</em></span>, but <span
                class="emphasis"><em>Postfix</em></span> soon followed suit.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>QUICK LOOK</em></span> A milter for Spamassassin</strong></p></div></div></div><a
                id="idm140275470450368"
                class="indexterm"></a><div
                class="para">
				The <span
                  class="pkg pkg">spamass-milter</span> package provides a milter based on <span
                  class="emphasis"><em>SpamAssassin</em></span>, the famous unsolicited email detector. It can be used to flag messages as probable spams (by adding an extra header) and/or to reject the messages altogether if their “spamminess” score goes beyond a given threshold.
			</div></div><div
              class="para">
				Once the <span
                class="pkg pkg">clamav-milter</span> package is installed, the milter should be reconfigured to run on a TCP port rather than on the default named socket. This can be achieved with <code
                class="command">dpkg-reconfigure clamav-milter</code>. When prompted for the “Communication interface with Sendmail”, answer “<code
                class="literal">inet:10002@127.0.0.1</code>”.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NOTE</em></span> Real TCP port vs named socket</strong></p></div></div></div><div
                class="para">
				The reason why we use a real TCP port rather than the named socket is that the postfix daemons often run chrooted and do not have access to the directory hosting the named socket. You could also decide to keep using a named socket and pick a location within the chroot (<code
                  class="filename">/var/spool/postfix/</code>).
			</div></div><div
              class="para">
				The standard ClamAV configuration fits most situations, but some important parameters can still be customized with <code
                class="command">dpkg-reconfigure clamav-base</code>.
			</div><div
              class="para">
				The last step involves telling Postfix to use the recently-configured filter. This is a simple matter of adding the following directive to <code
                class="filename">/etc/postfix/main.cf</code>:
			</div><pre
              class="programlisting">
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002
</pre><div
              class="para">
				If the antivirus causes problems, this line can be commented out, and <code
                class="command">/etc/init.d/postfix reload</code> should be run so that this change is taken into account.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>IN PRACTICE</em></span> Testing the antivirus</strong></p></div></div></div><div
                class="para">
				Once the antivirus is set up, its correct behavior should be tested. The simplest way to do that is to send a test email with an attachment containing the <code
                  class="filename">eicar.com</code> (or <code
                  class="filename">eicar.com.zip</code>) file, which can be downloaded online: <div
                  class="url">→ <a
                    href="http://www.eicar.org/anti_virus_test_file.htm">http://www.eicar.org/anti_virus_test_file.htm</a></div>
			</div><div
                class="para">
				This file is not a true virus, but a test file that all antivirus software on the market diagnose as a virus to allow checking installations.
			</div></div><div
              class="para">
				All messages handled by Postfix now go through the antivirus filter.
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm140275470434208"></a>11.1.7. Authenticated SMTP</h3></div></div></div><div
              class="para">
				Being able to send emails requires an SMTP server to be reachable; it also requires said SMTP server to send emails through it. For roaming users, this may need regularly changing the configuration of the SMTP client, since Falcot's SMTP server rejects messages coming from IP addresses apparently not belonging to the company. Two solutions exist: either the roaming user installs an SMTP server on their computer, or they still use the company server with some means of authenticating as an employee. The former solution is not recommended since the computer won't be permanently connected, and it won't be able to retry sending messages in case of problems; we will focus on the latter solution.
			</div><div
              class="para">
				SMTP authentication in Postfix relies on SASL (<span
                class="emphasis"><em>Simple Authentication and Security Layer</em></span>). It requires installing the <span
                class="pkg pkg">libsasl2-modules</span> and <span
                class="pkg pkg">sasl2-bin</span> packages, then registering a password in the SASL database for each user that needs authenticating on the SMTP server. This is done with the <code
                class="command">saslpasswd2</code> command, which takes several parameters. The <code
                class="literal">-u</code> option defines the authentication domain, which must match the <code
                class="literal">smtpd_sasl_local_domain</code> parameter in the Postfix configuration. The <code
                class="literal">-c</code> option allows creating a user, and <code
                class="literal">-f</code> allows specifying the file to use if the SASL database needs to be stored at a different location than the default (<code
                class="filename">/etc/sasldb2</code>).
			</div><pre
              class="screen scale">
<code
                class="computeroutput"># </code><strong
                class="userinput"><code>saslpasswd2 -u `postconf -h myhostname` -f /var/spool/postfix/etc/sasldb2 -c jean</code></strong>
<code
                class="computeroutput">[... type jean's password twice ...]</code></pre><div
              class="para">
				Note that the SASL database was created in Postfix's directory. In order to ensure consistency, we also turn <code
                class="filename">/etc/sasldb2</code> into a symbolic link pointing at the database used by Postfix, with the <code
                class="command">ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</code> command.
			</div><div
              class="para">
				Now we need to configure Postfix to use SASL. First the <code
                class="literal">postfix</code> user needs to be added to the <code
                class="literal">sasl</code> group, so that it can access the SASL account database. A few new parameters are also needed to enable SASL, and the <code
                class="literal">smtpd_recipient_restrictions</code> parameter needs to be configured to allow SASL-authenticated clients to send emails freely.
			</div><div
              class="example"><a
                id="idm140275470421808"></a><p
                class="title"><strong>Eksempel 11.15. Enabling SASL in <code
                    class="filename">/etc/postfix/main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> Authenticated SMTP client</strong></p></div></div></div><div
                class="para">
				Most email clients are able to authenticate to an SMTP server before sending outgoing messages, and using that feature is a simple matter of configuring the appropriate parameters. If the client in use does not provide that feature, the workaround is to use a local Postfix server and configure it to relay email via the remote SMTP server. In this case, the local Postfix itself will be the client that authenticates with SASL. Here are the required parameters:
			</div><pre
                class="programlisting">
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]
</pre><div
                class="para">
				The <code
                  class="filename">/etc/postfix/sasl_passwd</code> file needs to contain the username and password to use for authenticating on the <code
                  class="literal">mail.falcot.com</code> server. Here's an example:
			</div><pre
                class="programlisting">
[mail.falcot.com]   joe:LyinIsji
</pre><div
                class="para">
				As for all Postfix maps, this file must be turned into <code
                  class="filename">/etc/postfix/sasl_passwd.db</code> with the <code
                  class="command">postmap</code> command.
			</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>forrige</strong>10.8. Network Diagnosis Tools</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>op</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>hjem</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>næste</strong>11.2. Web Server (HTTP)</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/network-services.html">ar-MA</a></li><li><a
              href="../da-DK/network-services.html">da-DK</a></li><li><a
              href="../de-DE/network-services.html">de-DE</a></li><li><a
              href="../el-GR/network-services.html">el-GR</a></li><li><a
              href="../en-US/network-services.html">en-US</a></li><li><a
              href="../es-ES/network-services.html">es-ES</a></li><li><a
              href="../fa-IR/network-services.html">fa-IR</a></li><li><a
              href="../fr-FR/network-services.html">fr-FR</a></li><li><a
              href="../hr-HR/network-services.html">hr-HR</a></li><li><a
              href="../id-ID/network-services.html">id-ID</a></li><li><a
              href="../it-IT/network-services.html">it-IT</a></li><li><a
              href="../ja-JP/network-services.html">ja-JP</a></li><li><a
              href="../pl-PL/network-services.html">pl-PL</a></li><li><a
              href="../pt-BR/network-services.html">pt-BR</a></li><li><a
              href="../ro-RO/network-services.html">ro-RO</a></li><li><a
              href="../ru-RU/network-services.html">ru-RU</a></li><li><a
              href="../tr-TR/network-services.html">tr-TR</a></li><li><a
              href="../zh-CN/network-services.html">zh-CN</a></li></ul></div></body></html>
